<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–¥–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .navigation {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: white;
        }

        .content {
            padding: 40px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        .chart-container.large {
            height: 450px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –≥–∞–ª–æ—á–∫–∞–º–∏ */
        .timeline-card {
            width: 100%;
        }

        .timeline-content {
            display: flex;
            gap: 20px;
        }

        .timeline-left {
            min-width: 250px;
            max-width: 250px;
            display: flex;
            flex-direction: column;
        }

        .timeline-chart {
            flex: 1;
            position: relative;
            height: 400px;
        }

        .subsubcategory-list {
            flex: 1;
            max-height: 350px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .subsubcategory-list::-webkit-scrollbar {
            width: 6px;
        }

        .subsubcategory-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .subsubcategory-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .subsubcat-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 13px;
        }

        .subsubcat-item:hover {
            background: #f8f9fa;
        }

        .subsubcat-item.custom {
            background: #fff3cd;
        }

        .subsubcat-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .subsubcat-item label {
            flex: 1;
            cursor: pointer;
            user-select: none;
        }

        .subsubcat-item .custom-icon {
            margin-left: 4px;
            font-size: 12px;
        }

        .subsubcat-item .remove-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 16px;
            padding: 0 4px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .subsubcat-item .remove-btn:hover {
            opacity: 1;
        }

        .add-custom-btn {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .add-custom-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .add-custom-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #000;
        }

        .modal-content h4 {
            margin: 0 0 20px 0;
            color: #333;
        }

        #customSearchInput {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        #customSearchInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f1f1f1;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item.disabled {
            color: #999;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            color: #6c757d;
            font-size: 1.2em;
        }

        .loading:after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .color-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .color-swatch {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 3px solid white;
        }

        .color-label {
            font-size: 0.9em;
            color: #6c757d;
            text-align: center;
        }

        .color-count {
            font-weight: bold;
            color: #333;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–æ–≤ */
        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            color: #6c757d;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .tab-btn:hover {
            color: #667eea;
            border-color: #667eea;
            background: #f8f9ff;
        }

        .tab-btn.active {
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105429501', 'ym');

        ym(105429501, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/105429501" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –ú–æ–¥–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã</h1>
            <p>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–æ–¥–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö Instagram</p>

            <div class="navigation">
                <a href="/" class="nav-btn">üîç –ü–∞—Ä—Å–µ—Ä</a>
                <a href="/gallery" class="nav-btn">üì∑ –ì–∞–ª–µ—Ä–µ—è</a>
                <a href="/gallery_to_tag" class="nav-btn">üè∑Ô∏è –í—ã–±—Ä–∞–Ω–æ –¥–ª—è —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è</a>
                <a href="/gallery_tagged" class="nav-btn">‚úÖ –û—Ç—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω—ã</a>
                <a href="/gallery_hidden" class="nav-btn">üôà –°–∫—Ä—ã—Ç—ã–µ</a>
                <a href="/analytics/trends" class="nav-btn active">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
            </div>
        </div>

        <div class="content">
            <!-- –û–±–∑–æ—Ä–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats-overview" id="statsOverview">
                <div class="stat-card">
                    <div class="stat-value" id="totalImages">-</div>
                    <div class="stat-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCategories">-</div>
                    <div class="stat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalColors">-</div>
                    <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalMaterials">-</div>
                    <div class="stat-label">–¢–∏–ø–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</div>
                </div>
            </div>

            <!-- –î–∞—à–±–æ—Ä–¥—ã -->
            <div class="dashboard-grid">
                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                <div class="chart-card">
                    <h3>üëó –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                    <div class="chart-container">
                        <canvas id="categoriesChart"></canvas>
                    </div>
                </div>

                <!-- –¢–æ–ø-10 –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                <div class="chart-card">
                    <h3>üî• –¢–æ–ø-10 –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π</h3>
                    <div class="chart-container">
                        <canvas id="subcategoriesChart"></canvas>
                    </div>
                </div>

                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ü–≤–µ—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
                <div class="chart-card">
                    <h3>üé® –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ü–≤–µ—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                    <div class="tabs-container">
                        <div class="tabs">
                            <button class="tab-btn active" onclick="switchTab('colors', 'Clothing')">üëó –û–¥–µ–∂–¥–∞</button>
                            <button class="tab-btn" onclick="switchTab('colors', 'Footwear')">üëü –û–±—É–≤—å</button>
                            <button class="tab-btn" onclick="switchTab('colors', 'Accessories')">üëú –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
                        </div>
                        <div id="colors-Clothing" class="tab-content active">
                            <div class="chart-container">
                                <canvas id="colorsChartClothing"></canvas>
                            </div>
                        </div>
                        <div id="colors-Footwear" class="tab-content">
                            <div class="chart-container">
                                <canvas id="colorsChartFootwear"></canvas>
                            </div>
                        </div>
                        <div id="colors-Accessories" class="tab-content">
                            <div class="chart-container">
                                <canvas id="colorsChartAccessories"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
                <div class="chart-card">
                    <h3>üßµ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                    <div class="tabs-container">
                        <div class="tabs">
                            <button class="tab-btn active" onclick="switchTab('materials', 'Clothing')">üëó –û–¥–µ–∂–¥–∞</button>
                            <button class="tab-btn" onclick="switchTab('materials', 'Footwear')">üëü –û–±—É–≤—å</button>
                            <button class="tab-btn" onclick="switchTab('materials', 'Accessories')">üëú –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
                        </div>
                        <div id="materials-Clothing" class="tab-content active">
                            <div class="chart-container">
                                <canvas id="materialsChartClothing"></canvas>
                            </div>
                        </div>
                        <div id="materials-Footwear" class="tab-content">
                            <div class="chart-container">
                                <canvas id="materialsChartFootwear"></canvas>
                            </div>
                        </div>
                        <div id="materials-Accessories" class="tab-content">
                            <div class="chart-container">
                                <canvas id="materialsChartAccessories"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
                <div class="chart-card">
                    <h3>‚ú® –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                    <div class="tabs-container">
                        <div class="tabs">
                            <button class="tab-btn active" onclick="switchTab('styles', 'Clothing')">üëó –û–¥–µ–∂–¥–∞</button>
                            <button class="tab-btn" onclick="switchTab('styles', 'Footwear')">üëü –û–±—É–≤—å</button>
                            <button class="tab-btn" onclick="switchTab('styles', 'Accessories')">üëú –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
                        </div>
                        <div id="styles-Clothing" class="tab-content active">
                            <div class="chart-container">
                                <canvas id="stylesChartClothing"></canvas>
                            </div>
                        </div>
                        <div id="styles-Footwear" class="tab-content">
                            <div class="chart-container">
                                <canvas id="stylesChartFootwear"></canvas>
                            </div>
                        </div>
                        <div id="styles-Accessories" class="tab-content">
                            <div class="chart-container">
                                <canvas id="stylesChartAccessories"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢—Ä–µ–Ω–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è Clothing -->
            <div class="chart-card timeline-card">
                <h3>üìà –¢—Ä–µ–Ω–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ - –û–¥–µ–∂–¥–∞ (Clothing)</h3>
                <div class="timeline-content">
                    <div class="timeline-left">
                        <div class="subsubcategory-list" id="clothingSubsubcategoryList">
                            <!-- –ì–∞–ª–æ—á–∫–∏ –¥–ª—è —Ç–æ–ø-20 –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        <button class="add-custom-btn" onclick="showAddCustomModal('Clothing')">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∏–ø
                        </button>
                    </div>
                    <div class="timeline-chart">
                        <canvas id="timelineChartClothing"></canvas>
                    </div>
                </div>
            </div>

            <!-- –¢—Ä–µ–Ω–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è Accessories -->
            <div class="chart-card timeline-card">
                <h3>üìà –¢—Ä–µ–Ω–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ - –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã (Accessories)</h3>
                <div class="timeline-content">
                    <div class="timeline-left">
                        <div class="subsubcategory-list" id="accessoriesSubsubcategoryList">
                            <!-- –ì–∞–ª–æ—á–∫–∏ –¥–ª—è —Ç–æ–ø-20 –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        <button class="add-custom-btn" onclick="showAddCustomModal('Accessories')">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∏–ø
                        </button>
                    </div>
                    <div class="timeline-chart">
                        <canvas id="timelineChartAccessories"></canvas>
                    </div>
                </div>
            </div>

            <!-- –¢—Ä–µ–Ω–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è Footwear -->
            <div class="chart-card timeline-card">
                <h3>üìà –¢—Ä–µ–Ω–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ - –û–±—É–≤—å (Footwear)</h3>
                <div class="timeline-content">
                    <div class="timeline-left">
                        <div class="subsubcategory-list" id="footwearSubsubcategoryList">
                            <!-- –ì–∞–ª–æ—á–∫–∏ –¥–ª—è —Ç–æ–ø-20 –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        <button class="add-custom-btn" onclick="showAddCustomModal('Footwear')">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∏–ø
                        </button>
                    </div>
                    <div class="timeline-chart">
                        <canvas id="timelineChartFootwear"></canvas>
                    </div>
                </div>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–¥—Ç–∏–ø–∞ -->
            <div id="addCustomModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeAddCustomModal()">&times;</span>
                    <h4>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∏–ø –¥–ª—è <span id="modalCategoryName"></span></h4>
                    <input type="text" id="customSearchInput" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ..." autocomplete="off">
                    <div id="customSearchResults" class="search-results"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        const chartColors = {
            primary: '#667eea',
            secondary: '#764ba2',
            success: '#28a745',
            danger: '#dc3545',
            warning: '#ffc107',
            info: '#17a2b8',
            palette: [
                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                '#a8edea', '#fed6e3', '#c471ed', '#12c2e9'
            ]
        };

        // –ú–∞–ø–ø–∏–Ω–≥ —Ü–≤–µ—Ç–æ–≤ –Ω–∞ CSS —Ü–≤–µ—Ç–∞
        const colorMapping = {
            'Black': '#000000',
            'White': '#FFFFFF',
            'Red': '#FF0000',
            'Blue': '#0000FF',
            'Green': '#00FF00',
            'Yellow': '#FFFF00',
            'Pink': '#FFC0CB',
            'Purple': '#800080',
            'Orange': '#FFA500',
            'Brown': '#8B4513',
            'Gray': '#808080',
            'Grey': '#808080',
            'Beige': '#F5F5DC',
            'Navy': '#000080',
            'Turquoise': '#40E0D0',
            'Gold': '#FFD700',
            'Silver': '#C0C0C0'
        };

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
        let analyticsData = {
            colorsByCategory: null,
            materialsByCategory: null,
            stylesByCategory: null
        };

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
        function switchTab(section, category) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ —ç—Ç–æ–π —Å–µ–∫—Ü–∏–∏
            const parentCard = document.querySelector(`#${section}-${category}`).closest('.chart-card');
            const tabs = parentCard.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.classList.remove('active'));

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
            event.target.classList.add('active');

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–∞–±—ã –≤ —ç—Ç–æ–π —Å–µ–∫—Ü–∏–∏
            const allTabs = parentCard.querySelectorAll('.tab-content');
            allTabs.forEach(tab => tab.classList.remove('active'));

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–±
            document.getElementById(`${section}-${category}`).classList.add('active');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const timelineData = {
            Clothing: null,
            Accessories: null,
            Footwear: null
        };

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–¥—Ç–∏–ø–æ–≤ (–º–∞–∫—Å 10 –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é)
        const customSubsubcategories = {
            Clothing: [],
            Accessories: [],
            Footwear: []
        };

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è Chart.js –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
        const timelineCharts = {
            Clothing: null,
            Accessories: null,
            Footwear: null
        };

        async function loadAnalytics() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–π subsubcategory-timeline)
                const [categories, subcategories, colorsByCategory, materialsByCategory, stylesByCategory, subsubcategoryTimeline] = await Promise.all([
                    fetch('/api/analytics/categories-stats').then(r => r.json()),
                    fetch('/api/analytics/subcategories-stats').then(r => r.json()),
                    fetch('/api/analytics/colors-by-category').then(r => r.json()),
                    fetch('/api/analytics/materials-by-category').then(r => r.json()),
                    fetch('/api/analytics/styles-by-category').then(r => r.json()),
                    fetch('/api/analytics/subsubcategory-timeline').then(r => r.json())
                ]);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ timeline
                if (subsubcategoryTimeline.success) {
                    timelineData.Clothing = subsubcategoryTimeline.data.Clothing;
                    timelineData.Accessories = subsubcategoryTimeline.data.Accessories;
                    timelineData.Footwear = subsubcategoryTimeline.data.Footwear;
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                analyticsData.colorsByCategory = colorsByCategory;
                analyticsData.materialsByCategory = materialsByCategory;
                analyticsData.stylesByCategory = stylesByCategory;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                if (categories.success) {
                    const totalImages = categories.categories.reduce((sum, c) => sum + c.count, 0);
                    document.getElementById('totalImages').textContent = totalImages.toLocaleString();
                    document.getElementById('totalCategories').textContent = categories.categories.length;
                }

                // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                if (colorsByCategory.success) {
                    const allColors = new Set();
                    Object.values(colorsByCategory.data).forEach(colors => {
                        colors.forEach(c => allColors.add(c.name));
                    });
                    document.getElementById('totalColors').textContent = allColors.size;
                }

                if (materialsByCategory.success) {
                    const allMaterials = new Set();
                    Object.values(materialsByCategory.data).forEach(materials => {
                        materials.forEach(m => allMaterials.add(m.name));
                    });
                    document.getElementById('totalMaterials').textContent = allMaterials.size;
                }

                // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                if (categories.success) drawCategoriesChart(categories.categories);
                if (subcategories.success) drawSubcategoriesChart(subcategories.subcategories);

                // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                if (colorsByCategory.success) {
                    drawColorsByCategoryChart('Clothing', colorsByCategory.data.Clothing);
                    drawColorsByCategoryChart('Footwear', colorsByCategory.data.Footwear);
                    drawColorsByCategoryChart('Accessories', colorsByCategory.data.Accessories);
                }

                if (materialsByCategory.success) {
                    drawMaterialsByCategoryChart('Clothing', materialsByCategory.data.Clothing);
                    drawMaterialsByCategoryChart('Footwear', materialsByCategory.data.Footwear);
                    drawMaterialsByCategoryChart('Accessories', materialsByCategory.data.Accessories);
                }

                if (stylesByCategory.success) {
                    drawStylesByCategoryChart('Clothing', stylesByCategory.data.Clothing);
                    drawStylesByCategoryChart('Footwear', stylesByCategory.data.Footwear);
                    drawStylesByCategoryChart('Accessories', stylesByCategory.data.Accessories);
                }

                // –†–∏—Å—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å –≥–∞–ª–æ—á–∫–∞–º–∏
                if (subsubcategoryTimeline.success) {
                    initializeTimelineCharts('Clothing');
                    initializeTimelineCharts('Accessories');
                    initializeTimelineCharts('Footwear');
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
                document.querySelector('.content').insertAdjacentHTML('afterbegin',
                    '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message + '</div>');
            }
        }

        // –ì—Ä–∞—Ñ–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)
        function drawCategoriesChart(data) {
            const ctx = document.getElementById('categoriesChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: chartColors.palette,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞)
        function drawSubcategoriesChart(data) {
            const ctx = document.getElementById('subcategoriesChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                        data: data.map(d => d.count),
                        backgroundColor: chartColors.palette[0],
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return data[context[0].dataIndex].name + ' (' + data[context[0].dataIndex].category + ')';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                display: true
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ —Ü–≤–µ—Ç–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Å —Ü–≤–µ—Ç–∞–º–∏)
        function drawColorsByCategoryChart(category, data) {
            const ctx = document.getElementById(`colorsChart${category}`).getContext('2d');

            // –°–æ–∑–¥–∞–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è –±–∞—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏–π
            const backgroundColors = data.map(d => {
                const colorName = d.name;
                return colorMapping[colorName] || chartColors.palette[0];
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                        data: data.map(d => d.count),
                        backgroundColor: backgroundColors,
                        borderColor: '#fff',
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                display: true
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)
        function drawMaterialsByCategoryChart(category, data) {
            const ctx = document.getElementById(`materialsChart${category}`).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: chartColors.palette,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∏–ª–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)
        function drawStylesByCategoryChart(category, data) {
            const ctx = document.getElementById(`stylesChart${category}`).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: chartColors.palette,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function initializeTimelineCharts(category) {
            const data = timelineData[category];
            if (!data) return;

            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ –≥–∞–ª–æ—á–µ–∫ —Å —Ç–æ–ø-20
            renderSubsubcategoryList(category, data.top20);

            // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
            drawTimelineChartForCategory(category);
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –≥–∞–ª–æ—á–∫–∞–º–∏
        function renderSubsubcategoryList(category, top20) {
            const listId = category.toLowerCase() + 'SubsubcategoryList';
            const listElement = document.getElementById(listId);
            if (!listElement) return;

            listElement.innerHTML = '';

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ø-20
            top20.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'subsubcat-item';
                div.innerHTML = `
                    <input type="checkbox" id="${category}_${index}"
                           data-category="${category}"
                           data-name="${item.name}"
                           checked
                           onchange="toggleSubsubcategoryLine('${category}', '${item.name}', this.checked)">
                    <label for="${category}_${index}">${item.name}</label>
                `;
                listElement.appendChild(div);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–¥—Ç–∏–ø—ã
            customSubsubcategories[category].forEach((customName, index) => {
                const div = document.createElement('div');
                div.className = 'subsubcat-item custom';
                div.innerHTML = `
                    <input type="checkbox" id="${category}_custom_${index}"
                           data-category="${category}"
                           data-name="${customName}"
                           checked
                           onchange="toggleSubsubcategoryLine('${category}', '${customName}', this.checked)">
                    <label for="${category}_custom_${index}">${customName}</label>
                    <span class="custom-icon" title="–î–æ–±–∞–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é">‚úã</span>
                    <button class="remove-btn" onclick="removeCustomSubsubcategory('${category}', '${customName}')" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                `;
                listElement.appendChild(div);
            });
        }

        // –†–∏—Å—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö)
        function drawTimelineChartForCategory(category) {
            const canvasId = 'timelineChart' + category;
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const data = timelineData[category];
            if (!data) return;

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (timelineCharts[category]) {
                timelineCharts[category].destroy();
            }

            // –°–æ–±–∏—Ä–∞–µ–º datasets –¥–ª—è —Ç–æ–ø-20 (–±–µ–∑ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ)
            const datasets = [];

            // –¢–æ–ø-20
            data.top20.forEach((item, index) => {
                datasets.push({
                    label: item.name,
                    data: item.data,
                    borderColor: chartColors.palette[index % chartColors.palette.length],
                    backgroundColor: chartColors.palette[index % chartColors.palette.length] + '20',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    hidden: false
                });
            });

            // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            timelineCharts[category] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: false  // –°–∫—Ä—ã–≤–∞–µ–º –ª–µ–≥–µ–Ω–¥—É, —Ç.–∫. —É –Ω–∞—Å –µ—Å—Ç—å –≥–∞–ª–æ—á–∫–∏
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return '–ú–µ—Å—è—Ü: ' + context[0].label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true
                            }
                        }
                    }
                }
            });
        }

        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–æ–¥—Ç–∏–ø–∞–º–∏
        async function drawTimelineChartForCategoryAsync(category) {
            const canvasId = 'timelineChart' + category;
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const data = timelineData[category];
            if (!data) return;

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (timelineCharts[category]) {
                timelineCharts[category].destroy();
            }

            // –°–æ–±–∏—Ä–∞–µ–º datasets –¥–ª—è —Ç–æ–ø-20 + –∫–∞—Å—Ç–æ–º–Ω—ã—Ö
            const datasets = [];

            // –¢–æ–ø-20
            data.top20.forEach((item, index) => {
                datasets.push({
                    label: item.name,
                    data: item.data,
                    borderColor: chartColors.palette[index % chartColors.palette.length],
                    backgroundColor: chartColors.palette[index % chartColors.palette.length] + '20',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    hidden: false
                });
            });

            // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–¥—Ç–∏–ø—ã (–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
            for (let index = 0; index < customSubsubcategories[category].length; index++) {
                const customName = customSubsubcategories[category][index];
                const customData = await getDataForCustomSubsubcategory(category, customName, data.months);
                const colorIndex = (data.top20.length + index) % chartColors.palette.length;

                datasets.push({
                    label: customName,
                    data: customData,
                    borderColor: chartColors.palette[colorIndex],
                    backgroundColor: chartColors.palette[colorIndex] + '20',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    hidden: false
                });
            }

            // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            timelineCharts[category] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: false  // –°–∫—Ä—ã–≤–∞–µ–º –ª–µ–≥–µ–Ω–¥—É, —Ç.–∫. —É –Ω–∞—Å –µ—Å—Ç—å –≥–∞–ª–æ—á–∫–∏
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return '–ú–µ—Å—è—Ü: ' + context[0].label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true
                            }
                        }
                    }
                }
            });
        }

        // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–¥—Ç–∏–ø–∞
        async function getDataForCustomSubsubcategory(category, name, months) {
            try {
                const response = await fetch(`/api/analytics/subsubcategory-single?category=${encodeURIComponent(category)}&name=${encodeURIComponent(name)}`);
                const result = await response.json();

                if (result.success) {
                    // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç data_array –¥–ª—è —Å–≤–æ–∏—Ö months
                    // –ù—É–∂–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å months –∏–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    const dataMap = {};
                    result.months.forEach((month, index) => {
                        dataMap[month] = result.data[index];
                    });

                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è months –∏–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    return months.map(month => dataMap[month] || 0);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è', name, ':', result.message);
                    return months.map(() => 0);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è', name, ':', error);
                return months.map(() => 0);
            }
        }

        // Toggle –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ª–∏–Ω–∏–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
        function toggleSubsubcategoryLine(category, name, visible) {
            const chart = timelineCharts[category];
            if (!chart) return;

            const dataset = chart.data.datasets.find(ds => ds.label === name);
            if (dataset) {
                dataset.hidden = !visible;
                chart.update();
            }
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–¥—Ç–∏–ø–∞
        let currentModalCategory = null;

        function showAddCustomModal(category) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
            if (customSubsubcategories[category].length >= 10) {
                alert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç: –º–∞–∫—Å–∏–º—É–º 10 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–¥—Ç–∏–ø–æ–≤');
                return;
            }

            currentModalCategory = category;
            document.getElementById('modalCategoryName').textContent = category;
            document.getElementById('customSearchInput').value = '';
            document.getElementById('customSearchResults').innerHTML = '';
            document.getElementById('addCustomModal').style.display = 'flex';
        }

        function closeAddCustomModal() {
            document.getElementById('addCustomModal').style.display = 'none';
            currentModalCategory = null;
        }

        // –ü–æ–∏—Å–∫ –ø–æ–¥—Ç–∏–ø–æ–≤
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('customSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const query = e.target.value.toLowerCase().trim();
                    if (!query || !currentModalCategory) {
                        document.getElementById('customSearchResults').innerHTML = '';
                        return;
                    }

                    const data = timelineData[currentModalCategory];
                    if (!data) return;

                    // –§–∏–ª—å—Ç—Ä—É–µ–º: —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ —Ç–æ–ø-20 –∏ –ù–ï–¢ –≤ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö
                    const top20Names = data.top20.map(item => item.name);
                    const customNames = customSubsubcategories[currentModalCategory];
                    const allNames = data.all_subsubcategories;

                    const available = allNames.filter(name =>
                        !top20Names.includes(name) &&
                        !customNames.includes(name) &&
                        name.toLowerCase().includes(query)
                    );

                    // –†–µ–Ω–¥–µ—Ä–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    const resultsDiv = document.getElementById('customSearchResults');
                    resultsDiv.innerHTML = '';

                    if (available.length === 0) {
                        resultsDiv.innerHTML = '<div class="search-result-item disabled">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                        return;
                    }

                    available.slice(0, 20).forEach(name => {
                        const div = document.createElement('div');
                        div.className = 'search-result-item';
                        div.textContent = name;
                        div.onclick = () => addCustomSubsubcategory(currentModalCategory, name);
                        resultsDiv.appendChild(div);
                    });
                });
            }
        });

        // –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–æ–¥—Ç–∏–ø
        async function addCustomSubsubcategory(category, name) {
            if (customSubsubcategories[category].length >= 10) {
                alert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç: –º–∞–∫—Å–∏–º—É–º 10 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–¥—Ç–∏–ø–æ–≤');
                return;
            }

            if (customSubsubcategories[category].includes(name)) {
                return;  // –£–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω
            }

            customSubsubcategories[category].push(name);
            closeAddCustomModal();

            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏ –≥—Ä–∞—Ñ–∏–∫
            const data = timelineData[category];
            renderSubsubcategoryList(category, data.top20);
            await drawTimelineChartForCategoryAsync(category);
        }

        // –£–¥–∞–ª–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–æ–¥—Ç–∏–ø
        function removeCustomSubsubcategory(category, name) {
            const index = customSubsubcategories[category].indexOf(name);
            if (index > -1) {
                customSubsubcategories[category].splice(index, 1);

                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏ –≥—Ä–∞—Ñ–∏–∫
                const data = timelineData[category];
                renderSubsubcategoryList(category, data.top20);
                drawTimelineChartForCategory(category);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ—ë
        window.onclick = function(event) {
            const modal = document.getElementById('addCustomModal');
            if (event.target == modal) {
                closeAddCustomModal();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalytics();
        });
    </script>
</body>
</html>
