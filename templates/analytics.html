<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - Fashion Trends</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .navigation {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: white;
        }

        .content {
            padding: 40px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        .chart-container.large {
            height: 450px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –ª–µ–≥–µ–Ω–¥–æ–π –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º */
        .timeline-card {
            width: 100%;
        }

        .timeline-chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .legend-controls {
            display: flex;
            gap: 10px;
        }

        .legend-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .legend-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .timeline-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            max-height: 200px;
            overflow-y: auto;
        }

        .timeline-legend::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .timeline-legend::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .timeline-legend::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            white-space: nowrap;
        }

        .legend-item:hover {
            background: #e9ecef;
        }

        .legend-item.custom {
            background: #fff3cd;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .legend-checkbox {
            cursor: pointer;
        }

        .legend-label {
            cursor: pointer;
            user-select: none;
            flex: 1;
        }

        .legend-item .custom-icon {
            margin-left: 4px;
            font-size: 12px;
        }

        .legend-item .remove-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 16px;
            padding: 0 4px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .legend-item .remove-btn:hover {
            opacity: 1;
        }

        .add-custom-btn-wrapper {
            position: relative;
            display: inline-block;
        }

        .add-custom-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .add-custom-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .add-custom-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Dropdown –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Ç–∏–ø–∞ */
        .custom-dropdown {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 350px;
            max-height: 400px;
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .custom-dropdown.active {
            display: flex;
        }

        .dropdown-header {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .dropdown-header h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 15px;
        }

        .dropdown-search {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .dropdown-search:focus {
            outline: none;
            border-color: #667eea;
        }

        .dropdown-results {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
        }

        .dropdown-results::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-results::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .dropdown-results::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f1f1f1;
            font-size: 14px;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item.disabled {
            color: #999;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2em;
            color: #667eea;
            font-weight: 600;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–æ–≤ */
        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            color: #6c757d;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .tab-btn:hover {
            color: #667eea;
            border-color: #667eea;
            background: #f8f9ff;
        }

        .tab-btn.active {
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        .item-gallery-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .item-gallery-modal-content {
            background-color: white;
            margin: 2% auto;
            width: 90%;
            max-width: 1400px;
            border-radius: 20px;
            overflow: hidden;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .item-gallery-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-gallery-header h2 {
            margin: 0;
            font-size: 1.8em;
        }

        .item-gallery-close {
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .item-gallery-close:hover {
            transform: scale(1.2);
        }

        .item-gallery-body {
            padding: 30px;
            overflow-y: auto;
            max-height: calc(90vh - 100px);
        }

        .item-gallery-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            gap: 20px;
        }

        .item-gallery-loader.hidden {
            display: none;
        }

        .item-gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .item-gallery-item {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .item-gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.2);
        }

        .item-gallery-item img {
            width: 100%;
            height: 280px;
            object-fit: cover;
            display: block;
        }

        .item-gallery-item-info {
            padding: 15px;
        }

        .item-gallery-item-username {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .item-gallery-item-stats {
            display: flex;
            gap: 15px;
            color: #666;
            font-size: 0.85em;
        }

        .item-gallery-item-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –ú–æ–¥–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã</h1>
            <p>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–æ–¥–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö Instagram</p>

            <div class="navigation">
                <a href="/" class="nav-btn">üîç –ü–∞—Ä—Å–µ—Ä</a>
                <a href="/gallery" class="nav-btn">üì∑ –ì–∞–ª–µ—Ä–µ—è</a>
                <a href="/gallery_to_tag" class="nav-btn">üè∑Ô∏è –í—ã–±—Ä–∞–Ω–æ –¥–ª—è —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è</a>
                <a href="/gallery_tagged" class="nav-btn">‚úÖ –û—Ç—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω—ã</a>
                <a href="/gallery_hidden" class="nav-btn">üôà –°–∫—Ä—ã—Ç—ã–µ</a>
                <a href="/analytics" class="nav-btn active">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
            </div>
        </div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>

        <div class="content">
            <!-- –û–±–∑–æ—Ä–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats-overview" id="statsOverview">
                <div class="stat-card">
                    <div class="stat-value" id="totalImages">-</div>
                    <div class="stat-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCategories">-</div>
                    <div class="stat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalColors">-</div>
                    <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalMaterials">-</div>
                    <div class="stat-label">–¢–∏–ø–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</div>
                </div>
            </div>

            <!-- –î–∞—à–±–æ—Ä–¥—ã -->
            <div class="dashboard-grid">
                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                <div class="chart-card">
                    <h3>üëó –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                    <div class="chart-container">
                        <canvas id="categoriesChart"></canvas>
                    </div>
                </div>

                <!-- –¢–æ–ø-10 –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                <div class="chart-card">
                    <h3>üî• –¢–æ–ø-10 –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π</h3>
                    <div class="chart-container">
                        <canvas id="subcategoriesChart"></canvas>
                    </div>
                </div>

                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ü–≤–µ—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
                <div class="chart-card">
                    <h3>üé® –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ü–≤–µ—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                    <div class="tabs-container">
                        <div class="tabs">
                            <button class="tab-btn active" onclick="switchTab('colors', 'Clothing')">üëó –û–¥–µ–∂–¥–∞</button>
                            <button class="tab-btn" onclick="switchTab('colors', 'Footwear')">üëü –û–±—É–≤—å</button>
                            <button class="tab-btn" onclick="switchTab('colors', 'Accessories')">üëú –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
                        </div>
                        <div id="colors-Clothing" class="tab-content active">
                            <div class="chart-container">
                                <canvas id="colorsChartClothing"></canvas>
                            </div>
                        </div>
                        <div id="colors-Footwear" class="tab-content">
                            <div class="chart-container">
                                <canvas id="colorsChartFootwear"></canvas>
                            </div>
                        </div>
                        <div id="colors-Accessories" class="tab-content">
                            <div class="chart-container">
                                <canvas id="colorsChartAccessories"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
                <div class="chart-card">
                    <h3>üßµ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                    <div class="tabs-container">
                        <div class="tabs">
                            <button class="tab-btn active" onclick="switchTab('materials', 'Clothing')">üëó –û–¥–µ–∂–¥–∞</button>
                            <button class="tab-btn" onclick="switchTab('materials', 'Footwear')">üëü –û–±—É–≤—å</button>
                            <button class="tab-btn" onclick="switchTab('materials', 'Accessories')">üëú –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
                        </div>
                        <div id="materials-Clothing" class="tab-content active">
                            <div class="chart-container">
                                <canvas id="materialsChartClothing"></canvas>
                            </div>
                        </div>
                        <div id="materials-Footwear" class="tab-content">
                            <div class="chart-container">
                                <canvas id="materialsChartFootwear"></canvas>
                            </div>
                        </div>
                        <div id="materials-Accessories" class="tab-content">
                            <div class="chart-container">
                                <canvas id="materialsChartAccessories"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
                <div class="chart-card">
                    <h3>‚ú® –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                    <div class="tabs-container">
                        <div class="tabs">
                            <button class="tab-btn active" onclick="switchTab('styles', 'Clothing')">üëó –û–¥–µ–∂–¥–∞</button>
                            <button class="tab-btn" onclick="switchTab('styles', 'Footwear')">üëü –û–±—É–≤—å</button>
                            <button class="tab-btn" onclick="switchTab('styles', 'Accessories')">üëú –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
                        </div>
                        <div id="styles-Clothing" class="tab-content active">
                            <div class="chart-container">
                                <canvas id="stylesChartClothing"></canvas>
                            </div>
                        </div>
                        <div id="styles-Footwear" class="tab-content">
                            <div class="chart-container">
                                <canvas id="stylesChartFootwear"></canvas>
                            </div>
                        </div>
                        <div id="styles-Accessories" class="tab-content">
                            <div class="chart-container">
                                <canvas id="stylesChartAccessories"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢—Ä–µ–Ω–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è Accessories -->
            <div class="chart-card timeline-card">
                <h3>
                    <span>üìà –î–∏–Ω–∞–º–∏–∫–∞ —Ç–æ–ø-20 –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤</span>
                    <div class="legend-controls">
                        <button class="legend-btn" onclick="hideAllLines('Accessories')">–°–∫—Ä—ã—Ç—å –≤—Å–µ</button>
                        <button class="legend-btn" onclick="showAllLines('Accessories')">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
                        <div class="add-custom-btn-wrapper">
                            <button class="add-custom-btn" onclick="toggleDropdown('Accessories')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∏–ø</button>
                            <div class="custom-dropdown" id="dropdownAccessories">
                                <div class="dropdown-header">
                                    <h4>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∏–ø –¥–ª—è Accessories</h4>
                                    <input type="text" class="dropdown-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ..." autocomplete="off" oninput="searchSubtypes('Accessories', this.value)">
                                </div>
                                <div class="dropdown-results" id="dropdownResultsAccessories">
                                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </h3>
                <div class="timeline-chart-container">
                    <canvas id="timelineChartAccessories"></canvas>
                </div>
                <div class="timeline-legend" id="legendAccessories">
                    <!-- –õ–µ–≥–µ–Ω–¥–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <!-- –¢—Ä–µ–Ω–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è Clothing -->
            <div class="chart-card timeline-card">
                <h3>
                    <span>üìà –î–∏–Ω–∞–º–∏–∫–∞ —Ç–æ–ø-20 –æ–¥–µ–∂–¥—ã</span>
                    <div class="legend-controls">
                        <button class="legend-btn" onclick="hideAllLines('Clothing')">–°–∫—Ä—ã—Ç—å –≤—Å–µ</button>
                        <button class="legend-btn" onclick="showAllLines('Clothing')">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
                        <div class="add-custom-btn-wrapper">
                            <button class="add-custom-btn" onclick="toggleDropdown('Clothing')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∏–ø</button>
                            <div class="custom-dropdown" id="dropdownClothing">
                                <div class="dropdown-header">
                                    <h4>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∏–ø –¥–ª—è Clothing</h4>
                                    <input type="text" class="dropdown-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ..." autocomplete="off" oninput="searchSubtypes('Clothing', this.value)">
                                </div>
                                <div class="dropdown-results" id="dropdownResultsClothing">
                                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </h3>
                <div class="timeline-chart-container">
                    <canvas id="timelineChartClothing"></canvas>
                </div>
                <div class="timeline-legend" id="legendClothing">
                    <!-- –õ–µ–≥–µ–Ω–¥–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <!-- –¢—Ä–µ–Ω–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è Footwear -->
            <div class="chart-card timeline-card">
                <h3>
                    <span>üìà –î–∏–Ω–∞–º–∏–∫–∞ —Ç–æ–ø-20 –æ–±—É–≤–∏</span>
                    <div class="legend-controls">
                        <button class="legend-btn" onclick="hideAllLines('Footwear')">–°–∫—Ä—ã—Ç—å –≤—Å–µ</button>
                        <button class="legend-btn" onclick="showAllLines('Footwear')">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
                        <div class="add-custom-btn-wrapper">
                            <button class="add-custom-btn" onclick="toggleDropdown('Footwear')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∏–ø</button>
                            <div class="custom-dropdown" id="dropdownFootwear">
                                <div class="dropdown-header">
                                    <h4>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∏–ø –¥–ª—è Footwear</h4>
                                    <input type="text" class="dropdown-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ..." autocomplete="off" oninput="searchSubtypes('Footwear', this.value)">
                                </div>
                                <div class="dropdown-results" id="dropdownResultsFootwear">
                                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </h3>
                <div class="timeline-chart-container">
                    <canvas id="timelineChartFootwear"></canvas>
                </div>
                <div class="timeline-legend" id="legendFootwear">
                    <!-- –õ–µ–≥–µ–Ω–¥–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤–µ—â–∏ -->
    <div id="itemGalleryModal" class="item-gallery-modal">
        <div class="item-gallery-modal-content">
            <div class="item-gallery-header">
                <h2 id="itemGalleryTitle">–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h2>
                <span class="item-gallery-close">&times;</span>
            </div>
            <div class="item-gallery-body">
                <div id="itemGalleryLoader" class="item-gallery-loader">
                    <div class="spinner"></div>
                    <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</div>
                </div>
                <div id="itemGalleryGrid" class="item-gallery-grid"></div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        const chartColors = {
            primary: '#667eea',
            secondary: '#764ba2',
            success: '#28a745',
            danger: '#dc3545',
            warning: '#ffc107',
            info: '#17a2b8',
            palette: [
                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                '#a8edea', '#fed6e3', '#c471ed', '#12c2e9',
                '#ff9a9e', '#fbc2eb', '#a18cd1', '#fad0c4',
                '#ffecd2', '#fcb69f', '#ff6e7f', '#bfe9ff'
            ]
        };

        // –ú–∞–ø–ø–∏–Ω–≥ —Ü–≤–µ—Ç–æ–≤ –Ω–∞ CSS —Ü–≤–µ—Ç–∞
        const colorMapping = {
            'Black': '#000000',
            'White': '#FFFFFF',
            'Red': '#FF0000',
            'Blue': '#0000FF',
            'Green': '#00FF00',
            'Yellow': '#FFFF00',
            'Pink': '#FFC0CB',
            'Purple': '#800080',
            'Orange': '#FFA500',
            'Brown': '#8B4513',
            'Gray': '#808080',
            'Grey': '#808080',
            'Beige': '#F5F5DC',
            'Navy': '#000080',
            'Turquoise': '#40E0D0',
            'Gold': '#FFD700',
            'Silver': '#C0C0C0'
        };

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
        let analyticsData = {
            colorsByCategory: null,
            materialsByCategory: null,
            stylesByCategory: null
        };

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const timelineData = {
            Clothing: null,
            Accessories: null,
            Footwear: null
        };

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–¥—Ç–∏–ø–æ–≤ (–º–∞–∫—Å 10 –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é)
        const customSubsubcategories = {
            Clothing: [],
            Accessories: [],
            Footwear: []
        };

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è Chart.js –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
        const timelineCharts = {
            Clothing: null,
            Accessories: null,
            Footwear: null
        };

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
        function switchTab(section, category) {
            const parentCard = document.querySelector(`#${section}-${category}`).closest('.chart-card');
            const tabs = parentCard.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            const allTabs = parentCard.querySelectorAll('.tab-content');
            allTabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById(`${section}-${category}`).classList.add('active');
        }

        // ============================================
        // –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ì–ê–õ–ï–†–ï–ò –í–ï–©–ï–ô
        // ============================================

        function openItemGallery(itemName, topCategory) {
            const modal = document.getElementById('itemGalleryModal');
            const title = document.getElementById('itemGalleryTitle');
            const loader = document.getElementById('itemGalleryLoader');
            const grid = document.getElementById('itemGalleryGrid');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ loader
            modal.style.display = 'block';
            title.textContent = `–ì–∞–ª–µ—Ä–µ—è: ${itemName}`;
            loader.classList.remove('hidden');
            grid.innerHTML = '';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            fetch(`/api/analytics/item-gallery?item_name=${encodeURIComponent(itemName)}&top_category=${encodeURIComponent(topCategory)}`)
                .then(response => response.json())
                .then(data => {
                    loader.classList.add('hidden');

                    if (!data.success) {
                        grid.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 40px;">${data.message}</div>`;
                        return;
                    }

                    if (data.images.length === 0) {
                        grid.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                        return;
                    }

                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    data.images.forEach(image => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'item-gallery-item';

                        const imageUrl = `/images/${image.local_filename}`;

                        itemDiv.innerHTML = `
                            <img src="${imageUrl}" alt="${itemName}" loading="lazy">
                            <div class="item-gallery-item-info">
                                <div class="item-gallery-item-username">@${image.username || 'unknown'}</div>
                                <div class="item-gallery-item-stats">
                                    <div class="item-gallery-item-stat">‚ù§Ô∏è ${image.likes_count || 0}</div>
                                    <div class="item-gallery-item-stat">üí¨ ${image.comments_count || 0}</div>
                                </div>
                            </div>
                        `;

                        grid.appendChild(itemDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading gallery:', error);
                    loader.classList.add('hidden');
                    grid.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 40px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏</div>';
                });
        }

        function closeItemGallery() {
            const modal = document.getElementById('itemGalleryModal');
            modal.style.display = 'none';
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ DOMContentLoaded –≤ –∫–æ–Ω—Ü–µ —Å–∫—Ä–∏–ø—Ç–∞)
        function initModalHandlers() {
            const modal = document.getElementById('itemGalleryModal');
            const closeBtn = document.querySelector('.item-gallery-close');

            if (closeBtn) {
                closeBtn.onclick = closeItemGallery;
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            window.onclick = function(event) {
                if (event.target === modal) {
                    closeItemGallery();
                }
            };
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadAnalytics() {
            try {
                const [categories, subcategories, colorsByCategory, materialsByCategory, stylesByCategory, subsubcategoryTimeline] = await Promise.all([
                    fetch('/api/analytics/categories-stats').then(r => r.json()),
                    fetch('/api/analytics/subcategories-stats').then(r => r.json()),
                    fetch('/api/analytics/colors-by-category').then(r => r.json()),
                    fetch('/api/analytics/materials-by-category').then(r => r.json()),
                    fetch('/api/analytics/styles-by-category').then(r => r.json()),
                    fetch('/api/analytics/subsubcategory-timeline').then(r => r.json())
                ]);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ timeline
                if (subsubcategoryTimeline.success) {
                    timelineData.Clothing = subsubcategoryTimeline.data.Clothing;
                    timelineData.Accessories = subsubcategoryTimeline.data.Accessories;
                    timelineData.Footwear = subsubcategoryTimeline.data.Footwear;
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                analyticsData.colorsByCategory = colorsByCategory;
                analyticsData.materialsByCategory = materialsByCategory;
                analyticsData.stylesByCategory = stylesByCategory;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                if (categories.success) {
                    const totalImages = categories.categories.reduce((sum, c) => sum + c.count, 0);
                    document.getElementById('totalImages').textContent = totalImages.toLocaleString();
                    document.getElementById('totalCategories').textContent = categories.categories.length;
                }

                if (colorsByCategory.success) {
                    const allColors = new Set();
                    Object.values(colorsByCategory.data).forEach(colors => {
                        colors.forEach(c => allColors.add(c.name));
                    });
                    document.getElementById('totalColors').textContent = allColors.size;
                }

                if (materialsByCategory.success) {
                    const allMaterials = new Set();
                    Object.values(materialsByCategory.data).forEach(materials => {
                        materials.forEach(m => allMaterials.add(m.name));
                    });
                    document.getElementById('totalMaterials').textContent = allMaterials.size;
                }

                // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                if (categories.success) drawCategoriesChart(categories.categories);
                if (subcategories.success) drawSubcategoriesChart(subcategories.subcategories);

                if (colorsByCategory.success) {
                    drawColorsByCategoryChart('Clothing', colorsByCategory.data.Clothing);
                    drawColorsByCategoryChart('Footwear', colorsByCategory.data.Footwear);
                    drawColorsByCategoryChart('Accessories', colorsByCategory.data.Accessories);
                }

                if (materialsByCategory.success) {
                    drawMaterialsByCategoryChart('Clothing', materialsByCategory.data.Clothing);
                    drawMaterialsByCategoryChart('Footwear', materialsByCategory.data.Footwear);
                    drawMaterialsByCategoryChart('Accessories', materialsByCategory.data.Accessories);
                }

                if (stylesByCategory.success) {
                    drawStylesByCategoryChart('Clothing', stylesByCategory.data.Clothing);
                    drawStylesByCategoryChart('Footwear', stylesByCategory.data.Footwear);
                    drawStylesByCategoryChart('Accessories', stylesByCategory.data.Accessories);
                }

                // –†–∏—Å—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
                if (subsubcategoryTimeline.success) {
                    initializeTimelineCharts('Accessories');
                    initializeTimelineCharts('Clothing');
                    initializeTimelineCharts('Footwear');
                }

                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('loadingOverlay').classList.add('hidden');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
                document.querySelector('.content').insertAdjacentHTML('afterbegin',
                    '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message + '</div>');
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        // –ì—Ä–∞—Ñ–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function drawCategoriesChart(data) {
            const ctx = document.getElementById('categoriesChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: chartColors.palette,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function drawSubcategoriesChart(data) {
            const ctx = document.getElementById('subcategoriesChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                        data: data.map(d => d.count),
                        backgroundColor: chartColors.palette[0],
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const itemName = data[index].name;
                            const category = data[index].category;
                            openItemGallery(itemName, category);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return data[context[0].dataIndex].name + ' (' + data[context[0].dataIndex].category + ')';
                                },
                                footer: function() {
                                    return '–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥–∞–ª–µ—Ä–µ–∏';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { display: true } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ —Ü–≤–µ—Ç–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function drawColorsByCategoryChart(category, data) {
            const ctx = document.getElementById(`colorsChart${category}`).getContext('2d');
            const backgroundColors = data.map(d => colorMapping[d.name] || chartColors.palette[0]);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                        data: data.map(d => d.count),
                        backgroundColor: backgroundColors,
                        borderColor: '#fff',
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const colorName = data[index].name;
                            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ —Ü–≤–µ—Ç—É
                            openItemGallery(colorName, category);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                footer: function() {
                                    return '–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥–∞–ª–µ—Ä–µ–∏';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { display: true } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function drawMaterialsByCategoryChart(category, data) {
            const ctx = document.getElementById(`materialsChart${category}`).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: chartColors.palette,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const materialName = data[index].name;
                            openItemGallery(materialName, category);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                },
                                footer: function() {
                                    return '–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥–∞–ª–µ—Ä–µ–∏';
                                }
                            }
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∏–ª–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function drawStylesByCategoryChart(category, data) {
            const ctx = document.getElementById(`stylesChart${category}`).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: chartColors.palette,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const styleName = data[index].name;
                            openItemGallery(styleName, category);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                },
                                footer: function() {
                                    return '–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥–∞–ª–µ—Ä–µ–∏';
                                }
                            }
                        }
                    }
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function initializeTimelineCharts(category) {
            const data = timelineData[category];
            if (!data) return;

            drawTimelineChartForCategory(category);
            renderLegend(category);
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–µ–≥–µ–Ω–¥—ã –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º
        function renderLegend(category) {
            const legendId = 'legend' + category;
            const legendElement = document.getElementById(legendId);
            if (!legendElement) return;

            legendElement.innerHTML = '';
            const data = timelineData[category];

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ø-20
            data.top20.forEach((item, index) => {
                const color = chartColors.palette[index % chartColors.palette.length];
                const div = document.createElement('div');
                div.className = 'legend-item';
                div.innerHTML = `
                    <span class="legend-color" style="background-color: ${color}"></span>
                    <input type="checkbox" class="legend-checkbox" id="${category}_legend_${index}"
                           data-category="${category}"
                           data-name="${item.name}"
                           checked
                           onchange="toggleSubsubcategoryLine('${category}', '${item.name}', this.checked)">
                    <label class="legend-label" for="${category}_legend_${index}">${item.name}</label>
                `;
                legendElement.appendChild(div);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–¥—Ç–∏–ø—ã
            customSubsubcategories[category].forEach((customName, index) => {
                const colorIndex = (data.top20.length + index) % chartColors.palette.length;
                const color = chartColors.palette[colorIndex];
                const div = document.createElement('div');
                div.className = 'legend-item custom';
                div.innerHTML = `
                    <span class="legend-color" style="background-color: ${color}"></span>
                    <input type="checkbox" class="legend-checkbox" id="${category}_legend_custom_${index}"
                           data-category="${category}"
                           data-name="${customName}"
                           checked
                           onchange="toggleSubsubcategoryLine('${category}', '${customName}', this.checked)">
                    <label class="legend-label" for="${category}_legend_custom_${index}">${customName}</label>
                    <span class="custom-icon" title="–î–æ–±–∞–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é">‚úã</span>
                    <button class="remove-btn" onclick="removeCustomSubsubcategory('${category}', '${customName}')" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                `;
                legendElement.appendChild(div);
            });
        }

        // –†–∏—Å—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function drawTimelineChartForCategory(category) {
            const canvasId = 'timelineChart' + category;
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const data = timelineData[category];
            if (!data) return;

            if (timelineCharts[category]) {
                timelineCharts[category].destroy();
            }

            const datasets = [];

            // –¢–æ–ø-20
            data.top20.forEach((item, index) => {
                datasets.push({
                    label: item.name,
                    data: item.data,
                    borderColor: chartColors.palette[index % chartColors.palette.length],
                    backgroundColor: chartColors.palette[index % chartColors.palette.length] + '20',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    hidden: false
                });
            });

            timelineCharts[category] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return '–ú–µ—Å—è—Ü: ' + context[0].label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true, grid: { display: true } }
                    }
                }
            });
        }

        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–¥—Ç–∏–ø–æ–≤
        async function drawTimelineChartForCategoryAsync(category) {
            const canvasId = 'timelineChart' + category;
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const data = timelineData[category];
            if (!data) return;

            if (timelineCharts[category]) {
                timelineCharts[category].destroy();
            }

            const datasets = [];

            // –¢–æ–ø-20
            data.top20.forEach((item, index) => {
                datasets.push({
                    label: item.name,
                    data: item.data,
                    borderColor: chartColors.palette[index % chartColors.palette.length],
                    backgroundColor: chartColors.palette[index % chartColors.palette.length] + '20',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    hidden: false
                });
            });

            // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–¥—Ç–∏–ø—ã
            for (let index = 0; index < customSubsubcategories[category].length; index++) {
                const customName = customSubsubcategories[category][index];
                const customData = await getDataForCustomSubsubcategory(category, customName, data.months);
                const colorIndex = (data.top20.length + index) % chartColors.palette.length;

                datasets.push({
                    label: customName,
                    data: customData,
                    borderColor: chartColors.palette[colorIndex],
                    backgroundColor: chartColors.palette[colorIndex] + '20',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    hidden: false
                });
            }

            timelineCharts[category] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return '–ú–µ—Å—è—Ü: ' + context[0].label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true, grid: { display: true } }
                    }
                }
            });
        }

        // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–¥—Ç–∏–ø–∞
        async function getDataForCustomSubsubcategory(category, name, months) {
            try {
                const response = await fetch(`/api/analytics/subsubcategory-single?category=${encodeURIComponent(category)}&name=${encodeURIComponent(name)}`);
                const result = await response.json();

                if (result.success) {
                    const dataMap = {};
                    result.months.forEach((month, index) => {
                        dataMap[month] = result.data[index];
                    });
                    return months.map(month => dataMap[month] || 0);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è', name, ':', result.message);
                    return months.map(() => 0);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è', name, ':', error);
                return months.map(() => 0);
            }
        }

        // Toggle –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ª–∏–Ω–∏–∏
        function toggleSubsubcategoryLine(category, name, visible) {
            const chart = timelineCharts[category];
            if (!chart) return;

            const dataset = chart.data.datasets.find(ds => ds.label === name);
            if (dataset) {
                dataset.hidden = !visible;
                chart.update();
            }
        }

        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –ª–∏–Ω–∏–∏
        function hideAllLines(category) {
            const chart = timelineCharts[category];
            if (!chart) return;

            chart.data.datasets.forEach(ds => ds.hidden = true);
            chart.update();

            // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
            const legendElement = document.getElementById('legend' + category);
            if (legendElement) {
                legendElement.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ª–∏–Ω–∏–∏
        function showAllLines(category) {
            const chart = timelineCharts[category];
            if (!chart) return;

            chart.data.datasets.forEach(ds => ds.hidden = false);
            chart.update();

            // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
            const legendElement = document.getElementById('legend' + category);
            if (legendElement) {
                legendElement.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            }
        }

        // Dropdown –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Ç–∏–ø–æ–≤
        function toggleDropdown(category) {
            if (customSubsubcategories[category].length >= 10) {
                alert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç: –º–∞–∫—Å–∏–º—É–º 10 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–¥—Ç–∏–ø–æ–≤');
                return;
            }

            const dropdown = document.getElementById('dropdown' + category);
            const isActive = dropdown.classList.contains('active');

            // –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ dropdown
            document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('active'));

            // –û—Ç–∫—Ä—ã—Ç—å —Ç–µ–∫—É—â–∏–π –µ—Å–ª–∏ –±—ã–ª –∑–∞–∫—Ä—ã—Ç
            if (!isActive) {
                dropdown.classList.add('active');
                const input = dropdown.querySelector('.dropdown-search');
                if (input) {
                    input.value = '';
                    input.focus();
                    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–¥—Ç–∏–ø—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                    searchSubtypes(category, '');
                }
            }
        }

        function searchSubtypes(category, query) {
            const resultsDiv = document.getElementById('dropdownResults' + category);
            if (!resultsDiv) return;

            const data = timelineData[category];
            if (!data) return;

            const top20Names = data.top20.map(item => item.name);
            const customNames = customSubsubcategories[category];
            const allNames = data.all_subsubcategories;

            let available = allNames.filter(name =>
                !top20Names.includes(name) &&
                !customNames.includes(name)
            );

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É
            if (query) {
                const queryLower = query.toLowerCase().trim();
                available = available.filter(name => name.toLowerCase().includes(queryLower));
            }

            resultsDiv.innerHTML = '';

            if (available.length === 0) {
                resultsDiv.innerHTML = '<div class="dropdown-item disabled">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }

            available.slice(0, 20).forEach(name => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.textContent = name;
                div.onclick = () => addCustomSubsubcategory(category, name);
                resultsDiv.appendChild(div);
            });
        }

        // –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–æ–¥—Ç–∏–ø
        async function addCustomSubsubcategory(category, name) {
            if (customSubsubcategories[category].length >= 10) {
                alert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç: –º–∞–∫—Å–∏–º—É–º 10 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–¥—Ç–∏–ø–æ–≤');
                return;
            }

            if (customSubsubcategories[category].includes(name)) {
                return;
            }

            customSubsubcategories[category].push(name);

            // –ó–∞–∫—Ä—ã—Ç—å dropdown
            document.getElementById('dropdown' + category).classList.remove('active');

            await drawTimelineChartForCategoryAsync(category);
            renderLegend(category);
        }

        // –£–¥–∞–ª–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–æ–¥—Ç–∏–ø
        function removeCustomSubsubcategory(category, name) {
            const index = customSubsubcategories[category].indexOf(name);
            if (index > -1) {
                customSubsubcategories[category].splice(index, 1);
                drawTimelineChartForCategory(category);
                renderLegend(category);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.add-custom-btn-wrapper')) {
                document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('active'));
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            initModalHandlers();
            loadAnalytics();
        });
    </script>
</body>
</html>
