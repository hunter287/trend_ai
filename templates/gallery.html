<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Галерея изображений</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .navigation {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: white;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            transition: border-radius 0.3s ease;
        }

        .controls.filters-open {
            border-bottom: none;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #667eea;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-orange {
            background: #ff6b35;
            color: white;
        }
        
        .btn-orange:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }
        
        .ximilar-tags {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #ff6b35;
        }
        
        .ximilar-tags strong {
            color: #495057;
            font-size: 12px;
            display: block;
            margin-bottom: 4px;
        }
        
        .tag {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin: 2px 2px 2px 0;
            font-weight: 500;
        }
        
        .tag-more {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin: 2px 2px 2px 0;
            font-weight: 500;
        }
        
        .advanced-filters {
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
            padding: 0;
            margin: 0 30px 20px 30px;
            border: 1px solid #dee2e6;
            border-top: none;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0);
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out, padding 0.4s ease-out, box-shadow 0.3s ease-out;
        }

        .advanced-filters.open {
            max-height: 800px;
            opacity: 1;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .hierarchical-filters {
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }

        .hierarchical-filters::-webkit-scrollbar {
            width: 8px;
        }

        .hierarchical-filters::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .hierarchical-filters::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .hierarchical-filters::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .filter-categories, .filter-subcategories, .filter-details {
            transition: all 0.3s ease;
        }

        .filter-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .subcategory-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }
        
        .category-option, .subcategory-option {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-option:hover, .subcategory-option:hover {
            background: #e9ecef;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .category-info, .subcategory-info {
            flex: 1;
        }
        
        .category-info h4 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }
        
        .subcategory-info h5 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .category-count, .subcategory-count {
            font-size: 12px;
            color: #6c757d;
        }
        
        .category-arrow, .subcategory-arrow {
            font-size: 18px;
            color: #007bff;
            font-weight: bold;
        }
        
        .subcategory-header, .filter-details-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .btn-back {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .btn-back:hover {
            background: #5a6268;
        }
        
        .filter-details-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .filter-section h5 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .filter-name {
            flex: 1;
        }
        
        .filter-count {
            color: #6c757d;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .filter-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }
        
        .filter-option:hover {
            background: #e9ecef;
        }
        
        .filter-option.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        
        .category-group {
            margin: 2px 0;
            padding: 3px 6px;
            background: #ffffff;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-size: 10px;
        }
        
        .category-name {
            font-weight: 600;
            color: #495057;
            text-transform: capitalize;
        }
        
        .category-objects {
            color: #6c757d;
            margin-left: 4px;
        }
        
        .gallery {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            align-items: start;
        }
        
        @media (max-width: 1200px) {
            .gallery {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }
        }
        
        @media (max-width: 800px) {
            .gallery {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
            }
        }
        
        @media (max-width: 500px) {
            .gallery {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        .image-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border: 3px solid transparent;
            width: 100%;
            height: fit-content;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .image-card.selected {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .image-container {
            position: relative;
            overflow: hidden;
        }
        
        .image-container img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s;
        }
        
        .image-card:hover .image-container img {
            transform: scale(1.05);
        }
        
        .checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 25px;
            height: 25px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #667eea;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .checkbox.checked {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        .image-info {
            padding: 20px;
        }
        
        .username {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .caption {
            font-size: 0.9em;
            color: #495057;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .selected-count {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .no-images {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.2em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.1em;
        }
        
        @media (max-width: 768px) {
            .gallery {
                padding: 20px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .filter-categories,
            .subcategory-list {
                grid-template-columns: 1fr;
            }

            .filter-options {
                grid-template-columns: 1fr;
            }

            .advanced-filters {
                margin: 0 15px 15px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Trend Watching</h1>
            {% if current_page == 'gallery' %}
                <p>Выберите изображения для теггирования</p>
            {% elif current_page == 'gallery_to_tag' %}
                <p>Изображения, выбранные для теггирования</p>
            {% else %}
                <p>Изображения с тегами Ximilar</p>
            {% endif %}
            
            <!-- Навигация -->
            <div class="navigation">
                <a href="/" class="nav-btn">
                    🔍 Парсер
                </a>
                <a href="/gallery" class="nav-btn {% if current_page == 'gallery' %}active{% endif %}">
                    📷 Галерея
                </a>
                <a href="/gallery_to_tag" class="nav-btn {% if current_page == 'gallery_to_tag' %}active{% endif %}">
                    🏷️ Выбрано для теггирования
                </a>
                <a href="/gallery_tagged" class="nav-btn {% if current_page == 'gallery_tagged' %}active{% endif %}">
                    ✅ Оттегированы
                </a>
            </div>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="🔍 Поиск по подписи или имени пользователя...">
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Все</button>
                <button class="filter-btn" data-filter="selected">Выбранные</button>
                <button class="filter-btn" data-filter="unselected">Не выбранные</button>
                {% if current_page == 'gallery_tagged' %}
                <button class="filter-btn" id="toggleAdvancedFilters">🔍 Расширенные фильтры</button>
                {% endif %}
            </div>
            
            <div class="action-buttons">
                {% if current_page == 'gallery' %}
                    <button class="btn btn-primary" id="selectAllBtn">Выбрать все</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">Очистить выбор</button>
                    <button class="btn btn-primary" id="markForTaggingBtn" disabled>
                        Отметить для теггирования
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                    <button class="btn btn-secondary" id="hideImagesBtn" disabled>
                        👁️ Скрыть
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                {% elif current_page == 'gallery_to_tag' %}
                    <button class="btn btn-primary" id="selectAllBtn">Выбрать все</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">Очистить выбор</button>
                    <button class="btn btn-secondary" id="unmarkBtn" disabled>
                        Убрать из теггирования
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                    <button class="btn btn-orange" id="tagImagesBtn" disabled>
                        🏷️ Теггировать
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                {% else %}
                    <button class="btn btn-primary" id="selectAllBtn">Выбрать все</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">Очистить выбор</button>
                {% endif %}
            </div>
        </div>

        {% if current_page == 'gallery_tagged' %}
        <div class="advanced-filters" id="advancedFilters">
            <!-- Фильтр по датам -->
            <div class="date-filter-section" style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #dee2e6;">
                <h4 style="margin: 0 0 15px 0; color: #495057; font-size: 16px; font-weight: 600;">📅 Фильтр по датам</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label for="dateFrom" style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px; font-weight: 600;">От:</label>
                        <input type="date" id="dateFrom" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label for="dateTo" style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px; font-weight: 600;">До:</label>
                        <input type="date" id="dateTo" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
            </div>

            <div class="hierarchical-filters">
                <div class="filter-categories" id="filterCategories">
                    <!-- Категории будут загружены динамически -->
                </div>

                <div class="filter-subcategories" id="filterSubcategories" style="display: none;">
                    <div class="subcategory-header">
                        <button class="btn btn-back" id="backToCategories">← Назад к категориям</button>
                        <h4 id="selectedCategoryTitle">Выберите подкатегорию</h4>
                    </div>
                    <div class="subcategory-list" id="subcategoryList">
                        <!-- Подкатегории будут загружены динамически -->
                    </div>
                </div>

                <div class="filter-details" id="filterDetails" style="display: none;">
                    <div class="filter-details-header">
                        <button class="btn btn-back" id="backToSubcategories">← Назад к подкатегориям</button>
                        <h4 id="selectedSubcategoryTitle">Фильтры</h4>
                    </div>

                    <div class="filter-details-content">
                        <div class="filter-section">
                            <h5>Цвета</h5>
                            <div class="filter-options" id="colorFilters"></div>
                        </div>

                        <div class="filter-section">
                            <h5>Материалы</h5>
                            <div class="filter-options" id="materialFilters"></div>
                        </div>

                        <div class="filter-section">
                            <h5>Стили</h5>
                            <div class="filter-options" id="styleFilters"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" id="applyFiltersBtn">Применить фильтры</button>
                <button class="btn btn-secondary" id="clearFiltersBtn">Сбросить</button>
            </div>
        </div>
        {% endif %}

        <div class="gallery" id="gallery">
            {% if images %}
                {% for image in images %}
                <div class="image-card"
                     data-image-id="{{ image._id }}"
                     data-username="{{ image.username }}"
                     data-caption="{{ image.caption or '' }}"
                     data-tagged-at="{% if image.timestamp %}{{ image.timestamp if image.timestamp is string else image.timestamp.isoformat() }}{% endif %}"
                     onclick="toggleSelection('{{ image._id }}')"
                     {% if current_page == 'gallery_tagged' and image.ximilar_objects_structured %}
                     {# Дедупликация объектов по названию (как в API) #}
                     {% set unique_categories = [] %}
                     {% set unique_objects = [] %}
                     {% set unique_colors = [] %}
                     {% set unique_materials = [] %}
                     {% set unique_styles = [] %}
                     {% set unique_objects_by_name = {} %}
                     
                    {# Сначала дедуплицируем объекты по их основному названию с учётом категории #}
                    {% for obj in image.ximilar_objects_structured %}
                        {% set obj_name = '' %}
                        {% set obj_category = obj.top_category or 'Other' %}
                        {% if obj.properties and obj.properties.other_attributes %}
                            {% if obj.properties.other_attributes.Subcategory %}
                                {% set obj_name = obj.properties.other_attributes.Subcategory[0].name %}
                            {% elif obj.properties.other_attributes.Category %}
                                {% set obj_name = obj.properties.other_attributes.Category[0].name %}
                            {% endif %}
                        {% endif %}
                        
                        {# Нормализуем название в контексте категории #}
                        {% if obj_name %}
                            {% set normalized_name = normalize_subcategory(obj_name, obj_category) %}
                            {# Если объект с таким нормализованным названием еще не добавлен, добавляем его #}
                            {% if normalized_name not in unique_objects_by_name %}
                                {% set _ = unique_objects_by_name.update({normalized_name: obj}) %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                     
                     {# Теперь собираем уникальные теги только из дедуплицированных объектов #}
                     {% for obj in unique_objects_by_name.values() %}
                         {# Категории #}
                         {% if obj.top_category and obj.top_category not in unique_categories %}
                             {% set _ = unique_categories.append(obj.top_category) %}
                         {% endif %}
                         
                        {# Объекты - нормализуем в контексте категории #}
                        {% set obj_category = obj.top_category or 'Other' %}
                        {% if obj.properties and obj.properties.other_attributes %}
                            {% if obj.properties.other_attributes.Subcategory %}
                                {% set obj_name = obj.properties.other_attributes.Subcategory[0].name %}
                                {% set normalized_obj = normalize_subcategory(obj_name, obj_category) %}
                                {% if normalized_obj not in unique_objects %}
                                    {% set _ = unique_objects.append(normalized_obj) %}
                                {% endif %}
                            {% elif obj.properties.other_attributes.Category %}
                                {% set obj_name = obj.properties.other_attributes.Category[0].name %}
                                {% set normalized_obj = normalize_subcategory(obj_name, obj_category) %}
                                {% if normalized_obj not in unique_objects %}
                                    {% set _ = unique_objects.append(normalized_obj) %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                         
                         {# Цвета #}
                         {% if obj.properties and obj.properties.visual_attributes and obj.properties.visual_attributes.Color %}
                             {% for color in obj.properties.visual_attributes.Color %}
                                 {% if color.name not in unique_colors %}
                                     {% set _ = unique_colors.append(color.name) %}
                                 {% endif %}
                             {% endfor %}
                         {% endif %}
                         
                         {# Материалы #}
                         {% if obj.properties and obj.properties.material_attributes and obj.properties.material_attributes.Material %}
                             {% for material in obj.properties.material_attributes.Material %}
                                 {% if material.name not in unique_materials %}
                                     {% set _ = unique_materials.append(material.name) %}
                                 {% endif %}
                             {% endfor %}
                         {% endif %}
                         
                         {# Стили #}
                         {% if obj.properties and obj.properties.style_attributes and obj.properties.style_attributes.Style %}
                             {% for style in obj.properties.style_attributes.Style %}
                                 {% if style.name not in unique_styles %}
                                     {% set _ = unique_styles.append(style.name) %}
                                 {% endif %}
                             {% endfor %}
                         {% endif %}
                     {% endfor %}
                     
                     data-categories="{{ unique_categories|join(',') }}"
                     data-objects="{{ unique_objects|join(',') }}"
                     data-colors="{{ unique_colors|join(',') }}"
                     data-materials="{{ unique_materials|join(',') }}"
                     data-styles="{{ unique_styles|join(',') }}"
                     {% endif %}>
                    <div class="image-container">
                        <img src="/images/{{ image.local_filename }}" alt="{{ image.caption or 'Изображение' }}" loading="lazy">
                        <div class="checkbox"></div>
                    </div>
                    <div class="image-info">
                        <div class="username">@{{ image.username }}</div>
                        <div class="stats">
                            <span>❤️ {{ image.likes_count or 0 }}</span>
                            <span>💬 {{ image.comments_count or 0 }}</span>
                        </div>
                        <div class="caption">{{ image.caption or 'Без описания' }}</div>
                        {% if current_page == 'gallery_tagged' and image.ximilar_objects_structured %}
                            <div class="ximilar-tags">
                                {% set categories = {} %}
                                {% for obj in image.ximilar_objects_structured %}
                                    {% set category = obj.top_category or 'other' %}
                                    {% if category not in categories %}
                                        {% set _ = categories.update({category: []}) %}
                                    {% endif %}
                                    
                                    {% set obj_info = '' %}
                                    {% set color = '' %}
                                    {% set material = '' %}
                                    {% set style = '' %}
                                    
                                    {% if obj.properties %}
                                        {# Получаем конкретное название объекта из Subcategory #}
                                        {% if obj.properties.other_attributes and obj.properties.other_attributes.Subcategory %}
                                            {% set subcategory_list = obj.properties.other_attributes.Subcategory %}
                                            {% if subcategory_list and subcategory_list|length > 0 %}
                                                {% set obj_info = subcategory_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# Если нет Subcategory, используем Category #}
                                        {% if not obj_info and obj.properties.other_attributes and obj.properties.other_attributes.Category %}
                                            {% set category_list = obj.properties.other_attributes.Category %}
                                            {% if category_list and category_list|length > 0 %}
                                                {% set obj_info = category_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# Если ничего не найдено, используем name #}
                                        {% if not obj_info %}
                                            {% set obj_info = obj.name %}
                                        {% endif %}
                                        
                                        {# Получаем цвет из visual_attributes.Color #}
                                        {% if obj.properties.visual_attributes and obj.properties.visual_attributes.Color %}
                                            {% set color_list = obj.properties.visual_attributes.Color %}
                                            {% if color_list and color_list|length > 0 %}
                                                {% set color = color_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# Получаем материал из material_attributes.Material #}
                                        {% if obj.properties.material_attributes and obj.properties.material_attributes.Material %}
                                            {% set material_list = obj.properties.material_attributes.Material %}
                                            {% if material_list and material_list|length > 0 %}
                                                {% set material = material_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# Получаем стиль из style_attributes.Style #}
                                        {% if obj.properties.style_attributes and obj.properties.style_attributes.Style %}
                                            {% set style_list = obj.properties.style_attributes.Style %}
                                            {% if style_list and style_list|length > 0 %}
                                                {% set style = style_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {% if color or material or style %}
                                            {% set properties = [] %}
                                            {% if color %}{% set _ = properties.append(color) %}{% endif %}
                                            {% if material %}{% set _ = properties.append(material) %}{% endif %}
                                            {% if style %}{% set _ = properties.append(style) %}{% endif %}
                                            {% set obj_info = obj_info + ' (' + properties|join(', ') + ')' %}
                                        {% endif %}
                                    {% endif %}
                                    
                                    {% set _ = categories[category].append(obj_info) %}
                                {% endfor %}
                                
                                {% for category, objects in categories.items() %}
                                    <div class="category-group">
                                        <span class="category-name">{{ category }}:</span>
                                        <span class="category-objects">{{ objects|join(', ') }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% elif current_page == 'gallery_tagged' and image.ximilar_tags %}
                            <div class="ximilar-tags">
                                {% for tag in image.ximilar_tags[:3] %}
                                    <span class="tag">{{ tag.name }}</span>
                                {% endfor %}
                                {% if image.ximilar_tags|length > 3 %}
                                    <span class="tag-more">+{{ image.ximilar_tags|length - 3 }} еще</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-images">
                    <h3>📷 Изображения не найдены</h3>
                    <p>Сначала выполните парсинг аккаунтов Instagram</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        let selectedImages = new Set();

        // Переменные для infinite scroll
        let currentOffset = parseInt('{{ images|length }}');  // Начинаем с количества уже загруженных изображений
        let isLoading = false;
        let hasMore = true;
        const galleryType = '{{ current_page }}';
        const BATCH_SIZE = 50;

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectedCount();
            setupEventListeners();
            setupInfiniteScroll();
        });
        
        function setupEventListeners() {
            // Поиск
            document.getElementById('searchInput').addEventListener('input', filterImages);
            
            // Фильтры
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterImages();
                });
            });
            
            // Кнопки действий
            const selectAllBtn = document.getElementById('selectAllBtn');
            const clearSelectionBtn = document.getElementById('clearSelectionBtn');
            const markForTaggingBtn = document.getElementById('markForTaggingBtn');
            const hideImagesBtn = document.getElementById('hideImagesBtn');
            const unmarkBtn = document.getElementById('unmarkBtn');
            const tagImagesBtn = document.getElementById('tagImagesBtn');
            
            if (selectAllBtn) selectAllBtn.addEventListener('click', selectAll);
            if (clearSelectionBtn) clearSelectionBtn.addEventListener('click', clearSelection);
            if (markForTaggingBtn) markForTaggingBtn.addEventListener('click', markForTagging);
            if (hideImagesBtn) hideImagesBtn.addEventListener('click', hideImages);
            if (unmarkBtn) unmarkBtn.addEventListener('click', unmarkForTagging);
            if (tagImagesBtn) tagImagesBtn.addEventListener('click', tagImages);
            
            // Расширенные фильтры для страницы оттегированных
            if ('{{ current_page }}' === 'gallery_tagged') {
                const toggleAdvancedFiltersBtn = document.getElementById('toggleAdvancedFilters');
                const advancedFilters = document.getElementById('advancedFilters');
                const applyFiltersBtn = document.getElementById('applyFiltersBtn');
                const clearFiltersBtn = document.getElementById('clearFiltersBtn');
                
                if (toggleAdvancedFiltersBtn && advancedFilters) {
                    toggleAdvancedFiltersBtn.addEventListener('click', () => {
                        const controls = document.querySelector('.controls');
                        if (advancedFilters.classList.contains('open')) {
                            advancedFilters.classList.remove('open');
                            controls.classList.remove('filters-open');
                            toggleAdvancedFiltersBtn.textContent = '🔍 Расширенные фильтры';
                        } else {
                            advancedFilters.classList.add('open');
                            controls.classList.add('filters-open');
                            toggleAdvancedFiltersBtn.textContent = '🔍 Скрыть фильтры';
                            loadFilterOptions();
                        }
                    });
                }
                
                if (applyFiltersBtn) {
                    applyFiltersBtn.addEventListener('click', applyAdvancedFilters);
                }
                
                if (clearFiltersBtn) {
                    clearFiltersBtn.addEventListener('click', clearAdvancedFilters);
                }

                // Поля даты
                const dateFromInput = document.getElementById('dateFrom');
                const dateToInput = document.getElementById('dateTo');

                if (dateFromInput) {
                    dateFromInput.addEventListener('change', (e) => {
                        selectedFilters.dateFrom = e.target.value;
                    });
                }

                if (dateToInput) {
                    dateToInput.addEventListener('change', (e) => {
                        selectedFilters.dateTo = e.target.value;
                    });
                }

                // Кнопки навигации для иерархических фильтров
                const backToCategoriesBtn = document.getElementById('backToCategories');
                const backToSubcategoriesBtn = document.getElementById('backToSubcategories');
                
                if (backToCategoriesBtn) {
                    backToCategoriesBtn.addEventListener('click', backToCategories);
                }
                
                if (backToSubcategoriesBtn) {
                    backToSubcategoriesBtn.addEventListener('click', backToSubcategories);
                }
            }
        }
        
        function toggleSelection(imageId) {
            const card = document.querySelector(`[data-image-id="${imageId}"]`);
            const checkbox = card.querySelector('.checkbox');
            
            if (selectedImages.has(imageId)) {
                selectedImages.delete(imageId);
                card.classList.remove('selected');
                checkbox.classList.remove('checked');
            } else {
                selectedImages.add(imageId);
                card.classList.add('selected');
                checkbox.classList.add('checked');
            }
            
            updateSelectedCount();
        }
        
        function selectAll() {
            const visibleCards = getVisibleCards();
            visibleCards.forEach(card => {
                const imageId = card.dataset.imageId;
                selectedImages.add(imageId);
                card.classList.add('selected');
                card.querySelector('.checkbox').classList.add('checked');
            });
            updateSelectedCount();
        }
        
        function clearSelection() {
            selectedImages.clear();
            document.querySelectorAll('.image-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.checkbox').classList.remove('checked');
            });
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const count = selectedImages.size;
            const selectedCountElements = document.querySelectorAll('#selectedCount');
            
            selectedCountElements.forEach(element => {
                element.textContent = count;
            });
            
            const markForTaggingBtn = document.getElementById('markForTaggingBtn');
            const hideImagesBtn = document.getElementById('hideImagesBtn');
            const unmarkBtn = document.getElementById('unmarkBtn');
            const tagImagesBtn = document.getElementById('tagImagesBtn');
            
            if (markForTaggingBtn) markForTaggingBtn.disabled = count === 0;
            if (hideImagesBtn) hideImagesBtn.disabled = count === 0;
            if (unmarkBtn) unmarkBtn.disabled = count === 0;
            if (tagImagesBtn) tagImagesBtn.disabled = count === 0;
        }
        
        function filterImages() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            
            document.querySelectorAll('.image-card').forEach(card => {
                const username = card.dataset.username.toLowerCase();
                const caption = card.dataset.caption.toLowerCase();
                const isSelected = selectedImages.has(card.dataset.imageId);
                
                let matchesSearch = username.includes(searchTerm) || caption.includes(searchTerm);
                let matchesFilter = true;
                
                if (activeFilter === 'selected') {
                    matchesFilter = isSelected;
                } else if (activeFilter === 'unselected') {
                    matchesFilter = !isSelected;
                }
                
                card.style.display = (matchesSearch && matchesFilter) ? 'block' : 'none';
            });
        }
        
        function getVisibleCards() {
            return Array.from(document.querySelectorAll('.image-card')).filter(card => 
                card.style.display !== 'none'
            );
        }
        
        async function markForTagging() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('markForTaggingBtn');
            
            if (!button) {
                console.error('Кнопка markForTaggingBtn не найдена');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // Показываем индикатор загрузки
            button.innerHTML = '⏳ Обработка...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/mark-for-tagging', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ ${result.message}`, 'success');
                    clearSelection();
                    // Перезагружаем страницу, чтобы обновить список
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`❌ Ошибка: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function hideImages() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('hideImagesBtn');
            
            if (!button) {
                console.error('Кнопка hideImagesBtn не найдена');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // Показываем индикатор загрузки
            button.innerHTML = '⏳ Скрытие...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/hide-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ ${result.message}`, 'success');
                    clearSelection();
                    // Перезагружаем страницу, чтобы обновить список
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`❌ Ошибка: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function unmarkForTagging() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('unmarkBtn');
            
            if (!button) {
                console.error('Кнопка unmarkBtn не найдена');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // Показываем индикатор загрузки
            button.innerHTML = '⏳ Обработка...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/unmark-for-tagging', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ ${result.message}`, 'success');
                    clearSelection();
                    // Перезагружаем страницу, чтобы обновить список
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`❌ Ошибка: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function tagImages() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('tagImagesBtn');
            
            if (!button) {
                console.error('Кнопка tagImagesBtn не найдена');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // Показываем индикатор загрузки
            button.innerHTML = '⏳ Теггирование...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/tag-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ ${result.message}`, 'success');
                    clearSelection();
                    // Перезагружаем страницу, чтобы обновить список
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`❌ Ошибка: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // Глобальные переменные для иерархических фильтров
        let hierarchicalFilters = {};
        let currentCategory = null;
        let currentSubcategory = null;
        let selectedFilters = {
            category: null,
            subcategory: null,
            colors: [],
            materials: [],
            styles: [],
            dateFrom: null,
            dateTo: null
        };
        
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter-options');
                const result = await response.json();
                
                if (result.success) {
                    hierarchicalFilters = result.hierarchical_filters;
                    renderCategories();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ Ошибка загрузки фильтров: ${error.message}`, 'error');
            }
        }
        
        function renderCategories() {
            const container = document.getElementById('filterCategories');
            if (!container) return;
            
            container.innerHTML = '';
            
            const categories = Object.keys(hierarchicalFilters).filter(k => k !== '_meta').sort();
            
            categories.forEach(category => {
                const categoryData = hierarchicalFilters[category];
                const imageCount = categoryData._meta?.image_count || 0;
                const subcategoryCount = Object.keys(categoryData).filter(k => k !== '_meta').length;
                
                const categoryElement = document.createElement('div');
                categoryElement.className = 'category-option';
                categoryElement.innerHTML = `
                    <div class="category-info">
                        <h4>${category}</h4>
                        <span class="category-count">(${imageCount} ${imageCount === 1 ? 'изображение' : 'изображений'})</span>
                    </div>
                    <div class="category-arrow">→</div>
                `;
                
                categoryElement.addEventListener('click', () => {
                    selectCategory(category);
                });
                
                container.appendChild(categoryElement);
            });
        }
        
        function selectCategory(category) {
            currentCategory = category;
            selectedFilters.category = category;

            // Показываем подкатегории
            document.getElementById('filterCategories').style.display = 'none';
            document.getElementById('filterSubcategories').style.display = 'block';
            document.getElementById('filterDetails').style.display = 'none';

            // Обновляем заголовок
            document.getElementById('selectedCategoryTitle').textContent = `Категория: ${category}`;

            // Рендерим подкатегории
            renderSubcategories(category);
        }
        
        function renderSubcategories(category) {
            const container = document.getElementById('subcategoryList');
            if (!container) return;
            
            container.innerHTML = '';
            
            const subcategories = Object.keys(hierarchicalFilters[category]).filter(k => k !== '_meta').sort();
            
            subcategories.forEach(subcategory => {
                const filters = hierarchicalFilters[category][subcategory];
                const imageCount = filters._image_count || 0;
                
                const subcategoryElement = document.createElement('div');
                subcategoryElement.className = 'subcategory-option';
                subcategoryElement.innerHTML = `
                    <div class="subcategory-info">
                        <h5>${subcategory}</h5>
                        <span class="subcategory-count">(${imageCount} ${imageCount === 1 ? 'изображение' : 'изображений'})</span>
                    </div>
                    <div class="subcategory-arrow">→</div>
                `;
                
                subcategoryElement.addEventListener('click', () => {
                    selectSubcategory(category, subcategory);
                });
                
                container.appendChild(subcategoryElement);
            });
        }
        
        function selectSubcategory(category, subcategory) {
            currentSubcategory = subcategory;
            selectedFilters.subcategory = subcategory;

            // Показываем детали фильтров
            document.getElementById('filterSubcategories').style.display = 'none';
            document.getElementById('filterDetails').style.display = 'block';

            // Обновляем заголовок
            document.getElementById('selectedSubcategoryTitle').textContent = `${subcategory} - Фильтры`;

            // Рендерим фильтры для этой подкатегории
            renderFilterDetails(category, subcategory);
        }
        
        function renderFilterDetails(category, subcategory) {
            const filters = hierarchicalFilters[category][subcategory];
            
            // Рендерим цвета
            renderFilterSection('colorFilters', filters.colors, 'colors');
            
            // Рендерим материалы
            renderFilterSection('materialFilters', filters.materials, 'materials');
            
            // Рендерим стили
            renderFilterSection('styleFilters', filters.styles, 'styles');
        }
        
        function renderFilterSection(containerId, options, filterType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            // options теперь это объект {name: count}
            Object.entries(options).forEach(([name, count]) => {
                const filterOption = document.createElement('div');
                filterOption.className = 'filter-option';
                filterOption.innerHTML = `
                    <span class="filter-name">${name}</span>
                    <span class="filter-count">(${count})</span>
                `;
                filterOption.dataset.filterType = filterType;
                filterOption.dataset.value = name;
                
                filterOption.addEventListener('click', () => {
                    filterOption.classList.toggle('selected');
                    
                    if (filterOption.classList.contains('selected')) {
                        if (!selectedFilters[filterType].includes(name)) {
                            selectedFilters[filterType].push(name);
                        }
                    } else {
                        selectedFilters[filterType] = selectedFilters[filterType].filter(item => item !== name);
                    }
                });
                
                container.appendChild(filterOption);
            });
        }
        
        function applyAdvancedFilters() {
            // Фильтруем изображения на основе выбранных критериев
            const cards = document.querySelectorAll('.image-card');

            console.log('🔍 Применение фильтров:', selectedFilters);

            let visibleCount = 0;
            cards.forEach(card => {
                let showCard = true;

                // Проверяем соответствие фильтрам
                if (hasActiveFilters()) {
                    showCard = checkImageMatchesFilters(card);
                }

                card.style.display = showCard ? 'block' : 'none';
                if (showCard) visibleCount++;
            });

            console.log(`✅ Показано изображений: ${visibleCount} из ${cards.length}`);
        }
        
        function backToCategories() {
            // Сбрасываем выбранную категорию и подкатегорию
            currentCategory = null;
            currentSubcategory = null;
            selectedFilters.category = null;
            selectedFilters.subcategory = null;

            // Показываем категории
            document.getElementById('filterCategories').style.display = 'grid';
            document.getElementById('filterSubcategories').style.display = 'none';
            document.getElementById('filterDetails').style.display = 'none';
        }
        
        function backToSubcategories() {
            // Сбрасываем выбранную подкатегорию
            currentSubcategory = null;
            selectedFilters.subcategory = null;

            // Показываем подкатегории
            document.getElementById('filterCategories').style.display = 'none';
            document.getElementById('filterSubcategories').style.display = 'block';
            document.getElementById('filterDetails').style.display = 'none';
        }
        
        function checkImageMatchesFilters(card) {
            // Здесь нужно проверить, соответствует ли изображение выбранным фильтрам
            // Для этого нужно добавить data-атрибуты к карточкам с информацией о тегах
            const cardCategories = card.dataset.categories ? card.dataset.categories.split(',') : [];
            const cardObjects = card.dataset.objects ? card.dataset.objects.split(',') : [];
            const cardColors = card.dataset.colors ? card.dataset.colors.split(',') : [];
            const cardMaterials = card.dataset.materials ? card.dataset.materials.split(',') : [];
            const cardStyles = card.dataset.styles ? card.dataset.styles.split(',') : [];

            // Проверяем соответствие выбранной категории
            if (selectedFilters.category) {
                if (!cardCategories.includes(selectedFilters.category)) return false;
            }

            // Проверяем соответствие выбранной подкатегории
            if (selectedFilters.subcategory) {
                if (!cardObjects.includes(selectedFilters.subcategory)) return false;
            }

            // Проверяем соответствие цветам
            if (selectedFilters.colors.length > 0) {
                const hasMatchingColor = selectedFilters.colors.some(color =>
                    cardColors.includes(color)
                );
                if (!hasMatchingColor) return false;
            }

            // Проверяем соответствие материалам
            if (selectedFilters.materials.length > 0) {
                const hasMatchingMaterial = selectedFilters.materials.some(material =>
                    cardMaterials.includes(material)
                );
                if (!hasMatchingMaterial) return false;
            }

            // Проверяем соответствие стилям
            if (selectedFilters.styles.length > 0) {
                const hasMatchingStyle = selectedFilters.styles.some(style =>
                    cardStyles.includes(style)
                );
                if (!hasMatchingStyle) return false;
            }

            // Проверяем соответствие датам
            if (selectedFilters.dateFrom || selectedFilters.dateTo) {
                const cardDate = card.dataset.taggedAt;

                if (!cardDate) {
                    console.log('⚠️ Изображение без даты:', card.dataset.imageId);
                    return false;  // Если у изображения нет даты, не показываем его
                }

                // Извлекаем только дату (YYYY-MM-DD) из ISO строки
                const imageDate = cardDate.split('T')[0];

                console.log('📅 Проверка даты:', {
                    imageId: card.dataset.imageId,
                    imageDate: imageDate,
                    dateFrom: selectedFilters.dateFrom,
                    dateTo: selectedFilters.dateTo,
                    matchFrom: !selectedFilters.dateFrom || imageDate >= selectedFilters.dateFrom,
                    matchTo: !selectedFilters.dateTo || imageDate <= selectedFilters.dateTo
                });

                if (selectedFilters.dateFrom && imageDate < selectedFilters.dateFrom) {
                    return false;
                }

                if (selectedFilters.dateTo && imageDate > selectedFilters.dateTo) {
                    return false;
                }
            }

            return true;
        }
        
        function hasActiveFilters() {
            return selectedFilters.category ||
                   selectedFilters.subcategory ||
                   selectedFilters.colors.length > 0 ||
                   selectedFilters.materials.length > 0 ||
                   selectedFilters.styles.length > 0 ||
                   selectedFilters.dateFrom ||
                   selectedFilters.dateTo;
        }
        
        function clearAdvancedFilters() {
            // Сбрасываем выбранные фильтры
            selectedFilters = {
                category: null,
                subcategory: null,
                colors: [],
                materials: [],
                styles: [],
                dateFrom: null,
                dateTo: null
            };

            currentCategory = null;
            currentSubcategory = null;

            // Убираем выделение с кнопок
            document.querySelectorAll('.filter-option.selected').forEach(option => {
                option.classList.remove('selected');
            });

            // Очищаем поля даты
            const dateFromInput = document.getElementById('dateFrom');
            const dateToInput = document.getElementById('dateTo');
            if (dateFromInput) dateFromInput.value = '';
            if (dateToInput) dateToInput.value = '';

            // Возвращаемся к категориям
            backToCategories();

            // Показываем все изображения
            document.querySelectorAll('.image-card').forEach(card => {
                card.style.display = 'block';
            });

            showNotification('✅ Фильтры сброшены', 'success');
        }
        
        function showNotification(message, type = 'info') {
            // Создаем элемент уведомления
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            // Добавляем стили
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;

            // Цвета в зависимости от типа
            if (type === 'success') {
                notification.style.background = '#28a745';
            } else if (type === 'error') {
                notification.style.background = '#dc3545';
            } else {
                notification.style.background = '#17a2b8';
            }

            // Добавляем анимацию
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            // Добавляем в DOM
            document.body.appendChild(notification);

            // Удаляем через 3 секунды
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ==================== INFINITE SCROLL ====================

        function setupInfiniteScroll() {
            window.addEventListener('scroll', handleScroll);
            console.log(`🔄 Infinite scroll activated for gallery type: ${galleryType}`);
        }

        function handleScroll() {
            // Проверяем, достиг ли пользователь конца страницы
            const scrollPosition = window.innerHeight + window.scrollY;
            const pageHeight = document.documentElement.scrollHeight;

            // Загружаем новые изображения, когда пользователь на 80% прокрутил страницу
            if (scrollPosition >= pageHeight * 0.8 && !isLoading && hasMore) {
                loadMoreImages();
            }
        }

        async function loadMoreImages() {
            if (isLoading || !hasMore) return;

            isLoading = true;
            console.log(`📥 Loading more images... offset: ${currentOffset}, limit: ${BATCH_SIZE}`);

            try {
                const response = await fetch(`/api/load-more-images?gallery_type=${galleryType}&offset=${currentOffset}&limit=${BATCH_SIZE}`);
                const result = await response.json();

                if (result.success) {
                    console.log(`✅ Loaded ${result.images.length} images`);

                    // Добавляем новые изображения в галерею
                    const newCards = [];
                    result.images.forEach(image => {
                        const card = appendImageCard(image);
                        if (card) newCards.push(card);
                    });

                    // Если активны фильтры, применяем их к новым карточкам
                    if (hasActiveFilters()) {
                        console.log('🔍 Применение фильтров к новым изображениям');
                        newCards.forEach(card => {
                            const showCard = checkImageMatchesFilters(card);
                            card.style.display = showCard ? 'block' : 'none';
                        });
                    }

                    // Обновляем offset
                    currentOffset += result.images.length;
                    hasMore = result.has_more;

                    if (!hasMore) {
                        console.log('✅ All images loaded');
                    }
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ Ошибка загрузки: ${error.message}`, 'error');
                console.error('Error loading more images:', error);
            } finally {
                isLoading = false;
            }
        }

        function appendImageCard(image) {
            const gallery = document.getElementById('gallery');

            // Создаем карточку изображения
            const card = document.createElement('div');
            card.className = 'image-card';
            card.dataset.imageId = image._id;
            card.dataset.username = image.username;
            card.dataset.caption = image.caption || '';
            card.dataset.taggedAt = image.timestamp || '';
            card.onclick = function() { toggleSelection(image._id); };

            // Если это галерея с тегами, обрабатываем объекты
            if (galleryType === 'gallery_tagged' && image.ximilar_objects_structured) {
                processTaggedImageData(card, image);
            }

            // HTML содержимое карточки
            let cardHTML = `
                <div class="image-container">
                    <img src="/images/${image.local_filename}" alt="${image.caption || 'Изображение'}" loading="lazy">
                    <div class="checkbox"></div>
                </div>
                <div class="image-info">
                    <div class="username">@${image.username}</div>
                    <div class="stats">
                        <span>❤️ ${image.likes_count || 0}</span>
                        <span>💬 ${image.comments_count || 0}</span>
                    </div>
                    <div class="caption">${image.caption || 'Без описания'}</div>
            `;

            // Добавляем теги, если это галерея оттегированных
            if (galleryType === 'gallery_tagged') {
                cardHTML += renderTags(image);
            }

            cardHTML += '</div>';
            card.innerHTML = cardHTML;

            gallery.appendChild(card);
            return card;
        }

        // Функция нормализации названий подкатегорий (аналог Python функции)
        function normalizeSubcategoryName(subcategory, category) {
            const subcategoryLower = subcategory.toLowerCase();

            const normalizationRules = {
                'Accessories': {
                    'Bags': ['bag', 'handbag', 'tote', 'clutch', 'crossbody', 'purse', 'wallet'],
                    'Hats': ['hat', 'cap', 'beanie', 'fedora'],
                    'Sunglasses': ['sunglass', 'eyewear'],
                    'Belts': ['belt'],
                    'Jewelry': ['jewelry', 'jewellery', 'necklace', 'bracelet', 'ring', 'earring'],
                    'Watches': ['watch'],
                    'Scarves': ['scarf', 'scarves'],
                    'Gloves': ['glove', 'mitten'],
                },
                'Clothing': {
                    'Dresses': ['dress'],
                    'Pants': ['pant', 'trouser', 'jean'],
                    'Skirts': ['skirt'],
                    'Tops': ['top', 'blouse', 'shirt', 't-shirt', 'tank'],
                    'Jackets': ['jacket', 'coat', 'blazer', 'cardigan'],
                    'Shorts': ['short'],
                },
                'Footwear': {
                    'Shoes': ['shoe'],
                    'Sneakers': ['sneaker', 'trainer'],
                    'Boots': ['boot'],
                    'Heels': ['heel', 'stiletto', 'pump'],
                    'Sandals': ['sandal', 'flip-flop'],
                    'Flats': ['flat', 'loafer', 'ballet'],
                }
            };

            // Ищем соответствие в контексте категории
            if (normalizationRules[category]) {
                for (const [baseName, keywords] of Object.entries(normalizationRules[category])) {
                    for (const keyword of keywords) {
                        if (subcategoryLower.includes(keyword)) {
                            return baseName;
                        }
                    }
                }
            }

            // Если не нашли соответствия, возвращаем оригинальное название
            return subcategory;
        }

        function processTaggedImageData(card, image) {
            // Дедупликация объектов по названию (аналогично серверной логике)
            const uniqueCategories = [];
            const uniqueObjects = [];
            const uniqueColors = [];
            const uniqueMaterials = [];
            const uniqueStyles = [];

            if (!image.ximilar_objects_structured) return;

            // Собираем уникальные теги
            image.ximilar_objects_structured.forEach(obj => {
                // Категории
                if (obj.top_category && !uniqueCategories.includes(obj.top_category)) {
                    uniqueCategories.push(obj.top_category);
                }

                // Объекты (подкатегории) - НОРМАЛИЗУЕМ в контексте категории
                if (obj.properties && obj.properties.other_attributes) {
                    let objName = '';
                    const objCategory = obj.top_category || 'Other';

                    if (obj.properties.other_attributes.Subcategory && obj.properties.other_attributes.Subcategory.length > 0) {
                        objName = obj.properties.other_attributes.Subcategory[0].name;
                    } else if (obj.properties.other_attributes.Category && obj.properties.other_attributes.Category.length > 0) {
                        objName = obj.properties.other_attributes.Category[0].name;
                    }

                    if (objName) {
                        // НОРМАЛИЗУЕМ название в контексте категории
                        const normalizedObjName = normalizeSubcategoryName(objName, objCategory);
                        if (!uniqueObjects.includes(normalizedObjName)) {
                            uniqueObjects.push(normalizedObjName);
                        }
                    }
                }

                // Цвета
                if (obj.properties && obj.properties.visual_attributes && obj.properties.visual_attributes.Color) {
                    obj.properties.visual_attributes.Color.forEach(color => {
                        if (!uniqueColors.includes(color.name)) {
                            uniqueColors.push(color.name);
                        }
                    });
                }

                // Материалы
                if (obj.properties && obj.properties.material_attributes && obj.properties.material_attributes.Material) {
                    obj.properties.material_attributes.Material.forEach(material => {
                        if (!uniqueMaterials.includes(material.name)) {
                            uniqueMaterials.push(material.name);
                        }
                    });
                }

                // Стили
                if (obj.properties && obj.properties.style_attributes && obj.properties.style_attributes.Style) {
                    obj.properties.style_attributes.Style.forEach(style => {
                        if (!uniqueStyles.includes(style.name)) {
                            uniqueStyles.push(style.name);
                        }
                    });
                }
            });

            // Добавляем data-атрибуты для фильтрации
            card.dataset.categories = uniqueCategories.join(',');
            card.dataset.objects = uniqueObjects.join(',');
            card.dataset.colors = uniqueColors.join(',');
            card.dataset.materials = uniqueMaterials.join(',');
            card.dataset.styles = uniqueStyles.join(',');
        }

        function renderTags(image) {
            if (!image.ximilar_objects_structured || image.ximilar_objects_structured.length === 0) {
                // Если нет объектно-ориентированной структуры, показываем обычные теги
                if (image.ximilar_tags && image.ximilar_tags.length > 0) {
                    let tagsHTML = '<div class="ximilar-tags">';
                    const tagsToShow = image.ximilar_tags.slice(0, 3);
                    tagsToShow.forEach(tag => {
                        tagsHTML += `<span class="tag">${tag.name}</span>`;
                    });
                    if (image.ximilar_tags.length > 3) {
                        tagsHTML += `<span class="tag-more">+${image.ximilar_tags.length - 3} еще</span>`;
                    }
                    tagsHTML += '</div>';
                    return tagsHTML;
                }
                return '';
            }

            // Группируем объекты по категориям
            const categories = {};
            image.ximilar_objects_structured.forEach(obj => {
                const category = obj.top_category || 'other';
                if (!categories[category]) {
                    categories[category] = [];
                }

                let objInfo = '';
                if (obj.properties) {
                    // Получаем название объекта
                    if (obj.properties.other_attributes && obj.properties.other_attributes.Subcategory && obj.properties.other_attributes.Subcategory.length > 0) {
                        objInfo = obj.properties.other_attributes.Subcategory[0].name;
                    } else if (obj.properties.other_attributes && obj.properties.other_attributes.Category && obj.properties.other_attributes.Category.length > 0) {
                        objInfo = obj.properties.other_attributes.Category[0].name;
                    } else {
                        objInfo = obj.name;
                    }

                    // Добавляем атрибуты
                    const attrs = [];
                    if (obj.properties.visual_attributes && obj.properties.visual_attributes.Color && obj.properties.visual_attributes.Color.length > 0) {
                        attrs.push(obj.properties.visual_attributes.Color[0].name);
                    }
                    if (obj.properties.material_attributes && obj.properties.material_attributes.Material && obj.properties.material_attributes.Material.length > 0) {
                        attrs.push(obj.properties.material_attributes.Material[0].name);
                    }
                    if (obj.properties.style_attributes && obj.properties.style_attributes.Style && obj.properties.style_attributes.Style.length > 0) {
                        attrs.push(obj.properties.style_attributes.Style[0].name);
                    }

                    if (attrs.length > 0) {
                        objInfo += ` (${attrs.join(', ')})`;
                    }
                }

                categories[category].push(objInfo);
            });

            // Рендерим теги
            let tagsHTML = '<div class="ximilar-tags">';
            for (const [category, objects] of Object.entries(categories)) {
                tagsHTML += `
                    <div class="category-group">
                        <span class="category-name">${category}:</span>
                        <span class="category-objects">${objects.join(', ')}</span>
                    </div>
                `;
            }
            tagsHTML += '</div>';

            return tagsHTML;
        }
    </script>
</body>
</html>
