<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Галерея изображений</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .navigation {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: white;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #667eea;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-orange {
            background: #ff6b35;
            color: white;
        }
        
        .btn-orange:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }
        
        .ximilar-tags {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #ff6b35;
        }
        
        .ximilar-tags strong {
            color: #495057;
            font-size: 12px;
            display: block;
            margin-bottom: 4px;
        }
        
        .tag {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin: 2px 2px 2px 0;
            font-weight: 500;
        }
        
        .tag-more {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin: 2px 2px 2px 0;
            font-weight: 500;
        }
        
        .advanced-filters {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-option {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .filter-option:hover {
            background: #e9ecef;
        }
        
        .filter-option.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        
        .category-group {
            margin: 2px 0;
            padding: 3px 6px;
            background: #ffffff;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-size: 10px;
        }
        
        .category-name {
            font-weight: 600;
            color: #495057;
            text-transform: capitalize;
        }
        
        .category-objects {
            color: #6c757d;
            margin-left: 4px;
        }
        
        .gallery {
            padding: 30px;
            column-count: 4;
            column-gap: 25px;
        }
        
        @media (max-width: 1200px) {
            .gallery {
                column-count: 3;
            }
        }
        
        @media (max-width: 800px) {
            .gallery {
                column-count: 2;
            }
        }
        
        @media (max-width: 500px) {
            .gallery {
                column-count: 1;
            }
        }
        
        .image-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border: 3px solid transparent;
            break-inside: avoid;
            margin-bottom: 25px;
            display: inline-block;
            width: 100%;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .image-card.selected {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .image-container {
            position: relative;
            overflow: hidden;
        }
        
        .image-container img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s;
        }
        
        .image-card:hover .image-container img {
            transform: scale(1.05);
        }
        
        .checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 25px;
            height: 25px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #667eea;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .checkbox.checked {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        .image-info {
            padding: 20px;
        }
        
        .username {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .caption {
            font-size: 0.9em;
            color: #495057;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .selected-count {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .no-images {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.2em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.1em;
        }
        
        @media (max-width: 768px) {
            .gallery {
                column-count: 2;
                column-gap: 15px;
                padding: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🖼️ Галерея изображений</h1>
            {% if current_page == 'gallery' %}
                <p>Выберите изображения для теггирования</p>
            {% elif current_page == 'gallery_to_tag' %}
                <p>Изображения, выбранные для теггирования</p>
            {% else %}
                <p>Изображения с тегами Ximilar</p>
            {% endif %}
            
            <!-- Навигация -->
            <div class="navigation">
                <a href="/gallery" class="nav-btn {% if current_page == 'gallery' %}active{% endif %}">
                    📷 Галерея
                </a>
                <a href="/gallery_to_tag" class="nav-btn {% if current_page == 'gallery_to_tag' %}active{% endif %}">
                    🏷️ Выбрано для теггирования
                </a>
                <a href="/gallery_tagged" class="nav-btn {% if current_page == 'gallery_tagged' %}active{% endif %}">
                    ✅ Оттегированы
                </a>
            </div>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="🔍 Поиск по подписи или имени пользователя...">
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Все</button>
                <button class="filter-btn" data-filter="selected">Выбранные</button>
                <button class="filter-btn" data-filter="unselected">Не выбранные</button>
                {% if current_page == 'gallery_tagged' %}
                <button class="filter-btn" id="toggleAdvancedFilters">🔍 Расширенные фильтры</button>
                {% endif %}
            </div>
            
            {% if current_page == 'gallery_tagged' %}
            <div class="advanced-filters" id="advancedFilters" style="display: none;">
                <div class="filter-section">
                    <h4>Категории</h4>
                    <div class="filter-options" id="categoryFilters"></div>
                </div>
                
                <div class="filter-section">
                    <h4>Объекты</h4>
                    <div class="filter-options" id="objectFilters"></div>
                </div>
                
                <div class="filter-section">
                    <h4>Цвета</h4>
                    <div class="filter-options" id="colorFilters"></div>
                </div>
                
                <div class="filter-section">
                    <h4>Материалы</h4>
                    <div class="filter-options" id="materialFilters"></div>
                </div>
                
                <div class="filter-section">
                    <h4>Стили</h4>
                    <div class="filter-options" id="styleFilters"></div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-primary" id="applyFiltersBtn">Применить фильтры</button>
                    <button class="btn btn-secondary" id="clearFiltersBtn">Сбросить</button>
                </div>
            </div>
            {% endif %}
            
            <div class="action-buttons">
                {% if current_page == 'gallery' %}
                    <button class="btn btn-primary" id="selectAllBtn">Выбрать все</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">Очистить выбор</button>
                    <button class="btn btn-primary" id="markForTaggingBtn" disabled>
                        Отметить для теггирования
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                {% elif current_page == 'gallery_to_tag' %}
                    <button class="btn btn-primary" id="selectAllBtn">Выбрать все</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">Очистить выбор</button>
                    <button class="btn btn-secondary" id="unmarkBtn" disabled>
                        Убрать из теггирования
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                    <button class="btn btn-orange" id="tagImagesBtn" disabled>
                        🏷️ Теггировать
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                {% else %}
                    <button class="btn btn-primary" id="selectAllBtn">Выбрать все</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">Очистить выбор</button>
                {% endif %}
            </div>
        </div>
        
        <div class="gallery" id="gallery">
            {% if images %}
                {% for image in images %}
                <div class="image-card" 
                     data-image-id="{{ image._id }}" 
                     data-username="{{ image.username }}" 
                     data-caption="{{ image.caption or '' }}"
                     {% if current_page == 'gallery_tagged' and image.ximilar_objects_structured %}
                     data-categories="{% for obj in image.ximilar_objects_structured %}{{ obj.top_category or '' }}{% if not loop.last %},{% endif %}{% endfor %}"
                     data-objects="{% for obj in image.ximilar_objects_structured %}{% if obj.properties.other_attributes.Subcategory %}{{ obj.properties.other_attributes.Subcategory[0].name }}{% elif obj.properties.other_attributes.Category %}{{ obj.properties.other_attributes.Category[0].name }}{% endif %}{% if not loop.last %},{% endif %}{% endfor %}"
                     data-colors="{% for obj in image.ximilar_objects_structured %}{% if obj.properties.visual_attributes.Color %}{{ obj.properties.visual_attributes.Color[0].name }}{% endif %}{% if not loop.last %},{% endif %}{% endfor %}"
                     data-materials="{% for obj in image.ximilar_objects_structured %}{% if obj.properties.material_attributes.Material %}{{ obj.properties.material_attributes.Material[0].name }}{% endif %}{% if not loop.last %},{% endif %}{% endfor %}"
                     data-styles="{% for obj in image.ximilar_objects_structured %}{% if obj.properties.style_attributes.Style %}{{ obj.properties.style_attributes.Style[0].name }}{% endif %}{% if not loop.last %},{% endif %}{% endfor %}"
                     {% endif %}>
                    <div class="image-container">
                        <img src="/images/{{ image.local_filename }}" alt="{{ image.caption or 'Изображение' }}" loading="lazy">
                        <div class="checkbox" onclick="toggleSelection('{{ image._id }}')"></div>
                    </div>
                    <div class="image-info">
                        <div class="username">@{{ image.username }}</div>
                        <div class="stats">
                            <span>❤️ {{ image.likes_count or 0 }}</span>
                            <span>💬 {{ image.comments_count or 0 }}</span>
                        </div>
                        <div class="caption">{{ image.caption or 'Без описания' }}</div>
                        {% if current_page == 'gallery_tagged' and image.ximilar_objects_structured %}
                            <div class="ximilar-tags">
                                {% set categories = {} %}
                                {% for obj in image.ximilar_objects_structured %}
                                    {% set category = obj.top_category or 'other' %}
                                    {% if category not in categories %}
                                        {% set _ = categories.update({category: []}) %}
                                    {% endif %}
                                    
                                    {% set obj_info = '' %}
                                    {% set color = '' %}
                                    {% set material = '' %}
                                    {% set style = '' %}
                                    
                                    {% if obj.properties %}
                                        {# Получаем конкретное название объекта из Subcategory #}
                                        {% if obj.properties.other_attributes and obj.properties.other_attributes.Subcategory %}
                                            {% set subcategory_list = obj.properties.other_attributes.Subcategory %}
                                            {% if subcategory_list and subcategory_list|length > 0 %}
                                                {% set obj_info = subcategory_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# Если нет Subcategory, используем Category #}
                                        {% if not obj_info and obj.properties.other_attributes and obj.properties.other_attributes.Category %}
                                            {% set category_list = obj.properties.other_attributes.Category %}
                                            {% if category_list and category_list|length > 0 %}
                                                {% set obj_info = category_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# Если ничего не найдено, используем name #}
                                        {% if not obj_info %}
                                            {% set obj_info = obj.name %}
                                        {% endif %}
                                        
                                        {# Получаем цвет из visual_attributes.Color #}
                                        {% if obj.properties.visual_attributes and obj.properties.visual_attributes.Color %}
                                            {% set color_list = obj.properties.visual_attributes.Color %}
                                            {% if color_list and color_list|length > 0 %}
                                                {% set color = color_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# Получаем материал из material_attributes.Material #}
                                        {% if obj.properties.material_attributes and obj.properties.material_attributes.Material %}
                                            {% set material_list = obj.properties.material_attributes.Material %}
                                            {% if material_list and material_list|length > 0 %}
                                                {% set material = material_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# Получаем стиль из style_attributes.Style #}
                                        {% if obj.properties.style_attributes and obj.properties.style_attributes.Style %}
                                            {% set style_list = obj.properties.style_attributes.Style %}
                                            {% if style_list and style_list|length > 0 %}
                                                {% set style = style_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {% if color or material or style %}
                                            {% set properties = [] %}
                                            {% if color %}{% set _ = properties.append(color) %}{% endif %}
                                            {% if material %}{% set _ = properties.append(material) %}{% endif %}
                                            {% if style %}{% set _ = properties.append(style) %}{% endif %}
                                            {% set obj_info = obj_info + ' (' + properties|join(', ') + ')' %}
                                        {% endif %}
                                    {% endif %}
                                    
                                    {% set _ = categories[category].append(obj_info) %}
                                {% endfor %}
                                
                                {% for category, objects in categories.items() %}
                                    <div class="category-group">
                                        <span class="category-name">{{ category }}:</span>
                                        <span class="category-objects">{{ objects|join(', ') }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% elif current_page == 'gallery_tagged' and image.ximilar_tags %}
                            <div class="ximilar-tags">
                                {% for tag in image.ximilar_tags[:3] %}
                                    <span class="tag">{{ tag.name }}</span>
                                {% endfor %}
                                {% if image.ximilar_tags|length > 3 %}
                                    <span class="tag-more">+{{ image.ximilar_tags|length - 3 }} еще</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-images">
                    <h3>📷 Изображения не найдены</h3>
                    <p>Сначала выполните парсинг аккаунтов Instagram</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        let selectedImages = new Set();
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectedCount();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Поиск
            document.getElementById('searchInput').addEventListener('input', filterImages);
            
            // Фильтры
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterImages();
                });
            });
            
            // Кнопки действий
            const selectAllBtn = document.getElementById('selectAllBtn');
            const clearSelectionBtn = document.getElementById('clearSelectionBtn');
            const markForTaggingBtn = document.getElementById('markForTaggingBtn');
            const unmarkBtn = document.getElementById('unmarkBtn');
            const tagImagesBtn = document.getElementById('tagImagesBtn');
            
            if (selectAllBtn) selectAllBtn.addEventListener('click', selectAll);
            if (clearSelectionBtn) clearSelectionBtn.addEventListener('click', clearSelection);
            if (markForTaggingBtn) markForTaggingBtn.addEventListener('click', markForTagging);
            if (unmarkBtn) unmarkBtn.addEventListener('click', unmarkForTagging);
            if (tagImagesBtn) tagImagesBtn.addEventListener('click', tagImages);
            
            // Расширенные фильтры для страницы оттегированных
            if ('{{ current_page }}' === 'gallery_tagged') {
                const toggleAdvancedFiltersBtn = document.getElementById('toggleAdvancedFilters');
                const advancedFilters = document.getElementById('advancedFilters');
                const applyFiltersBtn = document.getElementById('applyFiltersBtn');
                const clearFiltersBtn = document.getElementById('clearFiltersBtn');
                
                if (toggleAdvancedFiltersBtn && advancedFilters) {
                    toggleAdvancedFiltersBtn.addEventListener('click', () => {
                        if (advancedFilters.style.display === 'none') {
                            advancedFilters.style.display = 'block';
                            toggleAdvancedFiltersBtn.textContent = '🔍 Скрыть фильтры';
                            loadFilterOptions();
                        } else {
                            advancedFilters.style.display = 'none';
                            toggleAdvancedFiltersBtn.textContent = '🔍 Расширенные фильтры';
                        }
                    });
                }
                
                if (applyFiltersBtn) {
                    applyFiltersBtn.addEventListener('click', applyAdvancedFilters);
                }
                
                if (clearFiltersBtn) {
                    clearFiltersBtn.addEventListener('click', clearAdvancedFilters);
                }
            }
        }
        
        function toggleSelection(imageId) {
            const card = document.querySelector(`[data-image-id="${imageId}"]`);
            const checkbox = card.querySelector('.checkbox');
            
            if (selectedImages.has(imageId)) {
                selectedImages.delete(imageId);
                card.classList.remove('selected');
                checkbox.classList.remove('checked');
            } else {
                selectedImages.add(imageId);
                card.classList.add('selected');
                checkbox.classList.add('checked');
            }
            
            updateSelectedCount();
        }
        
        function selectAll() {
            const visibleCards = getVisibleCards();
            visibleCards.forEach(card => {
                const imageId = card.dataset.imageId;
                selectedImages.add(imageId);
                card.classList.add('selected');
                card.querySelector('.checkbox').classList.add('checked');
            });
            updateSelectedCount();
        }
        
        function clearSelection() {
            selectedImages.clear();
            document.querySelectorAll('.image-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.checkbox').classList.remove('checked');
            });
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const count = selectedImages.size;
            const selectedCountElements = document.querySelectorAll('#selectedCount');
            
            selectedCountElements.forEach(element => {
                element.textContent = count;
            });
            
            const markForTaggingBtn = document.getElementById('markForTaggingBtn');
            const unmarkBtn = document.getElementById('unmarkBtn');
            const tagImagesBtn = document.getElementById('tagImagesBtn');
            
            if (markForTaggingBtn) markForTaggingBtn.disabled = count === 0;
            if (unmarkBtn) unmarkBtn.disabled = count === 0;
            if (tagImagesBtn) tagImagesBtn.disabled = count === 0;
        }
        
        function filterImages() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            
            document.querySelectorAll('.image-card').forEach(card => {
                const username = card.dataset.username.toLowerCase();
                const caption = card.dataset.caption.toLowerCase();
                const isSelected = selectedImages.has(card.dataset.imageId);
                
                let matchesSearch = username.includes(searchTerm) || caption.includes(searchTerm);
                let matchesFilter = true;
                
                if (activeFilter === 'selected') {
                    matchesFilter = isSelected;
                } else if (activeFilter === 'unselected') {
                    matchesFilter = !isSelected;
                }
                
                card.style.display = (matchesSearch && matchesFilter) ? 'block' : 'none';
            });
        }
        
        function getVisibleCards() {
            return Array.from(document.querySelectorAll('.image-card')).filter(card => 
                card.style.display !== 'none'
            );
        }
        
        async function markForTagging() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('markForTaggingBtn');
            
            if (!button) {
                console.error('Кнопка markForTaggingBtn не найдена');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // Показываем индикатор загрузки
            button.innerHTML = '⏳ Обработка...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/mark-for-tagging', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ ${result.message}`, 'success');
                    clearSelection();
                    // Перезагружаем страницу, чтобы обновить список
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`❌ Ошибка: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function unmarkForTagging() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('unmarkBtn');
            
            if (!button) {
                console.error('Кнопка unmarkBtn не найдена');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // Показываем индикатор загрузки
            button.innerHTML = '⏳ Обработка...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/unmark-for-tagging', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ ${result.message}`, 'success');
                    clearSelection();
                    // Перезагружаем страницу, чтобы обновить список
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`❌ Ошибка: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function tagImages() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('tagImagesBtn');
            
            if (!button) {
                console.error('Кнопка tagImagesBtn не найдена');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // Показываем индикатор загрузки
            button.innerHTML = '⏳ Теггирование...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/tag-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ ${result.message}`, 'success');
                    clearSelection();
                    // Перезагружаем страницу, чтобы обновить список
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`❌ Ошибка: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // Глобальные переменные для фильтров
        let filterOptions = {};
        let selectedFilters = {
            categories: [],
            objects: [],
            colors: [],
            materials: [],
            styles: []
        };
        
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter-options');
                const result = await response.json();
                
                if (result.success) {
                    filterOptions = result.filter_options;
                    renderFilterOptions();
                } else {
                    showNotification(`❌ ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`❌ Ошибка загрузки фильтров: ${error.message}`, 'error');
            }
        }
        
        function renderFilterOptions() {
            // Категории
            renderFilterSection('categoryFilters', filterOptions.categories, 'categories');
            
            // Объекты
            renderFilterSection('objectFilters', filterOptions.objects, 'objects');
            
            // Цвета
            renderFilterSection('colorFilters', filterOptions.colors, 'colors');
            
            // Материалы
            renderFilterSection('materialFilters', filterOptions.materials, 'materials');
            
            // Стили
            renderFilterSection('styleFilters', filterOptions.styles, 'styles');
        }
        
        function renderFilterSection(containerId, options, filterType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            options.forEach(option => {
                const filterOption = document.createElement('div');
                filterOption.className = 'filter-option';
                filterOption.textContent = option;
                filterOption.dataset.filterType = filterType;
                filterOption.dataset.value = option;
                
                filterOption.addEventListener('click', () => {
                    filterOption.classList.toggle('selected');
                    
                    if (filterOption.classList.contains('selected')) {
                        if (!selectedFilters[filterType].includes(option)) {
                            selectedFilters[filterType].push(option);
                        }
                    } else {
                        selectedFilters[filterType] = selectedFilters[filterType].filter(item => item !== option);
                    }
                });
                
                container.appendChild(filterOption);
            });
        }
        
        function applyAdvancedFilters() {
            // Фильтруем изображения на основе выбранных критериев
            const cards = document.querySelectorAll('.image-card');
            
            cards.forEach(card => {
                let showCard = true;
                
                // Проверяем соответствие фильтрам
                if (hasActiveFilters()) {
                    showCard = checkImageMatchesFilters(card);
                }
                
                card.style.display = showCard ? 'block' : 'none';
            });
            
            // Обновляем счетчик
            const visibleCards = document.querySelectorAll('.image-card[style*="block"], .image-card:not([style*="none"])');
            showNotification(`✅ Показано ${visibleCards.length} изображений`, 'success');
        }
        
        function checkImageMatchesFilters(card) {
            // Здесь нужно проверить, соответствует ли изображение выбранным фильтрам
            // Для этого нужно добавить data-атрибуты к карточкам с информацией о тегах
            const cardCategories = card.dataset.categories ? card.dataset.categories.split(',') : [];
            const cardObjects = card.dataset.objects ? card.dataset.objects.split(',') : [];
            const cardColors = card.dataset.colors ? card.dataset.colors.split(',') : [];
            const cardMaterials = card.dataset.materials ? card.dataset.materials.split(',') : [];
            const cardStyles = card.dataset.styles ? card.dataset.styles.split(',') : [];
            
            // Проверяем соответствие категориям
            if (selectedFilters.categories.length > 0) {
                const hasMatchingCategory = selectedFilters.categories.some(cat => 
                    cardCategories.includes(cat)
                );
                if (!hasMatchingCategory) return false;
            }
            
            // Проверяем соответствие объектам
            if (selectedFilters.objects.length > 0) {
                const hasMatchingObject = selectedFilters.objects.some(obj => 
                    cardObjects.includes(obj)
                );
                if (!hasMatchingObject) return false;
            }
            
            // Проверяем соответствие цветам
            if (selectedFilters.colors.length > 0) {
                const hasMatchingColor = selectedFilters.colors.some(color => 
                    cardColors.includes(color)
                );
                if (!hasMatchingColor) return false;
            }
            
            // Проверяем соответствие материалам
            if (selectedFilters.materials.length > 0) {
                const hasMatchingMaterial = selectedFilters.materials.some(material => 
                    cardMaterials.includes(material)
                );
                if (!hasMatchingMaterial) return false;
            }
            
            // Проверяем соответствие стилям
            if (selectedFilters.styles.length > 0) {
                const hasMatchingStyle = selectedFilters.styles.some(style => 
                    cardStyles.includes(style)
                );
                if (!hasMatchingStyle) return false;
            }
            
            return true;
        }
        
        function hasActiveFilters() {
            return selectedFilters.categories.length > 0 || 
                   selectedFilters.objects.length > 0 || 
                   selectedFilters.colors.length > 0 || 
                   selectedFilters.materials.length > 0 || 
                   selectedFilters.styles.length > 0;
        }
        
        function clearAdvancedFilters() {
            // Сбрасываем выбранные фильтры
            selectedFilters = {
                categories: [],
                objects: [],
                colors: [],
                materials: [],
                styles: []
            };
            
            // Убираем выделение с кнопок
            document.querySelectorAll('.filter-option.selected').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Показываем все изображения
            document.querySelectorAll('.image-card').forEach(card => {
                card.style.display = 'block';
            });
            
            showNotification('✅ Фильтры сброшены', 'success');
        }
        
        function showNotification(message, type = 'info') {
            // Создаем элемент уведомления
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Добавляем стили
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            
            // Цвета в зависимости от типа
            if (type === 'success') {
                notification.style.background = '#28a745';
            } else if (type === 'error') {
                notification.style.background = '#dc3545';
            } else {
                notification.style.background = '#17a2b8';
            }
            
            // Добавляем анимацию
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // Добавляем в DOM
            document.body.appendChild(notification);
            
            // Удаляем через 3 секунды
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
