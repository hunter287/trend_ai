<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .navigation {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: white;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            transition: border-radius 0.3s ease;
        }

        .controls.filters-open {
            border-bottom: none;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .bloggers-filter {
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
            padding: 0;
            margin: 0 30px 20px 30px;
            border: 1px solid #dee2e6;
            border-top: none;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out, padding 0.4s ease-out;
        }

        .bloggers-filter.open {
            max-height: 400px;
            opacity: 1;
            padding: 20px;
        }

        .bloggers-filter h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }

        .bloggers-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .bloggers-list::-webkit-scrollbar {
            width: 8px;
        }

        .bloggers-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .bloggers-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .blogger-option {
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .blogger-option:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .blogger-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .blogger-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #667eea;
            border-radius: 4px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .blogger-option.selected .blogger-checkbox {
            background: white;
            border-color: white;
        }

        .blogger-option.selected .blogger-checkbox::after {
            content: '‚úì';
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
        }

        .blogger-name {
            flex: 1;
            font-weight: 500;
            font-size: 14px;
        }

        .blogger-count {
            font-size: 12px;
            color: #6c757d;
            margin-left: 8px;
        }

        .blogger-option.selected .blogger-count {
            color: rgba(255, 255, 255, 0.8);
        }

        .blogger-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-orange {
            background: #ff6b35;
            color: white;
        }
        
        .btn-orange:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }
        
        .ximilar-tags {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #ff6b35;
        }
        
        .ximilar-tags strong {
            color: #495057;
            font-size: 12px;
            display: block;
            margin-bottom: 4px;
        }
        
        .tag {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin: 2px 2px 2px 0;
            font-weight: 500;
        }
        
        .tag-more {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin: 2px 2px 2px 0;
            font-weight: 500;
        }
        
        .advanced-filters {
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
            padding: 0;
            margin: 0 30px 20px 30px;
            border: 1px solid #dee2e6;
            border-top: none;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0);
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out, padding 0.4s ease-out, box-shadow 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .advanced-filters.open {
            max-height: 600px;
            opacity: 1;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .hierarchical-filters {
            flex: 1;
            overflow-y: auto;
            min-height: 200px;
            max-height: 400px;
            margin-bottom: 20px;
            padding-right: 10px;
        }

        .date-filter-section,
        .confidence-filter-section {
            flex-shrink: 0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞ confidence */
        #confidenceSlider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: linear-gradient(to right, #e9ecef 0%, #667eea 100%);
            border-radius: 3px;
            outline: none;
        }

        #confidenceSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #confidenceSlider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #confidenceSlider:disabled,
        #confidenceInput:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hierarchical-filters::-webkit-scrollbar {
            width: 8px;
        }

        .hierarchical-filters::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .hierarchical-filters::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .hierarchical-filters::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .filter-categories, .filter-subcategories, .filter-details {
            transition: all 0.3s ease;
        }

        .filter-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .subcategory-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }
        
        .category-option, .subcategory-option {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-option:hover, .subcategory-option:hover {
            background: #e9ecef;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .category-info, .subcategory-info {
            flex: 1;
        }
        
        .category-info h4 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }
        
        .subcategory-info h5 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .category-count, .subcategory-count {
            font-size: 12px;
            color: #6c757d;
        }
        
        .category-arrow, .subcategory-arrow {
            font-size: 18px;
            color: #007bff;
            font-weight: bold;
        }
        
        .subcategory-header, .subsubcategory-header, .filter-details-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .subsubcategory-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .subsubcategory-option {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .subsubcategory-option:hover {
            background: #e9ecef;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .subsubcategory-info {
            flex: 1;
        }

        .subsubcategory-info h5 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }

        .subsubcategory-count {
            font-size: 12px;
            color: #6c757d;
        }

        .subsubcategory-arrow {
            font-size: 18px;
            color: #007bff;
            font-weight: bold;
        }

        .btn-back {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .btn-back:hover {
            background: #5a6268;
        }
        
        .filter-details-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .filter-section h5 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .filter-name {
            flex: 1;
        }
        
        .filter-count {
            color: #6c757d;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .filter-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }
        
        .filter-option:hover {
            background: #e9ecef;
        }
        
        .filter-option.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
            flex-shrink: 0;
            margin-top: auto;
        }
        
        .category-group {
            margin: 2px 0;
            padding: 3px 6px;
            background: #ffffff;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-size: 10px;
        }
        
        .category-name {
            font-weight: 600;
            color: #495057;
            text-transform: capitalize;
        }
        
        .category-objects {
            color: #6c757d;
            margin-left: 4px;
        }
        
        .gallery {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            align-items: start;
        }
        
        @media (max-width: 1200px) {
            .gallery {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }
        }
        
        @media (max-width: 800px) {
            .gallery {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
            }
        }
        
        @media (max-width: 500px) {
            .gallery {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        .image-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border: 3px solid transparent;
            width: 100%;
            height: fit-content;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .image-card.selected {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .image-container {
            position: relative;
            overflow: hidden;
        }
        
        .image-container img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s;
        }
        
        .image-card:hover .image-container img {
            transform: scale(1.05);
        }
        
        .checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 25px;
            height: 25px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #667eea;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .checkbox.checked {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        .image-info {
            padding: 20px;
        }
        
        .username {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }

        .post-date {
            font-size: 0.85em;
            color: #868e96;
            margin-bottom: 8px;
            font-style: italic;
        }

        .caption {
            font-size: 0.9em;
            color: #495057;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .selected-count {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .no-images {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.2em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.1em;
        }
        
        @media (max-width: 768px) {
            .gallery {
                padding: 20px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .filter-categories,
            .subcategory-list {
                grid-template-columns: 1fr;
            }

            .filter-options {
                grid-template-columns: 1fr;
            }

            .advanced-filters {
                margin: 0 15px 15px 15px;
            }
        }

        /* –°—á–µ—Ç—á–∏–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        .images-counter {
            padding: 5px 0;
            color: #495057;
            text-align: left;
            font-size: 0.9em;
            font-weight: 400;
            margin: 10px 30px 15px 30px;
        }

        .images-counter .count {
            font-weight: 600;
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Trend Watching</h1>
            {% if current_page == 'gallery' %}
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            {% elif current_page == 'gallery_to_tag' %}
                <p>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            {% else %}
                <p>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Ç–µ–≥–∞–º–∏ Ximilar</p>
            {% endif %}
            
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
            <div class="navigation">
                <a href="/" class="nav-btn">
                    üîç –ü–∞—Ä—Å–µ—Ä
                </a>
                <a href="/gallery" class="nav-btn {% if current_page == 'gallery' %}active{% endif %}">
                    üì∑ –ì–∞–ª–µ—Ä–µ—è
                </a>
                <a href="/gallery_to_tag" class="nav-btn {% if current_page == 'gallery_to_tag' %}active{% endif %}">
                    üè∑Ô∏è –í—ã–±—Ä–∞–Ω–æ –¥–ª—è —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                </a>
                <a href="/gallery_tagged" class="nav-btn {% if current_page == 'gallery_tagged' %}active{% endif %}">
                    ‚úÖ –û—Ç—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω—ã
                </a>
                <a href="/gallery_hidden" class="nav-btn {% if current_page == 'gallery_hidden' %}active{% endif %}">
                    üôà –°–∫—Ä—ã—Ç—ã–µ
                </a>
                <a href="/analytics" class="nav-btn">
                    üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                </a>
            </div>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ø–æ–¥–ø–∏—Å–∏ –∏–ª–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
                <button class="filter-btn" data-filter="selected">–í—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                <button class="filter-btn" data-filter="unselected">–ù–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                <button class="filter-btn" id="toggleBloggersFilter">üë• –§–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–≥–µ—Ä–∞–º</button>
                {% if current_page == 'gallery_tagged' %}
                <button class="filter-btn" id="toggleAdvancedFilters">üîç –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
                {% else %}
                <button class="filter-btn" id="toggleDateFilter">üìÖ –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º</button>
                {% endif %}
            </div>
            
            <div class="action-buttons">
                {% if current_page == 'gallery' %}
                    <button class="btn btn-primary" id="selectAllBtn">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
                    <button class="btn btn-primary" id="markForTaggingBtn" disabled>
                        –û—Ç–º–µ—Ç–∏—Ç—å –¥–ª—è —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                    <button class="btn btn-secondary" id="hideImagesBtn" disabled>
                        üëÅÔ∏è –°–∫—Ä—ã—Ç—å
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                {% elif current_page == 'gallery_to_tag' %}
                    <button class="btn btn-primary" id="selectAllBtn">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
                    <button class="btn btn-secondary" id="unmarkBtn" disabled>
                        –£–±—Ä–∞—Ç—å –∏–∑ —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                    <button class="btn btn-orange" id="tagImagesBtn" disabled>
                        üè∑Ô∏è –¢–µ–≥–≥–∏—Ä–æ–≤–∞—Ç—å
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                {% elif current_page == 'gallery_hidden' %}
                    <button class="btn btn-primary" id="selectAllBtn">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
                    <button class="btn btn-primary" id="unhideImagesBtn" disabled>
                        üëÅÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                {% else %}
                    <button class="btn btn-primary" id="selectAllBtn">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
                {% endif %}
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–≥–µ—Ä–∞–º (–¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü) -->
        <div class="bloggers-filter" id="bloggersFilter">
            <h4>üë• –í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–≥–µ—Ä–æ–≤</h4>
            <div class="bloggers-list" id="bloggersList">
                <!-- –ë–ª–æ–≥–µ—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <div class="blogger-actions">
                <button class="btn btn-primary" id="applyBloggersFilterBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" id="clearBloggersFilterBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <button class="btn btn-secondary" id="selectAllBloggersBtn">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö</button>
            </div>
        </div>

        {% if current_page != 'gallery_tagged' %}
        <!-- –ü—Ä–æ—Å—Ç–æ–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º –¥–ª—è gallery –∏ gallery_to_tag -->
        <div class="advanced-filters" id="dateFilters">
            <div class="date-filter-section">
                <h4 style="margin: 0 0 15px 0; color: #495057; font-size: 16px; font-weight: 600;">üìÖ –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Instagram</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label for="simpleDateFrom" style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px; font-weight: 600;">–û—Ç:</label>
                        <input type="date" id="simpleDateFrom" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label for="simpleDateTo" style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px; font-weight: 600;">–î–æ:</label>
                        <input type="date" id="simpleDateTo" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="dateSortOrder" style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px; font-weight: 600;">üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                    <select id="dateSortOrder" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px; background: white;">
                        <option value="desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                        <option value="asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="applyDateFilterBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button class="btn btn-secondary" id="clearDateFilterBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>
        </div>
        {% endif %}

        {% if current_page == 'gallery_tagged' %}
        <div class="advanced-filters" id="advancedFilters">
            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º -->
            <div class="date-filter-section" style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #dee2e6;">
                <h4 style="margin: 0 0 15px 0; color: #495057; font-size: 16px; font-weight: 600;">üìÖ –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label for="dateFrom" style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px; font-weight: 600;">–û—Ç:</label>
                        <input type="date" id="dateFrom" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label for="dateTo" style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px; font-weight: 600;">–î–æ:</label>
                        <input type="date" id="dateTo" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
                <div>
                    <label for="taggedDateSortOrder" style="display: block; margin-bottom: 5px; color: #495057; font-size: 13px; font-weight: 600;">üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                    <select id="taggedDateSortOrder" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px; background: white;">
                        <option value="desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                        <option value="asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                    </select>
                </div>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä –ø–æ confidence -->
            <div class="confidence-filter-section" style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #dee2e6;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <input type="checkbox" id="useConfidenceFilter" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="useConfidenceFilter" style="margin: 0; color: #495057; font-size: 14px; font-weight: 600; cursor: pointer;">
                        –£—á–∏—Ç—ã–≤–∞—Ç—å Confidence –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–µ–≥–æ–≤
                    </label>
                </div>

                <div id="confidenceControls" style="margin-left: 28px; display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 13px; color: #495057; white-space: nowrap;">–ü–æ—Ä–æ–≥:</label>
                        <input type="range" id="confidenceSlider" min="0" max="100" value="60"
                               style="flex: 1; cursor: pointer;">
                        <span id="confidenceValue" style="font-size: 14px; font-weight: 600; color: #495057; min-width: 40px;">60%</span>
                    </div>
                    <input type="number" id="confidenceInput" min="0" max="100" value="60"
                           style="width: 70px; padding: 6px 8px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px; text-align: center;">
                </div>

                <p style="margin: 10px 0 0 28px; color: #6c757d; font-size: 12px; line-height: 1.4;">
                    –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É—á–∞—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–≥–∏ —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –≤—ã—à–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞
                </p>
            </div>

            <div class="hierarchical-filters">
                <div class="filter-categories" id="filterCategories">
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div class="filter-subcategories" id="filterSubcategories" style="display: none;">
                    <div class="subcategory-header">
                        <button class="btn btn-back" id="backToCategories">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</button>
                        <h4 id="selectedCategoryTitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é</h4>
                    </div>
                    <div class="subcategory-list" id="subcategoryList">
                        <!-- –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>

                <div class="filter-subsubcategories" id="filterSubsubcategories" style="display: none;">
                    <div class="subsubcategory-header">
                        <button class="btn btn-back" id="backToSubcategories2">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</button>
                        <h4 id="selectedSubcategoryTitle2">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</h4>
                    </div>
                    <div class="subsubcategory-list" id="subsubcategoryList">
                        <!-- –ü–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>

                <div class="filter-details" id="filterDetails" style="display: none;">
                    <div class="filter-details-header">
                        <button class="btn btn-back" id="backToSubcategories">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</button>
                        <h4 id="selectedSubcategoryTitle">–§–∏–ª—å—Ç—Ä—ã</h4>
                    </div>

                    <div class="filter-details-content">
                        <div class="filter-section">
                            <h5>–¶–≤–µ—Ç–∞</h5>
                            <div class="filter-options" id="colorFilters"></div>
                        </div>

                        <div class="filter-section">
                            <h5>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h5>
                            <div class="filter-options" id="materialFilters"></div>
                        </div>

                        <div class="filter-section">
                            <h5>–°—Ç–∏–ª–∏</h5>
                            <div class="filter-options" id="styleFilters"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" id="applyFiltersBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                <button class="btn btn-secondary" id="clearFiltersBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>
        {% endif %}

        {% if current_page == 'gallery_tagged' %}
        <div class="images-counter" id="imagesCounter">
            –ü–æ–∫–∞–∑–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: <span class="count" id="displayedCount">{{ images|length }}</span> –∏–∑ <span class="count" id="totalCount">{{ images|length }}</span>
        </div>
        {% endif %}

        <div class="gallery" id="gallery">
            {% if images %}
                {% for image in images %}
                <div class="image-card"
                     data-image-id="{{ image._id }}"
                     data-username="{{ image.username }}"
                     data-caption="{{ image.caption or '' }}"
                     data-tagged-at="{% if image.timestamp %}{{ image.timestamp if image.timestamp is string else image.timestamp.isoformat() }}{% endif %}"
                     onclick="toggleSelection('{{ image._id }}')"
                     {% if current_page == 'gallery_tagged' and image.ximilar_objects_structured %}
                     {# –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–∫–∞–∫ –≤ API) #}
                     {% set unique_categories = [] %}
                     {% set unique_objects = [] %}
                     {% set unique_original_objects = [] %}
                     {% set unique_colors = [] %}
                     {% set unique_materials = [] %}
                     {% set unique_styles = [] %}
                     {% set unique_objects_by_name = {} %}
                     
                    {# –°–Ω–∞—á–∞–ª–∞ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã –ø–æ –∏—Ö –æ—Å–Ω–æ–≤–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é —Å —É—á—ë—Ç–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ #}
                    {% for obj in image.ximilar_objects_structured %}
                        {% set obj_name = '' %}
                        {% set obj_category = obj.top_category or 'Other' %}
                        {% if obj.properties and obj.properties.other_attributes %}
                            {% if obj.properties.other_attributes.Subcategory %}
                                {% set obj_name = obj.properties.other_attributes.Subcategory[0].name %}
                            {% elif obj.properties.other_attributes.Category %}
                                {% set obj_name = obj.properties.other_attributes.Category[0].name %}
                            {% endif %}
                        {% endif %}
                        
                        {# –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ #}
                        {% if obj_name %}
                            {% set normalized_name = normalize_subcategory(obj_name, obj_category) %}
                            {# –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç —Å —Ç–∞–∫–∏–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ #}
                            {% if normalized_name not in unique_objects_by_name %}
                                {% set _ = unique_objects_by_name.update({normalized_name: obj}) %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                     
                     {# –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É: {–æ–±—ä–µ–∫—Ç: {colors: [], materials: [], styles: []}} #}
                     {% set objects_attrs = {} %}
                     {% set original_objects_attrs = {} %}

                     {# –¢–µ–ø–µ—Ä—å —Å–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ —Ç–æ–ª—å–∫–æ –∏–∑ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ #}
                     {% for obj in unique_objects_by_name.values() %}
                         {# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ #}
                         {% if obj.top_category and obj.top_category not in unique_categories %}
                             {% set _ = unique_categories.append(obj.top_category) %}
                         {% endif %}

                        {# –û–±—ä–µ–∫—Ç—ã - –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ #}
                        {% set obj_category = obj.top_category or 'Other' %}
                        {% set normalized_obj = '' %}
                        {% set original_obj_name = '' %}
                        {% if obj.properties and obj.properties.other_attributes %}
                            {% if obj.properties.other_attributes.Subcategory %}
                                {% set obj_name = obj.properties.other_attributes.Subcategory[0].name %}
                                {% set original_obj_name = obj_name %}
                                {% set normalized_obj = normalize_subcategory(obj_name, obj_category) %}
                                {% if normalized_obj not in unique_objects %}
                                    {% set _ = unique_objects.append(normalized_obj) %}
                                {% endif %}
                                {% if obj_name not in unique_original_objects %}
                                    {% set _ = unique_original_objects.append(obj_name) %}
                                {% endif %}
                            {% elif obj.properties.other_attributes.Category %}
                                {% set obj_name = obj.properties.other_attributes.Category[0].name %}
                                {% set original_obj_name = obj_name %}
                                {% set normalized_obj = normalize_subcategory(obj_name, obj_category) %}
                                {% if normalized_obj not in unique_objects %}
                                    {% set _ = unique_objects.append(normalized_obj) %}
                                {% endif %}
                                {% if obj_name not in unique_original_objects %}
                                    {% set _ = unique_original_objects.append(obj_name) %}
                                {% endif %}
                            {% endif %}
                        {% endif %}

                        {# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ #}
                        {% if normalized_obj and normalized_obj not in objects_attrs %}
                            {% set _ = objects_attrs.update({normalized_obj: {'colors': [], 'materials': [], 'styles': []}}) %}
                        {% endif %}
                        {% if original_obj_name and original_obj_name not in original_objects_attrs %}
                            {% set _ = original_objects_attrs.update({original_obj_name: {'colors': [], 'materials': [], 'styles': []}}) %}
                        {% endif %}

                         {# –¶–≤–µ—Ç–∞ —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ #}
                         {% if normalized_obj and obj.properties and obj.properties.visual_attributes and obj.properties.visual_attributes.Color %}
                             {% for color in obj.properties.visual_attributes.Color %}
                                 {% if color.name not in unique_colors %}
                                     {% set _ = unique_colors.append(color.name) %}
                                 {% endif %}
                                 {% if color.name not in objects_attrs[normalized_obj]['colors'] %}
                                     {% set _ = objects_attrs[normalized_obj]['colors'].append(color.name) %}
                                 {% endif %}
                                 {% if original_obj_name and color.name not in original_objects_attrs[original_obj_name]['colors'] %}
                                     {% set _ = original_objects_attrs[original_obj_name]['colors'].append(color.name) %}
                                 {% endif %}
                             {% endfor %}
                         {% endif %}

                         {# –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ #}
                         {% if normalized_obj and obj.properties and obj.properties.material_attributes and obj.properties.material_attributes.Material %}
                             {% for material in obj.properties.material_attributes.Material %}
                                 {% if material.name not in unique_materials %}
                                     {% set _ = unique_materials.append(material.name) %}
                                 {% endif %}
                                 {% if material.name not in objects_attrs[normalized_obj]['materials'] %}
                                     {% set _ = objects_attrs[normalized_obj]['materials'].append(material.name) %}
                                 {% endif %}
                                 {% if original_obj_name and material.name not in original_objects_attrs[original_obj_name]['materials'] %}
                                     {% set _ = original_objects_attrs[original_obj_name]['materials'].append(material.name) %}
                                 {% endif %}
                             {% endfor %}
                         {% endif %}

                         {# –°—Ç–∏–ª–∏ —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ #}
                         {% if normalized_obj and obj.properties and obj.properties.style_attributes and obj.properties.style_attributes.Style %}
                             {% for style in obj.properties.style_attributes.Style %}
                                 {% if style.name not in unique_styles %}
                                     {% set _ = unique_styles.append(style.name) %}
                                 {% endif %}
                                 {% if style.name not in objects_attrs[normalized_obj]['styles'] %}
                                     {% set _ = objects_attrs[normalized_obj]['styles'].append(style.name) %}
                                 {% endif %}
                                 {% if original_obj_name and style.name not in original_objects_attrs[original_obj_name]['styles'] %}
                                     {% set _ = original_objects_attrs[original_obj_name]['styles'].append(style.name) %}
                                 {% endif %}
                             {% endfor %}
                         {% endif %}
                     {% endfor %}

                     data-categories="{{ unique_categories|join(',') }}"
                     data-objects="{{ unique_objects|join(',') }}"
                     data-original-objects="{{ unique_original_objects|join(',') }}"
                     data-colors="{{ unique_colors|join(',') }}"
                     data-materials="{{ unique_materials|join(',') }}"
                     data-styles="{{ unique_styles|join(',') }}"
                     data-objects-attrs='{{ objects_attrs|tojson|safe }}'
                     data-original-objects-attrs='{{ original_objects_attrs|tojson|safe }}'
                     {% endif %}>
                    <div class="image-container">
                        <img src="/images/{{ image.local_filename }}" alt="{{ image.caption or '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' }}" loading="lazy">
                        <div class="checkbox"></div>
                    </div>
                    <div class="image-info">
                        <div class="username">@{{ image.username }}</div>
                        <div class="stats">
                            <span>‚ù§Ô∏è {{ image.likes_count if image.likes_count and image.likes_count >= 0 else 0 }}</span>
                            <span>üí¨ {{ image.comments_count if image.comments_count and image.comments_count >= 0 else 0 }}</span>
                        </div>
                        {% if image.timestamp %}
                        <div class="post-date">üìÖ {{ image.timestamp[:10] }}</div>
                        {% endif %}
                        <div class="caption">{{ image.caption or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}</div>
                        {% if current_page == 'gallery_tagged' and image.ximilar_objects_structured %}
                            <div class="ximilar-tags">
                                {% set categories = {} %}
                                {% for obj in image.ximilar_objects_structured %}
                                    {% set category = obj.top_category or 'other' %}
                                    {% if category not in categories %}
                                        {% set _ = categories.update({category: []}) %}
                                    {% endif %}
                                    
                                    {% set obj_info = '' %}
                                    {% set color = '' %}
                                    {% set material = '' %}
                                    {% set style = '' %}
                                    
                                    {% if obj.properties %}
                                        {# –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ Subcategory #}
                                        {% if obj.properties.other_attributes and obj.properties.other_attributes.Subcategory %}
                                            {% set subcategory_list = obj.properties.other_attributes.Subcategory %}
                                            {% if subcategory_list and subcategory_list|length > 0 %}
                                                {% set obj_info = subcategory_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# –ï—Å–ª–∏ –Ω–µ—Ç Subcategory, –∏—Å–ø–æ–ª—å–∑—É–µ–º Category #}
                                        {% if not obj_info and obj.properties.other_attributes and obj.properties.other_attributes.Category %}
                                            {% set category_list = obj.properties.other_attributes.Category %}
                                            {% if category_list and category_list|length > 0 %}
                                                {% set obj_info = category_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º name #}
                                        {% if not obj_info %}
                                            {% set obj_info = obj.name %}
                                        {% endif %}
                                        
                                        {# –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –∏–∑ visual_attributes.Color #}
                                        {% if obj.properties.visual_attributes and obj.properties.visual_attributes.Color %}
                                            {% set color_list = obj.properties.visual_attributes.Color %}
                                            {% if color_list and color_list|length > 0 %}
                                                {% set color = color_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# –ü–æ–ª—É—á–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ material_attributes.Material #}
                                        {% if obj.properties.material_attributes and obj.properties.material_attributes.Material %}
                                            {% set material_list = obj.properties.material_attributes.Material %}
                                            {% if material_list and material_list|length > 0 %}
                                                {% set material = material_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∏–ª—å –∏–∑ style_attributes.Style #}
                                        {% if obj.properties.style_attributes and obj.properties.style_attributes.Style %}
                                            {% set style_list = obj.properties.style_attributes.Style %}
                                            {% if style_list and style_list|length > 0 %}
                                                {% set style = style_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {% if color or material or style %}
                                            {% set properties = [] %}
                                            {% if color %}{% set _ = properties.append(color) %}{% endif %}
                                            {% if material %}{% set _ = properties.append(material) %}{% endif %}
                                            {% if style %}{% set _ = properties.append(style) %}{% endif %}
                                            {% set obj_info = obj_info + ' (' + properties|join(', ') + ')' %}
                                        {% endif %}
                                    {% endif %}
                                    
                                    {% set _ = categories[category].append(obj_info) %}
                                {% endfor %}
                                
                                {% for category, objects in categories.items() %}
                                    <div class="category-group">
                                        <span class="category-name">{{ category }}:</span>
                                        <span class="category-objects">{{ objects|join(', ') }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% elif current_page == 'gallery_tagged' and image.ximilar_tags %}
                            <div class="ximilar-tags">
                                {% for tag in image.ximilar_tags[:3] %}
                                    <span class="tag">{{ tag.name }}</span>
                                {% endfor %}
                                {% if image.ximilar_tags|length > 3 %}
                                    <span class="tag-more">+{{ image.ximilar_tags|length - 3 }} –µ—â–µ</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-images">
                    <h3>üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p>–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–∞—Ä—Å–∏–Ω–≥ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ Instagram</p>
                </div>
            {% endif %}
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ" -->
        <div style="text-align: center; padding: 30px 0; display: none;" id="loadMoreContainer">
            <button class="btn btn-primary" id="loadMoreBtn" style="font-size: 16px; padding: 15px 40px;">
                üì• –ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ
            </button>
            <p id="loadMoreStatus" style="margin-top: 10px; color: #6c757d; font-size: 14px;"></p>
        </div>
    </div>

    <script>
        let selectedImages = new Set();

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è infinite scroll
        let currentOffset = parseInt('{{ images|length }}');  // –ù–∞—á–∏–Ω–∞–µ–º —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        let isLoading = false;
        let hasMore = true;
        const galleryType = '{{ current_page }}';
        const BATCH_SIZE = 50;

        // –§–ª–∞–≥ —Ä–µ–∂–∏–º–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        let isFilteredMode = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectedCount();
            setupEventListeners();
            setupInfiniteScroll();
            initBloggersFilter();
            setupLoadMoreButton();
        });
        
        function setupEventListeners() {
            // –ü–æ–∏—Å–∫
            document.getElementById('searchInput').addEventListener('input', filterImages);
            
            // –§–∏–ª—å—Ç—Ä—ã
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterImages();
                });
            });
            
            // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            const selectAllBtn = document.getElementById('selectAllBtn');
            const clearSelectionBtn = document.getElementById('clearSelectionBtn');
            const markForTaggingBtn = document.getElementById('markForTaggingBtn');
            const hideImagesBtn = document.getElementById('hideImagesBtn');
            const unhideImagesBtn = document.getElementById('unhideImagesBtn');
            const unmarkBtn = document.getElementById('unmarkBtn');
            const tagImagesBtn = document.getElementById('tagImagesBtn');
            
            if (selectAllBtn) selectAllBtn.addEventListener('click', selectAll);
            if (clearSelectionBtn) clearSelectionBtn.addEventListener('click', clearSelection);
            if (markForTaggingBtn) markForTaggingBtn.addEventListener('click', markForTagging);
            if (hideImagesBtn) hideImagesBtn.addEventListener('click', hideImages);
            if (unhideImagesBtn) unhideImagesBtn.addEventListener('click', unhideImages);
            if (unmarkBtn) unmarkBtn.addEventListener('click', unmarkForTagging);
            if (tagImagesBtn) tagImagesBtn.addEventListener('click', tagImages);
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–≥–µ—Ä–∞–º (–¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü)
            const toggleBloggersFilterBtn = document.getElementById('toggleBloggersFilter');
            const bloggersFilter = document.getElementById('bloggersFilter');
            const applyBloggersFilterBtn = document.getElementById('applyBloggersFilterBtn');
            const clearBloggersFilterBtn = document.getElementById('clearBloggersFilterBtn');
            const selectAllBloggersBtn = document.getElementById('selectAllBloggersBtn');
            
            if (toggleBloggersFilterBtn && bloggersFilter) {
                toggleBloggersFilterBtn.addEventListener('click', () => {
                    const controls = document.querySelector('.controls');
                    if (bloggersFilter.classList.contains('open')) {
                        bloggersFilter.classList.remove('open');
                        controls.classList.remove('filters-open');
                        toggleBloggersFilterBtn.textContent = 'üë• –§–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–≥–µ—Ä–∞–º';
                    } else {
                        bloggersFilter.classList.add('open');
                        controls.classList.add('filters-open');
                        toggleBloggersFilterBtn.textContent = 'üë• –°–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä';
                    }
                });
            }
            
            if (applyBloggersFilterBtn) {
                applyBloggersFilterBtn.addEventListener('click', applyBloggersFilter);
            }
            
            if (clearBloggersFilterBtn) {
                clearBloggersFilterBtn.addEventListener('click', clearBloggersFilter);
            }
            
            if (selectAllBloggersBtn) {
                selectAllBloggersBtn.addEventListener('click', selectAllBloggers);
            }
            
            // –ü—Ä–æ—Å—Ç–æ–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º –¥–ª—è gallery –∏ gallery_to_tag
            if ('{{ current_page }}' !== 'gallery_tagged') {
                const toggleDateFilterBtn = document.getElementById('toggleDateFilter');
                const dateFilters = document.getElementById('dateFilters');
                const applyDateFilterBtn = document.getElementById('applyDateFilterBtn');
                const clearDateFilterBtn = document.getElementById('clearDateFilterBtn');

                if (toggleDateFilterBtn && dateFilters) {
                    toggleDateFilterBtn.addEventListener('click', () => {
                        const controls = document.querySelector('.controls');
                        if (dateFilters.classList.contains('open')) {
                            dateFilters.classList.remove('open');
                            controls.classList.remove('filters-open');
                            toggleDateFilterBtn.textContent = 'üìÖ –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º';
                        } else {
                            dateFilters.classList.add('open');
                            controls.classList.add('filters-open');
                            toggleDateFilterBtn.textContent = 'üìÖ –°–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä';
                        }
                    });
                }

                if (applyDateFilterBtn) {
                    applyDateFilterBtn.addEventListener('click', applySimpleDateFilter);
                }

                if (clearDateFilterBtn) {
                    clearDateFilterBtn.addEventListener('click', clearSimpleDateFilter);
                }

                // –ü–æ–ª—è –¥–∞—Ç—ã
                const simpleDateFromInput = document.getElementById('simpleDateFrom');
                const simpleDateToInput = document.getElementById('simpleDateTo');

                if (simpleDateFromInput) {
                    simpleDateFromInput.addEventListener('change', (e) => {
                        selectedFilters.dateFrom = e.target.value;
                    });
                }

                if (simpleDateToInput) {
                    simpleDateToInput.addEventListener('change', (e) => {
                        selectedFilters.dateTo = e.target.value;
                    });
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ API
                const dateSortOrderSelect = document.getElementById('dateSortOrder');
                if (dateSortOrderSelect) {
                    dateSortOrderSelect.addEventListener('change', async (e) => {
                        await reloadGalleryWithCurrentFilters();
                    });
                }
            }

            // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
            if ('{{ current_page }}' === 'gallery_tagged') {
                const toggleAdvancedFiltersBtn = document.getElementById('toggleAdvancedFilters');
                const advancedFilters = document.getElementById('advancedFilters');
                const applyFiltersBtn = document.getElementById('applyFiltersBtn');
                const clearFiltersBtn = document.getElementById('clearFiltersBtn');

                if (toggleAdvancedFiltersBtn && advancedFilters) {
                    toggleAdvancedFiltersBtn.addEventListener('click', () => {
                        const controls = document.querySelector('.controls');
                        if (advancedFilters.classList.contains('open')) {
                            advancedFilters.classList.remove('open');
                            controls.classList.remove('filters-open');
                            toggleAdvancedFiltersBtn.textContent = 'üîç –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã';
                        } else {
                            advancedFilters.classList.add('open');
                            controls.classList.add('filters-open');
                            toggleAdvancedFiltersBtn.textContent = 'üîç –°–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã';
                            loadFilterOptions();
                        }
                    });
                }

                if (applyFiltersBtn) {
                    applyFiltersBtn.addEventListener('click', applyAdvancedFilters);
                }

                if (clearFiltersBtn) {
                    clearFiltersBtn.addEventListener('click', clearAdvancedFilters);
                }

                // –ü–æ–ª—è –¥–∞—Ç—ã
                const dateFromInput = document.getElementById('dateFrom');
                const dateToInput = document.getElementById('dateTo');

                if (dateFromInput) {
                    dateFromInput.addEventListener('change', (e) => {
                        selectedFilters.dateFrom = e.target.value;
                    });
                }

                if (dateToInput) {
                    dateToInput.addEventListener('change', (e) => {
                        selectedFilters.dateTo = e.target.value;
                    });
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                const taggedDateSortOrderSelect = document.getElementById('taggedDateSortOrder');
                if (taggedDateSortOrderSelect) {
                    taggedDateSortOrderSelect.addEventListener('change', async (e) => {
                        await reloadGalleryWithCurrentFilters();
                    });
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≥–∞–ª–æ—á–∫–∏ confidence filter
                const confidenceFilterCheckbox = document.getElementById('useConfidenceFilter');
                const confidenceSlider = document.getElementById('confidenceSlider');
                const confidenceInput = document.getElementById('confidenceInput');
                const confidenceValue = document.getElementById('confidenceValue');
                const confidenceControls = document.getElementById('confidenceControls');

                // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
                function updateConfidenceControls() {
                    const isEnabled = confidenceFilterCheckbox?.checked ?? false;
                    if (confidenceSlider) confidenceSlider.disabled = !isEnabled;
                    if (confidenceInput) confidenceInput.disabled = !isEnabled;
                    if (confidenceControls) confidenceControls.style.opacity = isEnabled ? '1' : '0.5';
                }

                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è slider –∏ input
                function syncConfidenceValue(value) {
                    const numValue = Math.max(0, Math.min(100, parseInt(value) || 60));
                    if (confidenceSlider) confidenceSlider.value = numValue;
                    if (confidenceInput) confidenceInput.value = numValue;
                    if (confidenceValue) confidenceValue.textContent = numValue + '%';
                    return numValue;
                }

                if (confidenceFilterCheckbox) {
                    confidenceFilterCheckbox.addEventListener('change', async (e) => {
                        console.log('üîÑ Confidence filter –∏–∑–º–µ–Ω–µ–Ω:', e.target.checked);
                        updateConfidenceControls();
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞ —Å —É—á–µ—Ç–æ–º –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è confidence
                        await loadFilterOptions();
                    });
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞
                if (confidenceSlider) {
                    confidenceSlider.addEventListener('input', (e) => {
                        syncConfidenceValue(e.target.value);
                    });
                    confidenceSlider.addEventListener('change', async (e) => {
                        console.log('üîÑ Confidence threshold –∏–∑–º–µ–Ω–µ–Ω:', e.target.value);
                        await loadFilterOptions();
                    });
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞
                if (confidenceInput) {
                    confidenceInput.addEventListener('input', (e) => {
                        syncConfidenceValue(e.target.value);
                    });
                    confidenceInput.addEventListener('change', async (e) => {
                        console.log('üîÑ Confidence threshold –∏–∑–º–µ–Ω–µ–Ω:', e.target.value);
                        await loadFilterOptions();
                    });
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
                updateConfidenceControls();

                // –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
                const backToCategoriesBtn = document.getElementById('backToCategories');
                const backToSubcategories2Btn = document.getElementById('backToSubcategories2');
                const backToSubcategoriesBtn = document.getElementById('backToSubcategories');

                if (backToCategoriesBtn) {
                    backToCategoriesBtn.addEventListener('click', backToCategories);
                }

                if (backToSubcategories2Btn) {
                    backToSubcategories2Btn.addEventListener('click', backToSubcategories);
                }

                if (backToSubcategoriesBtn) {
                    backToSubcategoriesBtn.addEventListener('click', backToSubsubcategories);
                }
            }
        }
        
        function toggleSelection(imageId) {
            const card = document.querySelector(`[data-image-id="${imageId}"]`);
            const checkbox = card.querySelector('.checkbox');
            
            if (selectedImages.has(imageId)) {
                selectedImages.delete(imageId);
                card.classList.remove('selected');
                checkbox.classList.remove('checked');
            } else {
                selectedImages.add(imageId);
                card.classList.add('selected');
                checkbox.classList.add('checked');
            }
            
            updateSelectedCount();
        }
        
        function selectAll() {
            const visibleCards = getVisibleCards();
            visibleCards.forEach(card => {
                const imageId = card.dataset.imageId;
                selectedImages.add(imageId);
                card.classList.add('selected');
                card.querySelector('.checkbox').classList.add('checked');
            });
            updateSelectedCount();
        }
        
        function clearSelection() {
            selectedImages.clear();
            document.querySelectorAll('.image-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.checkbox').classList.remove('checked');
            });
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const count = selectedImages.size;
            const selectedCountElements = document.querySelectorAll('#selectedCount');
            
            selectedCountElements.forEach(element => {
                element.textContent = count;
            });
            
            const markForTaggingBtn = document.getElementById('markForTaggingBtn');
            const hideImagesBtn = document.getElementById('hideImagesBtn');
            const unhideImagesBtn = document.getElementById('unhideImagesBtn');
            const unmarkBtn = document.getElementById('unmarkBtn');
            const tagImagesBtn = document.getElementById('tagImagesBtn');
            
            if (markForTaggingBtn) markForTaggingBtn.disabled = count === 0;
            if (hideImagesBtn) hideImagesBtn.disabled = count === 0;
            if (unhideImagesBtn) unhideImagesBtn.disabled = count === 0;
            if (unmarkBtn) unmarkBtn.disabled = count === 0;
            if (tagImagesBtn) tagImagesBtn.disabled = count === 0;
        }
        
        function filterImages() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            
            document.querySelectorAll('.image-card').forEach(card => {
                const username = card.dataset.username.toLowerCase();
                const caption = card.dataset.caption.toLowerCase();
                const isSelected = selectedImages.has(card.dataset.imageId);
                
                let matchesSearch = username.includes(searchTerm) || caption.includes(searchTerm);
                let matchesFilter = true;
                
                if (activeFilter === 'selected') {
                    matchesFilter = isSelected;
                } else if (activeFilter === 'unselected') {
                    matchesFilter = !isSelected;
                }
                
                card.style.display = (matchesSearch && matchesFilter) ? 'block' : 'none';
            });
        }
        
        function getVisibleCards() {
            return Array.from(document.querySelectorAll('.image-card')).filter(card => 
                card.style.display !== 'none'
            );
        }
        
        async function markForTagging() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('markForTaggingBtn');
            
            if (!button) {
                console.error('–ö–Ω–æ–ø–∫–∞ markForTaggingBtn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            button.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/mark-for-tagging', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    clearSelection();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function hideImages() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('hideImagesBtn');
            
            if (!button) {
                console.error('–ö–Ω–æ–ø–∫–∞ hideImagesBtn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            button.innerHTML = '‚è≥ –°–∫—Ä—ã—Ç–∏–µ...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/hide-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    clearSelection();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function unhideImages() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('unhideImagesBtn');
            
            if (!button) {
                console.error('–ö–Ω–æ–ø–∫–∞ unhideImagesBtn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            button.innerHTML = '‚è≥ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/unhide-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    clearSelection();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function unmarkForTagging() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('unmarkBtn');
            
            if (!button) {
                console.error('–ö–Ω–æ–ø–∫–∞ unmarkBtn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            button.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/unmark-for-tagging', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    clearSelection();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function tagImages() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('tagImagesBtn');
            
            if (!button) {
                console.error('–ö–Ω–æ–ø–∫–∞ tagImagesBtn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            button.innerHTML = '‚è≥ –¢–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/tag-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    clearSelection();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        let hierarchicalFilters = {};
        let currentCategory = null;
        let currentSubcategory = null;
        let currentSubsubcategory = null;
        let selectedFilters = {
            category: null,
            subcategory: null,
            subsubcategory: null,
            colors: [],
            materials: [],
            styles: [],
            dateFrom: null,
            dateTo: null
        };
        
        async function loadFilterOptions() {
            console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤...');
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏ confidence filter
                const useConfidence = document.getElementById('useConfidenceFilter')?.checked ?? true;
                const confidenceThreshold = parseInt(document.getElementById('confidenceSlider')?.value ?? 60);
                const response = await fetch(`/api/filter-options?use_confidence=${useConfidence}&confidence_threshold=${confidenceThreshold}`);
                console.log('üì° –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, status:', response.status);

                const result = await response.json();
                console.log('üì¶ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', result);

                if (result.success) {
                    hierarchicalFilters = result.hierarchical_filters;
                    console.log('‚úÖ hierarchicalFilters —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', hierarchicalFilters);
                    console.log('üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', Object.keys(hierarchicalFilters).length);
                    renderCategories();
                } else {
                    console.error('‚ùå API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É:', result.message);
                    showNotification(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', error);
                showNotification(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤: ${error.message}`, 'error');
            }
        }
        
        function renderCategories() {
            console.log('üé® renderCategories –≤—ã–∑–≤–∞–Ω–∞');
            const container = document.getElementById('filterCategories');
            console.log('üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞–π–¥–µ–Ω:', container);

            if (!container) {
                console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä filterCategories –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }

            container.innerHTML = '';

            const categories = Object.keys(hierarchicalFilters).filter(k => k !== '_meta').sort();
            console.log('üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', categories);

            categories.forEach(category => {
                const categoryData = hierarchicalFilters[category];
                const imageCount = categoryData._meta?.image_count || 0;
                const subcategoryCount = Object.keys(categoryData).filter(k => k !== '_meta').length;

                console.log(`  ‚Ä¢ ${category}: ${imageCount} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, ${subcategoryCount} –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π`);

                const categoryElement = document.createElement('div');
                categoryElement.className = 'category-option';
                categoryElement.innerHTML = `
                    <div class="category-info">
                        <h4>${category}</h4>
                        <span class="category-count">(${imageCount} ${imageCount === 1 ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π'})</span>
                    </div>
                    <div class="category-arrow">‚Üí</div>
                `;

                categoryElement.addEventListener('click', () => {
                    selectCategory(category);
                });

                container.appendChild(categoryElement);
            });

            console.log('‚úÖ renderCategories –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –¥–æ–±–∞–≤–ª–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤:', categories.length);
        }
        
        function selectCategory(category) {
            currentCategory = category;
            selectedFilters.category = category;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            document.getElementById('filterCategories').style.display = 'none';
            document.getElementById('filterSubcategories').style.display = 'block';
            document.getElementById('filterDetails').style.display = 'none';

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('selectedCategoryTitle').textContent = `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}`;

            // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            renderSubcategories(category);
        }
        
        function renderSubcategories(category) {
            const container = document.getElementById('subcategoryList');
            if (!container) return;

            container.innerHTML = '';

            const subcategories = Object.keys(hierarchicalFilters[category]).filter(k => k !== '_meta').sort();

            subcategories.forEach(subcategory => {
                const filters = hierarchicalFilters[category][subcategory];
                const imageCount = filters._image_count || 0;

                const subcategoryElement = document.createElement('div');
                subcategoryElement.className = 'subcategory-option';
                subcategoryElement.innerHTML = `
                    <div class="subcategory-info">
                        <h5>${subcategory}</h5>
                        <span class="subcategory-count">(${imageCount} ${imageCount === 1 ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π'})</span>
                    </div>
                    <div class="subcategory-arrow">‚Üí</div>
                `;

                subcategoryElement.addEventListener('click', () => {
                    selectSubcategory(category, subcategory);
                });

                container.appendChild(subcategoryElement);
            });
        }

        function renderSubsubcategories(category, subcategory) {
            const container = document.getElementById('subsubcategoryList');
            if (!container) return;

            container.innerHTML = '';

            const subsubcategories = hierarchicalFilters[category][subcategory].subsubcategories || {};
            const subsubcategoryNames = Object.keys(subsubcategories).sort();

            console.log('üîç DEBUG renderSubsubcategories:');
            console.log('  category:', category);
            console.log('  subcategory:', subcategory);
            console.log('  subsubcategoryNames:', subsubcategoryNames);
            console.log('  –ü–µ—Ä–≤–∞—è –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:', subsubcategoryNames.length > 0 ? subsubcategories[subsubcategoryNames[0]] : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö');

            subsubcategoryNames.forEach(subsubcategory => {
                const filters = subsubcategories[subsubcategory];
                const imageCount = filters._image_count || 0;

                console.log(`  ${subsubcategory}: imageCount=${imageCount}, –µ—Å—Ç—å colors=${!!filters.colors}, –µ—Å—Ç—å subsubcategories=${!!filters.subsubcategories}`);

                const subsubcategoryElement = document.createElement('div');
                subsubcategoryElement.className = 'subsubcategory-option';
                subsubcategoryElement.innerHTML = `
                    <div class="subsubcategory-info">
                        <h5>${subsubcategory}</h5>
                        <span class="subsubcategory-count">(${imageCount} ${imageCount === 1 ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π'})</span>
                    </div>
                    <div class="subsubcategory-arrow">‚Üí</div>
                `;

                subsubcategoryElement.addEventListener('click', () => {
                    selectSubsubcategory(category, subcategory, subsubcategory);
                });

                container.appendChild(subsubcategoryElement);
            });
        }

        function selectSubcategory(category, subcategory) {
            currentSubcategory = subcategory;
            selectedFilters.subcategory = subcategory;

            const subcatData = hierarchicalFilters[category][subcategory];

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç—Ä–µ—Ç–∏–π —É—Ä–æ–≤–µ–Ω—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ (subsubcategories)
            if (subcatData.subsubcategories && Object.keys(subcatData.subsubcategories).length > 0) {
                // –¢—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                document.getElementById('filterSubcategories').style.display = 'none';
                document.getElementById('filterSubsubcategories').style.display = 'block';
                document.getElementById('filterDetails').style.display = 'none';

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                document.getElementById('selectedSubcategoryTitle2').textContent = `${subcategory} - –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø`;

                // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                renderSubsubcategories(category, subcategory);
            } else {
                // –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º colors/materials/styles
                currentSubsubcategory = subcategory;  // –∏—Å–ø–æ–ª—å–∑—É–µ–º subcategory –∫–∞–∫ subsubcategory
                selectedFilters.subsubcategory = subcategory;

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                selectedFilters.colors = [];
                selectedFilters.materials = [];
                selectedFilters.styles = [];

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                document.getElementById('filterSubcategories').style.display = 'none';
                document.getElementById('filterSubsubcategories').style.display = 'none';
                document.getElementById('filterDetails').style.display = 'block';

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                document.getElementById('selectedSubcategoryTitle').textContent = `${subcategory} - –í—ã–±–µ—Ä–∏—Ç–µ –∞—Ç—Ä–∏–±—É—Ç—ã`;

                // –†–µ–Ω–¥–µ—Ä–∏–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞–ø—Ä—è–º—É—é —Å —É—Ä–æ–≤–Ω—è subcategory
                renderFilterDetailsDirectly(category, subcategory);
            }
        }

        function selectSubsubcategory(category, subcategory, subsubcategory) {
            currentSubsubcategory = subsubcategory;
            selectedFilters.subsubcategory = subsubcategory;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (—Ü–≤–µ—Ç–∞, –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —Å—Ç–∏–ª–∏) –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–æ–≤–æ–π –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            selectedFilters.colors = [];
            selectedFilters.materials = [];
            selectedFilters.styles = [];

            // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            document.getElementById('filterSubsubcategories').style.display = 'none';
            document.getElementById('filterDetails').style.display = 'block';

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('selectedSubcategoryTitle').textContent = `${subsubcategory} - –í—ã–±–µ—Ä–∏—Ç–µ –∞—Ç—Ä–∏–±—É—Ç—ã`;

            // –†–µ–Ω–¥–µ—Ä–∏–º —Ñ–∏–ª—å—Ç—Ä—ã (—Ü–≤–µ—Ç–∞, –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —Å—Ç–∏–ª–∏)
            renderFilterDetails(category, subcategory, subsubcategory);
        }

        function renderFilterDetailsDirectly(category, subcategory) {
            // –î–ª—è –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã - —Ä–µ–Ω–¥–µ—Ä–∏–º –Ω–∞–ø—Ä—è–º—É—é —Å —É—Ä–æ–≤–Ω—è subcategory
            console.log('üîç renderFilterDetailsDirectly –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è:', { category, subcategory });

            const filters = hierarchicalFilters[category][subcategory];

            console.log('üì¶ filters:', filters);
            console.log('üé® filters.colors:', filters.colors);
            console.log('üßµ filters.materials:', filters.materials);
            console.log('‚ú® filters.styles:', filters.styles);

            // –†–µ–Ω–¥–µ—Ä–∏–º —Ü–≤–µ—Ç–∞
            renderFilterSection('colorFilters', filters.colors, 'colors');

            // –†–µ–Ω–¥–µ—Ä–∏–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            renderFilterSection('materialFilters', filters.materials, 'materials');

            // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ç–∏–ª–∏
            renderFilterSection('styleFilters', filters.styles, 'styles');
        }

        function renderFilterDetails(category, subcategory, subsubcategory) {
            // –î–ª—è —Ç—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã - —Ä–µ–Ω–¥–µ—Ä–∏–º —Å —É—Ä–æ–≤–Ω—è subsubcategory
            console.log('üîç renderFilterDetails –≤—ã–∑–≤–∞–Ω —Å:', { category, subcategory, subsubcategory });

            // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—É—Ä–æ–≤–µ–Ω—å 3)
            const filters = hierarchicalFilters[category][subcategory].subsubcategories[subsubcategory];

            console.log('üì¶ filters:', filters);
            console.log('üé® filters.colors:', filters.colors);
            console.log('üßµ filters.materials:', filters.materials);
            console.log('‚ú® filters.styles:', filters.styles);

            // –†–µ–Ω–¥–µ—Ä–∏–º —Ü–≤–µ—Ç–∞
            renderFilterSection('colorFilters', filters.colors, 'colors');

            // –†–µ–Ω–¥–µ—Ä–∏–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            renderFilterSection('materialFilters', filters.materials, 'materials');

            // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ç–∏–ª–∏
            renderFilterSection('styleFilters', filters.styles, 'styles');
        }
        
        function renderFilterSection(containerId, options, filterType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            // options —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –æ–±—ä–µ–∫—Ç {name: count}
            Object.entries(options).forEach(([name, count]) => {
                const filterOption = document.createElement('div');
                filterOption.className = 'filter-option';
                filterOption.innerHTML = `
                    <span class="filter-name">${name}</span>
                    <span class="filter-count">(${count})</span>
                `;
                filterOption.dataset.filterType = filterType;
                filterOption.dataset.value = name;
                
                filterOption.addEventListener('click', () => {
                    filterOption.classList.toggle('selected');
                    
                    if (filterOption.classList.contains('selected')) {
                        if (!selectedFilters[filterType].includes(name)) {
                            selectedFilters[filterType].push(name);
                        }
                    } else {
                        selectedFilters[filterType] = selectedFilters[filterType].filter(item => item !== name);
                    }
                });
                
                container.appendChild(filterOption);
            });
        }
        
        async function applyAdvancedFilters() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –≤–º–µ—Å—Ç–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π
            console.log('üîç –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è):', selectedFilters);

            if (!hasActiveFilters()) {
                // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–µ –∞–∫—Ç–∏–≤–Ω—ã, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                isFilteredMode = false;
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                location.reload();
                return;
            }

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            isFilteredMode = true;
            currentOffset = 0;
            hasMore = true;

            // –û—á–∏—â–∞–µ–º –≥–∞–ª–µ—Ä–µ—é
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '<div class="loading-indicator">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</div>';

            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏ confidence filter
                const useConfidence = document.getElementById('useConfidenceFilter')?.checked ?? true;
                const confidenceThreshold = parseInt(document.getElementById('confidenceSlider')?.value ?? 60);

                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                let url = `/api/filtered-images?offset=0&limit=${BATCH_SIZE}&use_confidence=${useConfidence}&confidence_threshold=${confidenceThreshold}`;

                if (selectedFilters.category) {
                    url += `&category=${encodeURIComponent(selectedFilters.category)}`;
                }
                if (selectedFilters.subcategory) {
                    url += `&subcategory=${encodeURIComponent(selectedFilters.subcategory)}`;
                }
                if (selectedFilters.subsubcategory) {
                    url += `&subsubcategory=${encodeURIComponent(selectedFilters.subsubcategory)}`;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ü–≤–µ—Ç–∞–º
                if (selectedFilters.colors && selectedFilters.colors.length > 0) {
                    selectedFilters.colors.forEach(color => {
                        url += `&colors[]=${encodeURIComponent(color)}`;
                    });
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
                if (selectedFilters.materials && selectedFilters.materials.length > 0) {
                    selectedFilters.materials.forEach(material => {
                        url += `&materials[]=${encodeURIComponent(material)}`;
                    });
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç–∏–ª—è–º
                if (selectedFilters.styles && selectedFilters.styles.length > 0) {
                    selectedFilters.styles.forEach(style => {
                        url += `&styles[]=${encodeURIComponent(style)}`;
                    });
                }

                console.log('üì° –ó–∞–ø—Ä–æ—Å –∫ API:', url);

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    // –û—á–∏—â–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    gallery.innerHTML = '';

                    console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${result.images.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ ${result.total_count}`);

                    if (result.images.length === 0) {
                        gallery.innerHTML = '<div class="no-results">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</div>';
                    } else {
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≥–∞–ª–µ—Ä–µ—é
                        result.images.forEach(image => {
                            appendImageCard(image);
                        });

                        // –û–±–Ω–æ–≤–ª—è–µ–º offset –∏ —Ñ–ª–∞–≥ hasMore
                        currentOffset = result.images.length;
                        hasMore = result.has_more;

                        console.log(`üìä –ü–æ–∫–∞–∑–∞–Ω–æ: ${result.images.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –≤—Å–µ–≥–æ: ${result.total_count}, –µ—Å—Ç—å –µ—â–µ: ${hasMore}`);

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                        updateImagesCounter(result.images.length, result.total_count);
                    }

                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤
                    const advancedFilters = document.getElementById('advancedFilters');
                    const toggleAdvancedFiltersBtn = document.getElementById('toggleAdvancedFilters');
                    const controls = document.querySelector('.controls');
                    if (advancedFilters && advancedFilters.classList.contains('open')) {
                        advancedFilters.classList.remove('open');
                        if (controls) controls.classList.remove('filters-open');
                        if (toggleAdvancedFiltersBtn) toggleAdvancedFiltersBtn.textContent = 'üîç –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã';
                    }
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                    gallery.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>';
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                console.error('Error applying filters:', error);
                gallery.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>';
            }
        }

        function backToCategories() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é
            currentCategory = null;
            currentSubcategory = null;
            currentSubsubcategory = null;
            selectedFilters.category = null;
            selectedFilters.subcategory = null;
            selectedFilters.subsubcategory = null;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            document.getElementById('filterCategories').style.display = 'grid';
            document.getElementById('filterSubcategories').style.display = 'none';
            document.getElementById('filterSubsubcategories').style.display = 'none';
            document.getElementById('filterDetails').style.display = 'none';
        }

        function backToSubcategories() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é
            currentSubcategory = null;
            currentSubsubcategory = null;
            selectedFilters.subcategory = null;
            selectedFilters.subsubcategory = null;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            document.getElementById('filterCategories').style.display = 'none';
            document.getElementById('filterSubcategories').style.display = 'block';
            document.getElementById('filterSubsubcategories').style.display = 'none';
            document.getElementById('filterDetails').style.display = 'none';
        }

        function backToSubsubcategories() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ —ç—Ç–æ –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
            // –ï—Å–ª–∏ subsubcategory —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å subcategory, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –±—ã–ª–∞ –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
            const wasTwoLevel = (currentSubsubcategory === currentSubcategory);

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é
            currentSubsubcategory = null;
            selectedFilters.subsubcategory = null;

            if (wasTwoLevel) {
                // –î–ª—è –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
                currentSubcategory = null;
                selectedFilters.subcategory = null;

                document.getElementById('filterCategories').style.display = 'none';
                document.getElementById('filterSubcategories').style.display = 'block';
                document.getElementById('filterSubsubcategories').style.display = 'none';
                document.getElementById('filterDetails').style.display = 'none';

                // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                renderSubcategories(currentCategory);
            } else {
                // –î–ª—è —Ç—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                document.getElementById('filterCategories').style.display = 'none';
                document.getElementById('filterSubcategories').style.display = 'none';
                document.getElementById('filterSubsubcategories').style.display = 'block';
                document.getElementById('filterDetails').style.display = 'none';
            }
        }
        
        function checkImageMatchesFilters(card) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º
            const cardCategories = card.dataset.categories ? card.dataset.categories.split(',') : [];
            const cardObjects = card.dataset.objects ? card.dataset.objects.split(',') : [];
            const cardOriginalObjects = card.dataset.originalObjects ? card.dataset.originalObjects.split(',') : [];

            // –ü–∞—Ä—Å–∏–º JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –∫ –æ–±—ä–µ–∫—Ç–∞–º
            let objectsAttrs = {};
            let originalObjectsAttrs = {};
            try {
                objectsAttrs = JSON.parse(card.dataset.objectsAttrs || '{}');
                originalObjectsAttrs = JSON.parse(card.dataset.originalObjectsAttrs || '{}');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ objectsAttrs:', e);
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (selectedFilters.category) {
                if (!cardCategories.includes(selectedFilters.category)) return false;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (3-–π —É—Ä–æ–≤–µ–Ω—å - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è Ximilar)
            if (selectedFilters.subsubcategory) {
                // –û—Ç–ª–∞–¥–∫–∞ - –≤—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 3 –∫–∞—Ä—Ç–æ—á–∫–∏
                const imageId = card.dataset.imageId;
                if (imageId && parseInt(imageId.substring(imageId.length - 1)) <= 3) {
                    console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ #${imageId}:`);
                    console.log('  cardOriginalObjects:', cardOriginalObjects);
                    console.log('  selectedFilters.subsubcategory:', selectedFilters.subsubcategory);
                    console.log('  includes?', cardOriginalObjects.includes(selectedFilters.subsubcategory));
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                if (!cardOriginalObjects.includes(selectedFilters.subsubcategory)) return false;

                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –¢–û–õ–¨–ö–û –¥–ª—è –Ω–µ—ë
                const subsubcategoryAttrs = originalObjectsAttrs[selectedFilters.subsubcategory] || {colors: [], materials: [], styles: []};

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–≤–µ—Ç–∞–º –¢–û–õ–¨–ö–û –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                if (selectedFilters.colors.length > 0) {
                    const hasMatchingColor = selectedFilters.colors.some(color =>
                        subsubcategoryAttrs.colors.includes(color)
                    );
                    if (!hasMatchingColor) return false;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –¢–û–õ–¨–ö–û –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                if (selectedFilters.materials.length > 0) {
                    const hasMatchingMaterial = selectedFilters.materials.some(material =>
                        subsubcategoryAttrs.materials.includes(material)
                    );
                    if (!hasMatchingMaterial) return false;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∏–ª—è–º –¢–û–õ–¨–ö–û –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–¥–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                if (selectedFilters.styles.length > 0) {
                    const hasMatchingStyle = selectedFilters.styles.some(style =>
                        subsubcategoryAttrs.styles.includes(style)
                    );
                    if (!hasMatchingStyle) return false;
                }
            } else {
                // –ï—Å–ª–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è –ù–ï –≤—ã–±—Ä–∞–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –≥–ª–æ–±–∞–ª—å–Ω–æ (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
                const cardColors = card.dataset.colors ? card.dataset.colors.split(',') : [];
                const cardMaterials = card.dataset.materials ? card.dataset.materials.split(',') : [];
                const cardStyles = card.dataset.styles ? card.dataset.styles.split(',') : [];

                if (selectedFilters.colors.length > 0) {
                    const hasMatchingColor = selectedFilters.colors.some(color =>
                        cardColors.includes(color)
                    );
                    if (!hasMatchingColor) return false;
                }

                if (selectedFilters.materials.length > 0) {
                    const hasMatchingMaterial = selectedFilters.materials.some(material =>
                        cardMaterials.includes(material)
                    );
                    if (!hasMatchingMaterial) return false;
                }

                if (selectedFilters.styles.length > 0) {
                    const hasMatchingStyle = selectedFilters.styles.some(style =>
                        cardStyles.includes(style)
                    );
                    if (!hasMatchingStyle) return false;
                }
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–∞—Ç–∞–º
            if (selectedFilters.dateFrom || selectedFilters.dateTo) {
                const cardDate = card.dataset.taggedAt;

                if (!cardDate) {
                    console.log('‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ –¥–∞—Ç—ã:', card.dataset.imageId);
                    return false;  // –ï—Å–ª–∏ —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ—Ç –¥–∞—Ç—ã, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
                }

                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É (YYYY-MM-DD) –∏–∑ ISO —Å—Ç—Ä–æ–∫–∏
                const imageDate = cardDate.split('T')[0];

                console.log('üìÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã:', {
                    imageId: card.dataset.imageId,
                    imageDate: imageDate,
                    dateFrom: selectedFilters.dateFrom,
                    dateTo: selectedFilters.dateTo,
                    matchFrom: !selectedFilters.dateFrom || imageDate >= selectedFilters.dateFrom,
                    matchTo: !selectedFilters.dateTo || imageDate <= selectedFilters.dateTo
                });

                if (selectedFilters.dateFrom && imageDate < selectedFilters.dateFrom) {
                    return false;
                }

                if (selectedFilters.dateTo && imageDate > selectedFilters.dateTo) {
                    return false;
                }
            }

            return true;
        }
        
        function hasActiveFilters() {
            return selectedFilters.category ||
                   selectedFilters.subcategory ||
                   selectedFilters.subsubcategory ||
                   selectedFilters.colors.length > 0 ||
                   selectedFilters.materials.length > 0 ||
                   selectedFilters.styles.length > 0 ||
                   selectedFilters.dateFrom ||
                   selectedFilters.dateTo;
        }
        
        function clearAdvancedFilters() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            selectedFilters = {
                category: null,
                subcategory: null,
                subsubcategory: null,
                colors: [],
                materials: [],
                styles: [],
                dateFrom: null,
                dateTo: null
            };

            currentCategory = null;
            currentSubcategory = null;
            currentSubsubcategory = null;

            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.filter-option.selected').forEach(option => {
                option.classList.remove('selected');
            });

            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –¥–∞—Ç—ã
            const dateFromInput = document.getElementById('dateFrom');
            const dateToInput = document.getElementById('dateTo');
            if (dateFromInput) dateFromInput.value = '';
            if (dateToInput) dateToInput.value = '';

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            backToCategories();

            // –ï—Å–ª–∏ –º—ã –±—ã–ª–∏ –≤ —Ä–µ–∂–∏–º–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (isFilteredMode) {
                isFilteredMode = false;
                location.reload();
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                document.querySelectorAll('.image-card').forEach(card => {
                    card.style.display = 'block';
                });

                showNotification('‚úÖ –§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ –¥–∞—Ç–µ
        function sortImagesByDate(order = 'desc') {
            const gallery = document.getElementById('gallery');
            if (!gallery) {
                console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç gallery –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            const cards = Array.from(gallery.querySelectorAll('.image-card'));

            console.log(`üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ${order === 'desc' ? '—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ' : '—Å–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ'}`);

            cards.sort((a, b) => {
                const dateA = a.dataset.taggedAt || '';
                const dateB = b.dataset.taggedAt || '';

                if (!dateA && !dateB) return 0;
                if (!dateA) return 1;
                if (!dateB) return -1;

                if (order === 'desc') {
                    return dateB.localeCompare(dateA);
                } else {
                    return dateA.localeCompare(dateB);
                }
            });

            // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º DOM
            cards.forEach(card => gallery.appendChild(card));

            console.log(`‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã`);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–∞–º (gallery –∏ gallery_to_tag)
        async function applySimpleDateFilter() {
            // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–∞—Ç –∏–∑ –ø–æ–ª–µ–π
            const simpleDateFromInput = document.getElementById('simpleDateFrom');
            const simpleDateToInput = document.getElementById('simpleDateTo');
            
            selectedDateFrom = simpleDateFromInput?.value || null;
            selectedDateTo = simpleDateToInput?.value || null;

            if (!selectedDateFrom && !selectedDateTo) {
                showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –¥–∞—Ç—É', 'error');
                return;
            }

            console.log('üîç –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–∞–º (—á–µ—Ä–µ–∑ –ë–î):', {
                dateFrom: selectedDateFrom,
                dateTo: selectedDateTo
            });

            // –û—á–∏—â–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å —Ñ–∏–ª—å—Ç—Ä–æ–º
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '<div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</div>';
            
            currentOffset = 0;
            hasMore = true;

            try {
                let sortOrder = document.getElementById('dateSortOrder')?.value || 'desc';
                let url = `/api/load-more-images?gallery_type=${galleryType}&offset=0&limit=${BATCH_SIZE}&sort_order=${sortOrder}`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º
                if (selectedDateFrom) {
                    url += `&date_from=${encodeURIComponent(selectedDateFrom)}`;
                }
                if (selectedDateTo) {
                    url += `&date_to=${encodeURIComponent(selectedDateTo)}`;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–≥–µ—Ä–∞–º, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω
                if (selectedBloggers.size > 0) {
                    const usernamesParam = Array.from(selectedBloggers).join(',');
                    url += `&usernames=${encodeURIComponent(usernamesParam)}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    gallery.innerHTML = '';
                    if (result.images.length === 0) {
                        gallery.innerHTML = '<div class="no-results">üòî –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                        hasMore = false;
                    } else {
                        renderImages(result.images);
                        currentOffset = result.images.length;
                        hasMore = result.has_more;
                        showNotification(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${result.images.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`, 'success');
                    }
                    updateLoadMoreButton();
                } else {
                    gallery.innerHTML = '<div class="no-results">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>';
                    showNotification(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', error);
                gallery.innerHTML = '<div class="no-results">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>';
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function clearSimpleDateFilter() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞—Ç
            selectedDateFrom = null;
            selectedDateTo = null;

            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –¥–∞—Ç—ã
            const simpleDateFromInput = document.getElementById('simpleDateFrom');
            const simpleDateToInput = document.getElementById('simpleDateTo');
            if (simpleDateFromInput) simpleDateFromInput.value = '';
            if (simpleDateToInput) simpleDateToInput.value = '';

            console.log('‚úÖ –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º —Å–±—Ä–æ—à–µ–Ω');

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–∞–º
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '<div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</div>';
            
            currentOffset = 0;
            hasMore = true;

            try {
                let sortOrder = document.getElementById('dateSortOrder')?.value || 'desc';
                let url = `/api/load-more-images?gallery_type=${galleryType}&offset=0&limit=${BATCH_SIZE}&sort_order=${sortOrder}`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–≥–µ—Ä–∞–º, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω
                if (selectedBloggers.size > 0) {
                    const usernamesParam = Array.from(selectedBloggers).join(',');
                    url += `&usernames=${encodeURIComponent(usernamesParam)}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    gallery.innerHTML = '';
                    if (result.images.length === 0) {
                        gallery.innerHTML = '<div class="no-results">üòî –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                        hasMore = false;
                    } else {
                        renderImages(result.images);
                        currentOffset = result.images.length;
                        hasMore = result.has_more;
                        showNotification(`‚úÖ –§–∏–ª—å—Ç—Ä —Å–±—Ä–æ—à–µ–Ω. –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${result.images.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`, 'success');
                    }
                    updateLoadMoreButton();
                } else {
                    gallery.innerHTML = '<div class="no-results">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>';
                    showNotification(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', error);
                gallery.innerHTML = '<div class="no-results">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>';
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        function showNotification(message, type = 'info') {
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;

            // –¶–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if (type === 'success') {
                notification.style.background = '#28a745';
            } else if (type === 'error') {
                notification.style.background = '#dc3545';
            } else {
                notification.style.background = '#17a2b8';
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
            document.body.appendChild(notification);

            // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function updateImagesCounter(displayedCount, totalCount) {
            const counter = document.getElementById('imagesCounter');
            if (!counter) return;

            const displayedElement = document.getElementById('displayedCount');
            const totalElement = document.getElementById('totalCount');

            if (displayedElement && totalElement) {
                displayedElement.textContent = displayedCount;
                totalElement.textContent = totalCount;
            }
        }

        // ==================== –§–ò–õ–¨–¢–† –ü–û –ë–õ–û–ì–ï–†–ê–ú ====================

        let selectedBloggers = new Set();
        let allBloggers = {}; // –•—Ä–∞–Ω–∏–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–ª–æ–≥–µ—Ä–æ–≤ –∏–∑ –ë–î

        // ==================== –§–ò–õ–¨–¢–† –ü–û –î–ê–¢–ê–ú ====================

        let selectedDateFrom = null;
        let selectedDateTo = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏ —Å —Ç–µ–∫—É—â–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
        async function reloadGalleryWithCurrentFilters() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '<div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</div>';
            
            currentOffset = 0;
            hasMore = true;

            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                let sortOrder = 'desc';
                if (galleryType === 'gallery_tagged') {
                    sortOrder = document.getElementById('taggedDateSortOrder')?.value || 'desc';
                } else {
                    sortOrder = document.getElementById('dateSortOrder')?.value || 'desc';
                }

                let url = `/api/load-more-images?gallery_type=${galleryType}&offset=0&limit=${BATCH_SIZE}&sort_order=${sortOrder}`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–≥–µ—Ä–∞–º
                if (selectedBloggers.size > 0) {
                    const usernamesParam = Array.from(selectedBloggers).join(',');
                    url += `&usernames=${encodeURIComponent(usernamesParam)}`;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º
                if (selectedDateFrom) {
                    url += `&date_from=${encodeURIComponent(selectedDateFrom)}`;
                }
                if (selectedDateTo) {
                    url += `&date_to=${encodeURIComponent(selectedDateTo)}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    gallery.innerHTML = '';
                    if (result.images.length === 0) {
                        gallery.innerHTML = '<div class="no-results">üòî –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                        hasMore = false;
                    } else {
                        renderImages(result.images);
                        currentOffset = result.images.length;
                        hasMore = result.has_more;
                        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${result.images.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`);
                    }
                    updateLoadMoreButton();
                } else {
                    gallery.innerHTML = '<div class="no-results">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>';
                    showNotification(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', error);
                gallery.innerHTML = '<div class="no-results">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>';
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function initBloggersFilter() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –±–ª–æ–≥–µ—Ä–æ–≤ –∏–∑ API (–∏–∑ –ë–î, –∞ –Ω–µ –∏–∑ DOM)
            try {
                const response = await fetch(`/api/get-bloggers?gallery_type=${galleryType}`);
                const result = await response.json();
                
                if (result.success) {
                    allBloggers = {};
                    result.bloggers.forEach(blogger => {
                        allBloggers[blogger.username] = blogger.count;
                    });
                    
                    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ –±–ª–æ–≥–µ—Ä–æ–≤
                    renderBloggersList(allBloggers);
                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${result.total_bloggers} –±–ª–æ–≥–µ—Ä–æ–≤ –∏–∑ –ë–î`);
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª–æ–≥–µ—Ä–æ–≤:', error);
                showNotification(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª–æ–≥–µ—Ä–æ–≤: ${error.message}`, 'error');
            }
        }

        function renderBloggersList(bloggers) {
            const container = document.getElementById('bloggersList');
            if (!container) return;

            container.innerHTML = '';

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –±–ª–æ–≥–µ—Ä–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
            const sortedBloggers = Object.entries(bloggers).sort((a, b) => b[1] - a[1]);

            sortedBloggers.forEach(([username, count]) => {
                const bloggerOption = document.createElement('div');
                bloggerOption.className = 'blogger-option';
                bloggerOption.dataset.username = username;
                bloggerOption.innerHTML = `
                    <div class="blogger-checkbox"></div>
                    <span class="blogger-name">@${username}</span>
                    <span class="blogger-count">(${count})</span>
                `;

                bloggerOption.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleBlogger(username);
                });

                container.appendChild(bloggerOption);
            });
        }

        function toggleBlogger(username) {
            const bloggerOption = document.querySelector(`.blogger-option[data-username="${username}"]`);
            if (!bloggerOption) return;

            if (selectedBloggers.has(username)) {
                selectedBloggers.delete(username);
                bloggerOption.classList.remove('selected');
            } else {
                selectedBloggers.add(username);
                bloggerOption.classList.add('selected');
            }

            console.log('–í—ã–±—Ä–∞–Ω–Ω—ã–µ –±–ª–æ–≥–µ—Ä—ã:', Array.from(selectedBloggers));
        }

        function selectAllBloggers() {
            document.querySelectorAll('.blogger-option').forEach(option => {
                const username = option.dataset.username;
                if (username && !selectedBloggers.has(username)) {
                    selectedBloggers.add(username);
                    option.classList.add('selected');
                }
            });
            console.log('–í—ã–±—Ä–∞–Ω—ã –≤—Å–µ –±–ª–æ–≥–µ—Ä—ã:', Array.from(selectedBloggers));
        }

        async function applyBloggersFilter() {
            if (selectedBloggers.size === 0) {
                showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –±–ª–æ–≥–µ—Ä–∞', 'info');
                return;
            }

            console.log('üîç –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –±–ª–æ–≥–µ—Ä–∞–º (—á–µ—Ä–µ–∑ –ë–î):', Array.from(selectedBloggers));

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥–∞–ª–µ—Ä–µ—é —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –±–ª–æ–≥–µ—Ä–∞–º
            try {
                // –û—á–∏—â–∞–µ–º –≥–∞–ª–µ—Ä–µ—é
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = '<div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</div>';

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º offset –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                currentOffset = 0;
                hasMore = true;

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                let sortOrder = 'desc';
                if (galleryType === 'gallery_tagged') {
                    sortOrder = document.getElementById('taggedDateSortOrder')?.value || 'desc';
                } else {
                    sortOrder = document.getElementById('dateSortOrder')?.value || 'desc';
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –±–ª–æ–≥–µ—Ä–æ–≤ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
                const usernamesParam = Array.from(selectedBloggers).join(',');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Ñ–∏–ª—å—Ç—Ä–æ–º
                const response = await fetch(`/api/load-more-images?gallery_type=${galleryType}&offset=0&limit=${BATCH_SIZE}&sort_order=${sortOrder}&usernames=${encodeURIComponent(usernamesParam)}`);
                const result = await response.json();

                if (result.success) {
                    gallery.innerHTML = '';
                    
                    if (result.images.length === 0) {
                        gallery.innerHTML = '<div class="no-images"><h3>üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3><p>–£ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–ª–æ–≥–µ—Ä–æ–≤ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p></div>';
                    } else {
                        result.images.forEach(image => {
                            appendImageCard(image);
                        });

                        currentOffset = result.images.length;
                        hasMore = result.has_more;

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                        if (result.total_count !== undefined) {
                            updateImagesCounter(result.images.length, result.total_count);
                        }
                    }

                    showNotification(`‚úÖ –ü—Ä–∏–º–µ–Ω—ë–Ω —Ñ–∏–ª—å—Ç—Ä: ${selectedBloggers.size} –±–ª–æ–≥–µ—Ä–æ–≤, ${result.images.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`, 'success');
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                    gallery.innerHTML = '<div class="no-images"><h3>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3></div>';
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                console.error('Error applying bloggers filter:', error);
            }
        }

        async function clearBloggersFilter() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            selectedBloggers.clear();

            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –æ–ø—Ü–∏–π
            document.querySelectorAll('.blogger-option.selected').forEach(option => {
                option.classList.remove('selected');
            });

            console.log('‚úÖ –§–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–≥–µ—Ä–∞–º —Å–±—Ä–æ—à–µ–Ω');

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
            try {
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = '<div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</div>';

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º offset
                currentOffset = 0;
                hasMore = true;

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                let sortOrder = 'desc';
                if (galleryType === 'gallery_tagged') {
                    sortOrder = document.getElementById('taggedDateSortOrder')?.value || 'desc';
                } else {
                    sortOrder = document.getElementById('dateSortOrder')?.value || 'desc';
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–∞
                const response = await fetch(`/api/load-more-images?gallery_type=${galleryType}&offset=0&limit=${BATCH_SIZE}&sort_order=${sortOrder}`);
                const result = await response.json();

                if (result.success) {
                    gallery.innerHTML = '';
                    
                    result.images.forEach(image => {
                        appendImageCard(image);
                    });
                    
                    currentOffset = result.images.length;
                    hasMore = result.has_more;

                    showNotification('‚úÖ –§–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–≥–µ—Ä–∞–º —Å–±—Ä–æ—à–µ–Ω', 'success');
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                console.error('Error clearing bloggers filter:', error);
            }
        }

        // ==================== INFINITE SCROLL ====================

        function setupInfiniteScroll() {
            window.addEventListener('scroll', handleScroll);
            console.log(`üîÑ Infinite scroll activated for gallery type: ${galleryType}`);
        }

        function handleScroll() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∏–≥ –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const scrollPosition = window.innerHeight + window.scrollY;
            const pageHeight = document.documentElement.scrollHeight;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ 80% –ø—Ä–æ–∫—Ä—É—Ç–∏–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (scrollPosition >= pageHeight * 0.8 && !isLoading && hasMore) {
                loadMoreImages();
            }
        }

        // ==================== –ö–ù–û–ü–ö–ê "–ü–û–ö–ê–ó–ê–¢–¨ –ï–©–ï" ====================

        function setupLoadMoreButton() {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', loadMoreImages);
            }
            updateLoadMoreButton();
        }

        function updateLoadMoreButton() {
            const container = document.getElementById('loadMoreContainer');
            const status = document.getElementById('loadMoreStatus');
            
            if (!container || !status) return;

            if (hasMore) {
                container.style.display = 'block';
                const gallery = document.querySelectorAll('.image-card').length;
                status.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ${gallery}. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –≤–Ω–∏–∑ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –µ—â–µ.`;
            } else {
                container.style.display = 'none';
            }
        }

        async function loadMoreImages() {
            if (isLoading || !hasMore) return;

            isLoading = true;
            console.log(`üì• Loading more images... offset: ${currentOffset}, limit: ${BATCH_SIZE}`);

            try {
                let url;

                // –ï—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º endpoint –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                if (isFilteredMode) {
                    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏ confidence filter
                    const useConfidence = document.getElementById('useConfidenceFilter')?.checked ?? true;
                    const confidenceThreshold = parseInt(document.getElementById('confidenceSlider')?.value ?? 60);
                    url = `/api/filtered-images?offset=${currentOffset}&limit=${BATCH_SIZE}&use_confidence=${useConfidence}&confidence_threshold=${confidenceThreshold}`;

                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                    if (selectedFilters.category) {
                        url += `&category=${encodeURIComponent(selectedFilters.category)}`;
                    }
                    if (selectedFilters.subcategory) {
                        url += `&subcategory=${encodeURIComponent(selectedFilters.subcategory)}`;
                    }
                    if (selectedFilters.subsubcategory) {
                        url += `&subsubcategory=${encodeURIComponent(selectedFilters.subsubcategory)}`;
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ü–≤–µ—Ç–∞–º
                    if (selectedFilters.colors && selectedFilters.colors.length > 0) {
                        selectedFilters.colors.forEach(color => {
                            url += `&colors[]=${encodeURIComponent(color)}`;
                        });
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
                    if (selectedFilters.materials && selectedFilters.materials.length > 0) {
                        selectedFilters.materials.forEach(material => {
                            url += `&materials[]=${encodeURIComponent(material)}`;
                        });
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç–∏–ª—è–º
                    if (selectedFilters.styles && selectedFilters.styles.length > 0) {
                        selectedFilters.styles.forEach(style => {
                            url += `&styles[]=${encodeURIComponent(style)}`;
                        });
                    }
                } else {
                    // –û–±—ã—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                    let sortOrder = 'desc';
                    if (galleryType === 'gallery_tagged') {
                        sortOrder = document.getElementById('taggedDateSortOrder')?.value || 'desc';
                    } else {
                        sortOrder = document.getElementById('dateSortOrder')?.value || 'desc';
                    }

                    // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
                    url = `/api/load-more-images?gallery_type=${galleryType}&offset=${currentOffset}&limit=${BATCH_SIZE}&sort_order=${sortOrder}`;

                    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–≥–µ—Ä–∞–º
                    if (selectedBloggers.size > 0) {
                        const usernamesParam = Array.from(selectedBloggers).join(',');
                        url += `&usernames=${encodeURIComponent(usernamesParam)}`;
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º
                    if (selectedDateFrom) {
                        url += `&date_from=${encodeURIComponent(selectedDateFrom)}`;
                    }
                    if (selectedDateTo) {
                        url += `&date_to=${encodeURIComponent(selectedDateTo)}`;
                    }
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    console.log(`‚úÖ Loaded ${result.images.length} images`);

                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≥–∞–ª–µ—Ä–µ—é
                    result.images.forEach(image => {
                        appendImageCard(image);
                    });

                    // –û–±–Ω–æ–≤–ª—è–µ–º offset
                    currentOffset += result.images.length;
                    hasMore = result.has_more;

                    if (!hasMore) {
                        console.log('‚úÖ All images loaded');
                    }
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, 'error');
                console.error('Error loading more images:', error);
            } finally {
                isLoading = false;
                updateLoadMoreButton();
            }
        }

        function renderImages(images) {
            // –†–µ–Ω–¥–µ—Ä–∏–º –º–∞—Å—Å–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            images.forEach(image => {
                appendImageCard(image);
            });
        }

        function appendImageCard(image) {
            const gallery = document.getElementById('gallery');

            // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≥–∞–ª–µ—Ä–µ–µ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
            if (document.querySelector(`[data-image-id="${image._id}"]`)) {
                console.warn(`‚ö†Ô∏è  –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${image._id} (${image.local_filename}) —É–∂–µ –≤ –≥–∞–ª–µ—Ä–µ–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const card = document.createElement('div');
            card.className = 'image-card';
            card.dataset.imageId = image._id;
            card.dataset.username = image.username;
            card.dataset.caption = image.caption || '';
            card.dataset.taggedAt = image.timestamp || '';
            card.onclick = function() { toggleSelection(image._id); };

            // –ï—Å–ª–∏ —ç—Ç–æ –≥–∞–ª–µ—Ä–µ—è —Å —Ç–µ–≥–∞–º–∏, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã
            if (galleryType === 'gallery_tagged' && image.ximilar_objects_structured) {
                processTaggedImageData(card, image);
            }

            // HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            let cardHTML = `
                <div class="image-container">
                    <img src="/images/${image.local_filename}" alt="${image.caption || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'}" loading="lazy">
                    <div class="checkbox"></div>
                </div>
                <div class="image-info">
                    <div class="username">@${image.username}</div>
                    <div class="stats">
                        <span>‚ù§Ô∏è ${image.likes_count && image.likes_count >= 0 ? image.likes_count : 0}</span>
                        <span>üí¨ ${image.comments_count && image.comments_count >= 0 ? image.comments_count : 0}</span>
                    </div>
                    ${image.timestamp ? `<div class="post-date">üìÖ ${image.timestamp.substring(0, 10)}</div>` : ''}
                    <div class="caption">${image.caption || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
            `;

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥–∏, –µ—Å–ª–∏ —ç—Ç–æ –≥–∞–ª–µ—Ä–µ—è –æ—Ç—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
            if (galleryType === 'gallery_tagged') {
                cardHTML += renderTags(image);
            }

            cardHTML += '</div>';
            card.innerHTML = cardHTML;

            gallery.appendChild(card);
            return card;
        }

        // –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π (–∞–Ω–∞–ª–æ–≥ Python —Ñ—É–Ω–∫—Ü–∏–∏)
        function normalizeSubcategoryName(subcategory, category) {
            const subcategoryLower = subcategory.toLowerCase();

            const normalizationRules = {
                'Accessories': {
                    'Bags': ['bag', 'handbag', 'tote', 'clutch', 'crossbody', 'purse', 'wallet'],
                    'Hats': ['hat', 'cap', 'beanie', 'fedora'],
                    'Sunglasses': ['sunglass', 'eyewear'],
                    'Belts': ['belt'],
                    'Jewelry': ['jewelry', 'jewellery', 'necklace', 'bracelet', 'ring', 'earring'],
                    'Watches': ['watch'],
                    'Scarves': ['scarf', 'scarves'],
                    'Gloves': ['glove', 'mitten'],
                },
                'Clothing': {
                    'Dresses': ['dress'],
                    'Pants': ['pant', 'trouser', 'jean'],
                    'Skirts': ['skirt'],
                    'Tops': ['top', 'blouse', 'shirt', 't-shirt', 'tank'],
                    'Jackets': ['jacket', 'coat', 'blazer', 'cardigan'],
                    'Shorts': ['short'],
                },
                'Footwear': {
                    'Shoes': ['shoe'],
                    'Sneakers': ['sneaker', 'trainer'],
                    'Boots': ['boot'],
                    'Heels': ['heel', 'stiletto', 'pump'],
                    'Sandals': ['sandal', 'flip-flop'],
                    'Flats': ['flat', 'loafer', 'ballet'],
                }
            };

            // –ò—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (normalizationRules[category]) {
                for (const [baseName, keywords] of Object.entries(normalizationRules[category])) {
                    for (const keyword of keywords) {
                        if (subcategoryLower.includes(keyword)) {
                            return baseName;
                        }
                    }
                }
            }

            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
            return subcategory;
        }

        function processTaggedImageData(card, image) {
            // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –ª–æ–≥–∏–∫–µ)
            const uniqueCategories = [];
            const uniqueObjects = [];
            const uniqueColors = [];
            const uniqueMaterials = [];
            const uniqueStyles = [];
            const uniqueObjectsByName = {};
            const objectsAttrs = {};

            if (!image.ximilar_objects_structured) return;

            // –°–Ω–∞—á–∞–ª–∞ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã –ø–æ –∏—Ö –æ—Å–Ω–æ–≤–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é —Å —É—á—ë—Ç–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            image.ximilar_objects_structured.forEach(obj => {
                const objCategory = obj.top_category || 'Other';
                let objName = '';

                if (obj.properties && obj.properties.other_attributes) {
                    if (obj.properties.other_attributes.Subcategory && obj.properties.other_attributes.Subcategory.length > 0) {
                        objName = obj.properties.other_attributes.Subcategory[0].name;
                    } else if (obj.properties.other_attributes.Category && obj.properties.other_attributes.Category.length > 0) {
                        objName = obj.properties.other_attributes.Category[0].name;
                    }
                }

                if (objName) {
                    const normalizedName = normalizeSubcategoryName(objName, objCategory);
                    if (!uniqueObjectsByName[normalizedName]) {
                        uniqueObjectsByName[normalizedName] = obj;
                    }
                }
            });

            // –¢–µ–ø–µ—Ä—å —Å–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ –∏ —Å–æ–∑–¥–∞—ë–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É objectsAttrs
            Object.entries(uniqueObjectsByName).forEach(([normalizedName, obj]) => {
                // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
                if (obj.top_category && !uniqueCategories.includes(obj.top_category)) {
                    uniqueCategories.push(obj.top_category);
                }

                // –û–±—ä–µ–∫—Ç—ã
                if (!uniqueObjects.includes(normalizedName)) {
                    uniqueObjects.push(normalizedName);
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
                if (!objectsAttrs[normalizedName]) {
                    objectsAttrs[normalizedName] = {colors: [], materials: [], styles: []};
                }

                // –¶–≤–µ—Ç–∞ —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
                if (obj.properties && obj.properties.visual_attributes && obj.properties.visual_attributes.Color) {
                    obj.properties.visual_attributes.Color.forEach(color => {
                        if (!uniqueColors.includes(color.name)) {
                            uniqueColors.push(color.name);
                        }
                        if (!objectsAttrs[normalizedName].colors.includes(color.name)) {
                            objectsAttrs[normalizedName].colors.push(color.name);
                        }
                    });
                }

                // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
                if (obj.properties && obj.properties.material_attributes && obj.properties.material_attributes.Material) {
                    obj.properties.material_attributes.Material.forEach(material => {
                        if (!uniqueMaterials.includes(material.name)) {
                            uniqueMaterials.push(material.name);
                        }
                        if (!objectsAttrs[normalizedName].materials.includes(material.name)) {
                            objectsAttrs[normalizedName].materials.push(material.name);
                        }
                    });
                }

                // –°—Ç–∏–ª–∏ —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
                if (obj.properties && obj.properties.style_attributes && obj.properties.style_attributes.Style) {
                    obj.properties.style_attributes.Style.forEach(style => {
                        if (!uniqueStyles.includes(style.name)) {
                            uniqueStyles.push(style.name);
                        }
                        if (!objectsAttrs[normalizedName].styles.includes(style.name)) {
                            objectsAttrs[normalizedName].styles.push(style.name);
                        }
                    });
                }
            });

            // –î–æ–±–∞–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            card.dataset.categories = uniqueCategories.join(',');
            card.dataset.objects = uniqueObjects.join(',');
            card.dataset.colors = uniqueColors.join(',');
            card.dataset.materials = uniqueMaterials.join(',');
            card.dataset.styles = uniqueStyles.join(',');
            card.dataset.objectsAttrs = JSON.stringify(objectsAttrs);
        }

        function renderTags(image) {
            if (!image.ximilar_objects_structured || image.ximilar_objects_structured.length === 0) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –æ–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —Ç–µ–≥–∏
                if (image.ximilar_tags && image.ximilar_tags.length > 0) {
                    let tagsHTML = '<div class="ximilar-tags">';
                    const tagsToShow = image.ximilar_tags.slice(0, 3);
                    tagsToShow.forEach(tag => {
                        tagsHTML += `<span class="tag">${tag.name}</span>`;
                    });
                    if (image.ximilar_tags.length > 3) {
                        tagsHTML += `<span class="tag-more">+${image.ximilar_tags.length - 3} –µ—â–µ</span>`;
                    }
                    tagsHTML += '</div>';
                    return tagsHTML;
                }
                return '';
            }

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const categories = {};
            image.ximilar_objects_structured.forEach(obj => {
                const category = obj.top_category || 'other';
                if (!categories[category]) {
                    categories[category] = [];
                }

                let objInfo = '';
                if (obj.properties) {
                    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
                    if (obj.properties.other_attributes && obj.properties.other_attributes.Subcategory && obj.properties.other_attributes.Subcategory.length > 0) {
                        objInfo = obj.properties.other_attributes.Subcategory[0].name;
                    } else if (obj.properties.other_attributes && obj.properties.other_attributes.Category && obj.properties.other_attributes.Category.length > 0) {
                        objInfo = obj.properties.other_attributes.Category[0].name;
                    } else {
                        objInfo = obj.name;
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã
                    const attrs = [];
                    if (obj.properties.visual_attributes && obj.properties.visual_attributes.Color && obj.properties.visual_attributes.Color.length > 0) {
                        attrs.push(obj.properties.visual_attributes.Color[0].name);
                    }
                    if (obj.properties.material_attributes && obj.properties.material_attributes.Material && obj.properties.material_attributes.Material.length > 0) {
                        attrs.push(obj.properties.material_attributes.Material[0].name);
                    }
                    if (obj.properties.style_attributes && obj.properties.style_attributes.Style && obj.properties.style_attributes.Style.length > 0) {
                        attrs.push(obj.properties.style_attributes.Style[0].name);
                    }

                    if (attrs.length > 0) {
                        objInfo += ` (${attrs.join(', ')})`;
                    }
                }

                categories[category].push(objInfo);
            });

            // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–≥–∏
            let tagsHTML = '<div class="ximilar-tags">';
            for (const [category, objects] of Object.entries(categories)) {
                tagsHTML += `
                    <div class="category-group">
                        <span class="category-name">${category}:</span>
                        <span class="category-objects">${objects.join(', ')}</span>
                    </div>
                `;
            }
            tagsHTML += '</div>';

            return tagsHTML;
        }
    </script>
</body>
</html>
