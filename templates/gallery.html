<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .navigation {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: white;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #667eea;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-orange {
            background: #ff6b35;
            color: white;
        }
        
        .btn-orange:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }
        
        .ximilar-tags {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #ff6b35;
        }
        
        .ximilar-tags strong {
            color: #495057;
            font-size: 12px;
            display: block;
            margin-bottom: 4px;
        }
        
        .tag {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin: 2px 2px 2px 0;
            font-weight: 500;
        }
        
        .tag-more {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin: 2px 2px 2px 0;
            font-weight: 500;
        }
        
        .advanced-filters {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-option {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .filter-option:hover {
            background: #e9ecef;
        }
        
        .filter-option.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        
        .category-group {
            margin: 2px 0;
            padding: 3px 6px;
            background: #ffffff;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-size: 10px;
        }
        
        .category-name {
            font-weight: 600;
            color: #495057;
            text-transform: capitalize;
        }
        
        .category-objects {
            color: #6c757d;
            margin-left: 4px;
        }
        
        .gallery {
            padding: 30px;
            column-count: 4;
            column-gap: 25px;
        }
        
        @media (max-width: 1200px) {
            .gallery {
                column-count: 3;
            }
        }
        
        @media (max-width: 800px) {
            .gallery {
                column-count: 2;
            }
        }
        
        @media (max-width: 500px) {
            .gallery {
                column-count: 1;
            }
        }
        
        .image-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border: 3px solid transparent;
            break-inside: avoid;
            margin-bottom: 25px;
            display: inline-block;
            width: 100%;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .image-card.selected {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .image-container {
            position: relative;
            overflow: hidden;
        }
        
        .image-container img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s;
        }
        
        .image-card:hover .image-container img {
            transform: scale(1.05);
        }
        
        .checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 25px;
            height: 25px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #667eea;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .checkbox.checked {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        .image-info {
            padding: 20px;
        }
        
        .username {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .caption {
            font-size: 0.9em;
            color: #495057;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .selected-count {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .no-images {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.2em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.1em;
        }
        
        @media (max-width: 768px) {
            .gallery {
                column-count: 2;
                column-gap: 15px;
                padding: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h1>
            {% if current_page == 'gallery' %}
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            {% elif current_page == 'gallery_to_tag' %}
                <p>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            {% else %}
                <p>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Ç–µ–≥–∞–º–∏ Ximilar</p>
            {% endif %}
            
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
            <div class="navigation">
                <a href="/gallery" class="nav-btn {% if current_page == 'gallery' %}active{% endif %}">
                    üì∑ –ì–∞–ª–µ—Ä–µ—è
                </a>
                <a href="/gallery_to_tag" class="nav-btn {% if current_page == 'gallery_to_tag' %}active{% endif %}">
                    üè∑Ô∏è –í—ã–±—Ä–∞–Ω–æ –¥–ª—è —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                </a>
                <a href="/gallery_tagged" class="nav-btn {% if current_page == 'gallery_tagged' %}active{% endif %}">
                    ‚úÖ –û—Ç—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω—ã
                </a>
            </div>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ø–æ–¥–ø–∏—Å–∏ –∏–ª–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
                <button class="filter-btn" data-filter="selected">–í—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                <button class="filter-btn" data-filter="unselected">–ù–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                {% if current_page == 'gallery_tagged' %}
                <button class="filter-btn" id="toggleAdvancedFilters">üîç –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
                {% endif %}
            </div>
            
            {% if current_page == 'gallery_tagged' %}
            <div class="advanced-filters" id="advancedFilters" style="display: none;">
                <div class="filter-section">
                    <h4>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
                    <div class="filter-options" id="categoryFilters"></div>
                </div>
                
                <div class="filter-section">
                    <h4>–û–±—ä–µ–∫—Ç—ã</h4>
                    <div class="filter-options" id="objectFilters"></div>
                </div>
                
                <div class="filter-section">
                    <h4>–¶–≤–µ—Ç–∞</h4>
                    <div class="filter-options" id="colorFilters"></div>
                </div>
                
                <div class="filter-section">
                    <h4>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h4>
                    <div class="filter-options" id="materialFilters"></div>
                </div>
                
                <div class="filter-section">
                    <h4>–°—Ç–∏–ª–∏</h4>
                    <div class="filter-options" id="styleFilters"></div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-primary" id="applyFiltersBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    <button class="btn btn-secondary" id="clearFiltersBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>
            {% endif %}
            
            <div class="action-buttons">
                {% if current_page == 'gallery' %}
                    <button class="btn btn-primary" id="selectAllBtn">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
                    <button class="btn btn-primary" id="markForTaggingBtn" disabled>
                        –û—Ç–º–µ—Ç–∏—Ç—å –¥–ª—è —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                {% elif current_page == 'gallery_to_tag' %}
                    <button class="btn btn-primary" id="selectAllBtn">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
                    <button class="btn btn-secondary" id="unmarkBtn" disabled>
                        –£–±—Ä–∞—Ç—å –∏–∑ —Ç–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                    <button class="btn btn-orange" id="tagImagesBtn" disabled>
                        üè∑Ô∏è –¢–µ–≥–≥–∏—Ä–æ–≤–∞—Ç—å
                        <span class="selected-count" id="selectedCount">0</span>
                    </button>
                {% else %}
                    <button class="btn btn-primary" id="selectAllBtn">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
                {% endif %}
            </div>
        </div>
        
        <div class="gallery" id="gallery">
            {% if images %}
                {% for image in images %}
                <div class="image-card" 
                     data-image-id="{{ image._id }}" 
                     data-username="{{ image.username }}" 
                     data-caption="{{ image.caption or '' }}"
                     {% if current_page == 'gallery_tagged' and image.ximilar_objects_structured %}
                     data-categories="{% for obj in image.ximilar_objects_structured %}{{ obj.top_category or '' }}{% if not loop.last %},{% endif %}{% endfor %}"
                     data-objects="{% for obj in image.ximilar_objects_structured %}{% if obj.properties.other_attributes.Subcategory %}{{ obj.properties.other_attributes.Subcategory[0].name }}{% elif obj.properties.other_attributes.Category %}{{ obj.properties.other_attributes.Category[0].name }}{% endif %}{% if not loop.last %},{% endif %}{% endfor %}"
                     data-colors="{% for obj in image.ximilar_objects_structured %}{% if obj.properties.visual_attributes.Color %}{{ obj.properties.visual_attributes.Color[0].name }}{% endif %}{% if not loop.last %},{% endif %}{% endfor %}"
                     data-materials="{% for obj in image.ximilar_objects_structured %}{% if obj.properties.material_attributes.Material %}{{ obj.properties.material_attributes.Material[0].name }}{% endif %}{% if not loop.last %},{% endif %}{% endfor %}"
                     data-styles="{% for obj in image.ximilar_objects_structured %}{% if obj.properties.style_attributes.Style %}{{ obj.properties.style_attributes.Style[0].name }}{% endif %}{% if not loop.last %},{% endif %}{% endfor %}"
                     {% endif %}>
                    <div class="image-container">
                        <img src="/images/{{ image.local_filename }}" alt="{{ image.caption or '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' }}" loading="lazy">
                        <div class="checkbox" onclick="toggleSelection('{{ image._id }}')"></div>
                    </div>
                    <div class="image-info">
                        <div class="username">@{{ image.username }}</div>
                        <div class="stats">
                            <span>‚ù§Ô∏è {{ image.likes_count or 0 }}</span>
                            <span>üí¨ {{ image.comments_count or 0 }}</span>
                        </div>
                        <div class="caption">{{ image.caption or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}</div>
                        {% if current_page == 'gallery_tagged' and image.ximilar_objects_structured %}
                            <div class="ximilar-tags">
                                {% set categories = {} %}
                                {% for obj in image.ximilar_objects_structured %}
                                    {% set category = obj.top_category or 'other' %}
                                    {% if category not in categories %}
                                        {% set _ = categories.update({category: []}) %}
                                    {% endif %}
                                    
                                    {% set obj_info = '' %}
                                    {% set color = '' %}
                                    {% set material = '' %}
                                    {% set style = '' %}
                                    
                                    {% if obj.properties %}
                                        {# –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ Subcategory #}
                                        {% if obj.properties.other_attributes and obj.properties.other_attributes.Subcategory %}
                                            {% set subcategory_list = obj.properties.other_attributes.Subcategory %}
                                            {% if subcategory_list and subcategory_list|length > 0 %}
                                                {% set obj_info = subcategory_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# –ï—Å–ª–∏ –Ω–µ—Ç Subcategory, –∏—Å–ø–æ–ª—å–∑—É–µ–º Category #}
                                        {% if not obj_info and obj.properties.other_attributes and obj.properties.other_attributes.Category %}
                                            {% set category_list = obj.properties.other_attributes.Category %}
                                            {% if category_list and category_list|length > 0 %}
                                                {% set obj_info = category_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º name #}
                                        {% if not obj_info %}
                                            {% set obj_info = obj.name %}
                                        {% endif %}
                                        
                                        {# –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –∏–∑ visual_attributes.Color #}
                                        {% if obj.properties.visual_attributes and obj.properties.visual_attributes.Color %}
                                            {% set color_list = obj.properties.visual_attributes.Color %}
                                            {% if color_list and color_list|length > 0 %}
                                                {% set color = color_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# –ü–æ–ª—É—á–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ material_attributes.Material #}
                                        {% if obj.properties.material_attributes and obj.properties.material_attributes.Material %}
                                            {% set material_list = obj.properties.material_attributes.Material %}
                                            {% if material_list and material_list|length > 0 %}
                                                {% set material = material_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∏–ª—å –∏–∑ style_attributes.Style #}
                                        {% if obj.properties.style_attributes and obj.properties.style_attributes.Style %}
                                            {% set style_list = obj.properties.style_attributes.Style %}
                                            {% if style_list and style_list|length > 0 %}
                                                {% set style = style_list[0].name %}
                                            {% endif %}
                                        {% endif %}
                                        
                                        {% if color or material or style %}
                                            {% set properties = [] %}
                                            {% if color %}{% set _ = properties.append(color) %}{% endif %}
                                            {% if material %}{% set _ = properties.append(material) %}{% endif %}
                                            {% if style %}{% set _ = properties.append(style) %}{% endif %}
                                            {% set obj_info = obj_info + ' (' + properties|join(', ') + ')' %}
                                        {% endif %}
                                    {% endif %}
                                    
                                    {% set _ = categories[category].append(obj_info) %}
                                {% endfor %}
                                
                                {% for category, objects in categories.items() %}
                                    <div class="category-group">
                                        <span class="category-name">{{ category }}:</span>
                                        <span class="category-objects">{{ objects|join(', ') }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% elif current_page == 'gallery_tagged' and image.ximilar_tags %}
                            <div class="ximilar-tags">
                                {% for tag in image.ximilar_tags[:3] %}
                                    <span class="tag">{{ tag.name }}</span>
                                {% endfor %}
                                {% if image.ximilar_tags|length > 3 %}
                                    <span class="tag-more">+{{ image.ximilar_tags|length - 3 }} –µ—â–µ</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-images">
                    <h3>üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p>–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–∞—Ä—Å–∏–Ω–≥ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ Instagram</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        let selectedImages = new Set();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectedCount();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // –ü–æ–∏—Å–∫
            document.getElementById('searchInput').addEventListener('input', filterImages);
            
            // –§–∏–ª—å—Ç—Ä—ã
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterImages();
                });
            });
            
            // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            const selectAllBtn = document.getElementById('selectAllBtn');
            const clearSelectionBtn = document.getElementById('clearSelectionBtn');
            const markForTaggingBtn = document.getElementById('markForTaggingBtn');
            const unmarkBtn = document.getElementById('unmarkBtn');
            const tagImagesBtn = document.getElementById('tagImagesBtn');
            
            if (selectAllBtn) selectAllBtn.addEventListener('click', selectAll);
            if (clearSelectionBtn) clearSelectionBtn.addEventListener('click', clearSelection);
            if (markForTaggingBtn) markForTaggingBtn.addEventListener('click', markForTagging);
            if (unmarkBtn) unmarkBtn.addEventListener('click', unmarkForTagging);
            if (tagImagesBtn) tagImagesBtn.addEventListener('click', tagImages);
            
            // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
            if ('{{ current_page }}' === 'gallery_tagged') {
                const toggleAdvancedFiltersBtn = document.getElementById('toggleAdvancedFilters');
                const advancedFilters = document.getElementById('advancedFilters');
                const applyFiltersBtn = document.getElementById('applyFiltersBtn');
                const clearFiltersBtn = document.getElementById('clearFiltersBtn');
                
                if (toggleAdvancedFiltersBtn && advancedFilters) {
                    toggleAdvancedFiltersBtn.addEventListener('click', () => {
                        if (advancedFilters.style.display === 'none') {
                            advancedFilters.style.display = 'block';
                            toggleAdvancedFiltersBtn.textContent = 'üîç –°–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã';
                            loadFilterOptions();
                        } else {
                            advancedFilters.style.display = 'none';
                            toggleAdvancedFiltersBtn.textContent = 'üîç –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã';
                        }
                    });
                }
                
                if (applyFiltersBtn) {
                    applyFiltersBtn.addEventListener('click', applyAdvancedFilters);
                }
                
                if (clearFiltersBtn) {
                    clearFiltersBtn.addEventListener('click', clearAdvancedFilters);
                }
            }
        }
        
        function toggleSelection(imageId) {
            const card = document.querySelector(`[data-image-id="${imageId}"]`);
            const checkbox = card.querySelector('.checkbox');
            
            if (selectedImages.has(imageId)) {
                selectedImages.delete(imageId);
                card.classList.remove('selected');
                checkbox.classList.remove('checked');
            } else {
                selectedImages.add(imageId);
                card.classList.add('selected');
                checkbox.classList.add('checked');
            }
            
            updateSelectedCount();
        }
        
        function selectAll() {
            const visibleCards = getVisibleCards();
            visibleCards.forEach(card => {
                const imageId = card.dataset.imageId;
                selectedImages.add(imageId);
                card.classList.add('selected');
                card.querySelector('.checkbox').classList.add('checked');
            });
            updateSelectedCount();
        }
        
        function clearSelection() {
            selectedImages.clear();
            document.querySelectorAll('.image-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.checkbox').classList.remove('checked');
            });
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const count = selectedImages.size;
            const selectedCountElements = document.querySelectorAll('#selectedCount');
            
            selectedCountElements.forEach(element => {
                element.textContent = count;
            });
            
            const markForTaggingBtn = document.getElementById('markForTaggingBtn');
            const unmarkBtn = document.getElementById('unmarkBtn');
            const tagImagesBtn = document.getElementById('tagImagesBtn');
            
            if (markForTaggingBtn) markForTaggingBtn.disabled = count === 0;
            if (unmarkBtn) unmarkBtn.disabled = count === 0;
            if (tagImagesBtn) tagImagesBtn.disabled = count === 0;
        }
        
        function filterImages() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            
            document.querySelectorAll('.image-card').forEach(card => {
                const username = card.dataset.username.toLowerCase();
                const caption = card.dataset.caption.toLowerCase();
                const isSelected = selectedImages.has(card.dataset.imageId);
                
                let matchesSearch = username.includes(searchTerm) || caption.includes(searchTerm);
                let matchesFilter = true;
                
                if (activeFilter === 'selected') {
                    matchesFilter = isSelected;
                } else if (activeFilter === 'unselected') {
                    matchesFilter = !isSelected;
                }
                
                card.style.display = (matchesSearch && matchesFilter) ? 'block' : 'none';
            });
        }
        
        function getVisibleCards() {
            return Array.from(document.querySelectorAll('.image-card')).filter(card => 
                card.style.display !== 'none'
            );
        }
        
        async function markForTagging() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('markForTaggingBtn');
            
            if (!button) {
                console.error('–ö–Ω–æ–ø–∫–∞ markForTaggingBtn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            button.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/mark-for-tagging', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    clearSelection();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function unmarkForTagging() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('unmarkBtn');
            
            if (!button) {
                console.error('–ö–Ω–æ–ø–∫–∞ unmarkBtn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            button.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/unmark-for-tagging', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    clearSelection();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function tagImages() {
            if (selectedImages.size === 0) return;
            
            const imageIds = Array.from(selectedImages);
            const button = document.getElementById('tagImagesBtn');
            
            if (!button) {
                console.error('–ö–Ω–æ–ø–∫–∞ tagImagesBtn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const originalText = button.innerHTML;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            button.innerHTML = '‚è≥ –¢–µ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/tag-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_ids: imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    clearSelection();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        let filterOptions = {};
        let selectedFilters = {
            categories: [],
            objects: [],
            colors: [],
            materials: [],
            styles: []
        };
        
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter-options');
                const result = await response.json();
                
                if (result.success) {
                    filterOptions = result.filter_options;
                    renderFilterOptions();
                } else {
                    showNotification(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤: ${error.message}`, 'error');
            }
        }
        
        function renderFilterOptions() {
            // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            renderFilterSection('categoryFilters', filterOptions.categories, 'categories');
            
            // –û–±—ä–µ–∫—Ç—ã
            renderFilterSection('objectFilters', filterOptions.objects, 'objects');
            
            // –¶–≤–µ—Ç–∞
            renderFilterSection('colorFilters', filterOptions.colors, 'colors');
            
            // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
            renderFilterSection('materialFilters', filterOptions.materials, 'materials');
            
            // –°—Ç–∏–ª–∏
            renderFilterSection('styleFilters', filterOptions.styles, 'styles');
        }
        
        function renderFilterSection(containerId, options, filterType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            options.forEach(option => {
                const filterOption = document.createElement('div');
                filterOption.className = 'filter-option';
                filterOption.textContent = option;
                filterOption.dataset.filterType = filterType;
                filterOption.dataset.value = option;
                
                filterOption.addEventListener('click', () => {
                    filterOption.classList.toggle('selected');
                    
                    if (filterOption.classList.contains('selected')) {
                        if (!selectedFilters[filterType].includes(option)) {
                            selectedFilters[filterType].push(option);
                        }
                    } else {
                        selectedFilters[filterType] = selectedFilters[filterType].filter(item => item !== option);
                    }
                });
                
                container.appendChild(filterOption);
            });
        }
        
        function applyAdvancedFilters() {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
            const cards = document.querySelectorAll('.image-card');
            
            cards.forEach(card => {
                let showCard = true;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞–º
                if (hasActiveFilters()) {
                    showCard = checkImageMatchesFilters(card);
                }
                
                card.style.display = showCard ? 'block' : 'none';
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            const visibleCards = document.querySelectorAll('.image-card[style*="block"], .image-card:not([style*="none"])');
            showNotification(`‚úÖ –ü–æ–∫–∞–∑–∞–Ω–æ ${visibleCards.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`, 'success');
        }
        
        function checkImageMatchesFilters(card) {
            // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º
            // –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å data-–∞—Ç—Ä–∏–±—É—Ç—ã –∫ –∫–∞—Ä—Ç–æ—á–∫–∞–º —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–µ–≥–∞—Ö
            const cardCategories = card.dataset.categories ? card.dataset.categories.split(',') : [];
            const cardObjects = card.dataset.objects ? card.dataset.objects.split(',') : [];
            const cardColors = card.dataset.colors ? card.dataset.colors.split(',') : [];
            const cardMaterials = card.dataset.materials ? card.dataset.materials.split(',') : [];
            const cardStyles = card.dataset.styles ? card.dataset.styles.split(',') : [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            if (selectedFilters.categories.length > 0) {
                const hasMatchingCategory = selectedFilters.categories.some(cat => 
                    cardCategories.includes(cat)
                );
                if (!hasMatchingCategory) return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–±—ä–µ–∫—Ç–∞–º
            if (selectedFilters.objects.length > 0) {
                const hasMatchingObject = selectedFilters.objects.some(obj => 
                    cardObjects.includes(obj)
                );
                if (!hasMatchingObject) return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ü–≤–µ—Ç–∞–º
            if (selectedFilters.colors.length > 0) {
                const hasMatchingColor = selectedFilters.colors.some(color => 
                    cardColors.includes(color)
                );
                if (!hasMatchingColor) return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
            if (selectedFilters.materials.length > 0) {
                const hasMatchingMaterial = selectedFilters.materials.some(material => 
                    cardMaterials.includes(material)
                );
                if (!hasMatchingMaterial) return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∏–ª—è–º
            if (selectedFilters.styles.length > 0) {
                const hasMatchingStyle = selectedFilters.styles.some(style => 
                    cardStyles.includes(style)
                );
                if (!hasMatchingStyle) return false;
            }
            
            return true;
        }
        
        function hasActiveFilters() {
            return selectedFilters.categories.length > 0 || 
                   selectedFilters.objects.length > 0 || 
                   selectedFilters.colors.length > 0 || 
                   selectedFilters.materials.length > 0 || 
                   selectedFilters.styles.length > 0;
        }
        
        function clearAdvancedFilters() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            selectedFilters = {
                categories: [],
                objects: [],
                colors: [],
                materials: [],
                styles: []
            };
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.filter-option.selected').forEach(option => {
                option.classList.remove('selected');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            document.querySelectorAll('.image-card').forEach(card => {
                card.style.display = 'block';
            });
            
            showNotification('‚úÖ –§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
        }
        
        function showNotification(message, type = 'info') {
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            
            // –¶–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if (type === 'success') {
                notification.style.background = '#28a745';
            } else if (type === 'error') {
                notification.style.background = '#dc3545';
            } else {
                notification.style.background = '#17a2b8';
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
            document.body.appendChild(notification);
            
            // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
