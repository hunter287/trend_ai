# Perceptual Hash –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

## üéØ –ß—Ç–æ —ç—Ç–æ?

Perceptual Hash (pHash) ‚Äî —ç—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞–µ—Ç "–æ—Ç–ø–µ—á–∞—Ç–æ–∫" –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ. –ü–æ—Ö–æ–∂–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±—É–¥—É—Ç –∏–º–µ—Ç—å –ø–æ—Ö–æ–∂–∏–µ —Ö–µ—à–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏:
- –†–∞–∑–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
- –ù–µ–º–Ω–æ–≥–æ —Å–∂–∞—Ç—ã
- –ò–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
- –°–ª–µ–≥–∫–∞ –æ–±—Ä–µ–∑–∞–Ω—ã

## ‚ú® –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ö–µ—à–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
–ü—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º–∞:
- ‚úÖ –í—ã—á–∏—Å–ª—è–µ—Ç perceptual hash –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ—Ç –ª–∏ –ø–æ—Ö–æ–∂–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ë–î
- ‚úÖ –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ö–µ—à –≤ –ø–æ–ª–µ `image_hash` –≤ MongoDB

### 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø–æ—Ä–æ–≥ –ø–æ—Ö–æ–∂–µ—Å—Ç–∏
```python
# –í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è threshold = 5 (Hamming distance)
# 0 = —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
# 5 = –¥–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–±–æ–ª—å—à–∏–µ —Ä–∞–∑–ª–∏—á–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
# 10 = –±–æ–ª–µ–µ –º—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```

### 3. –ò–Ω–¥–µ–∫—Å –≤ MongoDB
–°–æ–∑–¥–∞–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–ª—è `image_hash`, —á—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

–ù–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
- `imagehash==4.3.1` - –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è perceptual hash
- `Pillow==10.1.0` - –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
- `tqdm==4.66.1` - –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ:

```python
from instagram_parser import InstagramParser

parser = InstagramParser(apify_token, mongodb_uri)
parser.connect_mongodb()

# –ü—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç—ã
parser.run_full_parsing("username", max_images=100)
```

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ë–î

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ö–µ—à–µ–π –∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º:

```bash
python add_perceptual_hash_to_existing.py
```

–°–∫—Ä–∏–ø—Ç:
1. –ù–∞–π–¥–µ—Ç –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–µ–∑ `image_hash`
2. –í—ã—á–∏—Å–ª–∏—Ç perceptual hash –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
3. –û–±–Ω–æ–≤–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ MongoDB
4. –°–æ–∑–¥–∞—Å—Ç –∏–Ω–¥–µ–∫—Å

## üìä –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã

```
üì• [1/10] –°–∫–∞—á–∏–≤–∞–Ω–∏–µ: post123_main_0001.jpg
üî¢ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ perceptual hash...
‚úÖ –°–∫–∞—á–∞–Ω–æ: post123_main_0001.jpg (152340 –±–∞–π—Ç)
   Hash: a1b2c3d4e5f6g7h8

üì• [2/10] –°–∫–∞—á–∏–≤–∞–Ω–∏–µ: post456_main_0002.jpg
üî¢ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ perceptual hash...
üîç –ù–∞–π–¥–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç! Hamming distance: 3
   –û—Ä–∏–≥–∏–Ω–∞–ª: post123
   –¢–µ–∫—É—â–∏–π: post456
‚è≠Ô∏è [2/10] –ù–∞–π–¥–µ–Ω –≤–∏–∑—É–∞–ª—å–Ω—ã–π –¥—É–±–ª–∏–∫–∞—Ç!
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–∞ –ø–æ—Ö–æ–∂–µ—Å—Ç–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `threshold` –≤ —Ñ–∞–π–ª–µ `instagram_parser.py`:

```python
# –í —Ñ—É–Ω–∫—Ü–∏–∏ download_images, —Å—Ç—Ä–æ–∫–∞ ~318
duplicate = self.is_duplicate_by_hash(image_hash, threshold=5)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- `threshold=0` - —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω—ã–µ –∫–æ–ø–∏–∏
- `threshold=5` - ‚úÖ **—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è** (–Ω–∞—Ö–æ–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏)
- `threshold=10` - –æ—á–µ–Ω—å –º—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –ø–æ—Ö–æ–∂–∏–µ, –Ω–æ —Ä–∞–∑–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

–ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—ã —É–≤–∏–¥–∏—Ç–µ:
```
‚úÖ –°–∫–∞—á–∞–Ω–æ 85 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ 15 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
```

–í MongoDB –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:
```javascript
{
  "_id": ObjectId("..."),
  "username": "blogger",
  "post_id": "C1a2B3c4D5e",
  "image_url": "https://...",
  "local_filename": "C1a2B3c4D5e_main_0001.jpg",
  "image_hash": "a1b2c3d4e5f6g7h8",  // ‚Üê Perceptual hash
  "file_size": 152340,
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
}
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫**: –î–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å `add_perceptual_hash_to_existing.py`

2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ perceptual hash –¥–æ–±–∞–≤–ª—è–µ—Ç ~0.1-0.3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

3. **–¢–æ—á–Ω–æ—Å—Ç—å**: 
   - ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
   - ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ Instagram
   - ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç —Å–ª–µ–≥–∫–∞ –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - ‚ùå –ù–µ –Ω–∞–π–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

4. **–•—Ä–∞–Ω–µ–Ω–∏–µ**: Hash –∑–∞–Ω–∏–º–∞–µ—Ç ~16 –±–∞–π—Ç –≤ MongoDB (—Å—Ç—Ä–æ–∫–∞ –∏–∑ 16 —Å–∏–º–≤–æ–ª–æ–≤)

## üêõ –û—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –≤—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã –≤ –ë–î:

```python
from pymongo import MongoClient
import imagehash

client = MongoClient("mongodb://...")
collection = client["instagram_gallery"]["images"]

# –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ö–µ—à–∏
hashes = {}
for doc in collection.find({"image_hash": {"$exists": True}}):
    hash_str = doc["image_hash"]
    if hash_str in hashes:
        print(f"–î—É–±–ª–∏–∫–∞—Ç –Ω–∞–π–¥–µ–Ω:")
        print(f"  –û—Ä–∏–≥–∏–Ω–∞–ª: {hashes[hash_str]['post_id']}")
        print(f"  –î—É–±–ª–∏–∫–∞—Ç: {doc['post_id']}")
    else:
        hashes[hash_str] = doc
```

## üìù Changelog

### v1.0 (—Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω perceptual hash (pHash) —Å hash_size=8
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏
- ‚úÖ –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø–æ—Ä–æ–≥ –ø–æ—Ö–æ–∂–µ—Å—Ç–∏ (threshold)
- ‚úÖ –ò–Ω–¥–µ–∫—Å –≤ MongoDB –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

